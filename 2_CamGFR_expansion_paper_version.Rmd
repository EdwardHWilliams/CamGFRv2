---
title: 'Supplement for: ...'
# author: "Edward H. Williams"
# date: "`r format(Sys.time(), '%B %d, %Y')`"
header-includes:
    \newcommand{\beginsupplement}{\setcounter{table}{0}  
    \renewcommand{\thetable}{S\arabic{table}} 
    \setcounter{figure}{0} 
    \renewcommand{\thefigure}{S\arabic{figure}}}
    \usepackage{breqn}
    \usepackage{biblatex}
output:
  pdf_document:
    # citation_package: natbib
    fig_caption: yes
    keep_tex: yes
    latex_engine: pdflatex
  word_document: default
  html_document:
    df_print: paged
affiliation: University of Cambridge
editor_options:
  chunk_output_type: console
endnote: no
fontfamily: mathpazo
fontsize: 11pt
geometry: margin=1in
keywords: Glomerular Filtration Rate, CamGFR, CKD-EPI, Carboplatin
bibliography: ref/Validation_1_References.bib
csl: ref/american-medical-association.csl
---

\beginsupplement

```{r load_environment, include=F, eval = T, echo = F}
if (file.exists('2_CamGFR_expansion.RData')) load('2_CamGFR_expansion.RData')
```


```{r file_setup, include=F}
# fig_export_dir = "/Users/willia01/Google Drive/PhD/GFR_validation_2/Refitted_CamGFR_paper/Figures_and_tables_resubmission"
# fig_export_dir = "/Users/willia01/Documents/Projects/GFR/Published_Git/GFR_model_extension/temp/"
fig_export_dir = "temp"

knitr::opts_chunk$set(warning=F,
                      echo = F,
                      cache = T)
```

```{r load_librarys_and_Rfiles, include = F, cache=F}
library(knitr)
library(kableExtra)
# library(forcats)
library(broom)
# library(boot)
library(segmented)
# library(readxl)
library(tidyverse)
# library(xlsx)
library(patchwork)
library(openxlsx)
library(corrplot)
library(GGally)
library(ggpubr)
library(jtools)
library(gtable)
library(cowplot)
library(grid)
library(ggpubr)
library(scales)
library(ggsignif)
library(googlesheets)
library(broom.mixed)
library(reshape2)
library(multcomp)

# Load the data and helper function
source("Clean_data.R")
source("ggplot_functions.R")
source("Functions_for_stat_tables.R")
source("Bootstrap_CI_functions.R")


```


# Data filtering

<!-- Raw data that were received from the three different centres located at
Cambridge, Manchester and Gothenburg. The non-IDMS patients used in the study
have been used in previous publications. The IDMS patients  -->
Data were individually processed and cleaned prior to being used for analysis.
This step involved exploring the data for manual transcription errors such as
the height and weight variable being swapped and removing unrealistic values for
some variables. During this process all data were converted to have the same
units to enable data pooling and analysis across the different centres and
sub-group categories.
Next, patients with data outside the inclusion criteria were removed.  With
regard to creatinine, we excluded readings below 18 umol/L or above 400 umol/L.
These values were chosen as the lower value is the typical detection threshold
on the measurement assay and the upper value is 3-4 times the upper limit of
'normal' in most centres, thus corresponding to a value at which most clinicians
would consider kidney function severely impaired.


```{r seting_up_datsets, eval = T, cache = F, include = F}
not_all_na <- function(x) !all(is.na(x))

# All data that is used at somepoint in this analysis
Expansion_data <- All_data %>%
  # remove centres where 
  filter(Centre %in% c("Adden_old", "Adden_new", "Manchester", "Goteborg")) %>% 
  mutate(BSA = SufA) %>%
  mutate(BMI = Wt/(Ht/100)^2) %>%
  filter(Age >= 18) %>% # removing any patients under 18 years old
  group_by(PatientID) %>% 
  mutate(Date_GFR_diff = c(NA, diff(Date_GFR))) %>%
  ungroup() %>%
  # centres do not report creatinine values lower than this value
  filter(Ht > 130) %>% 
  mutate(Centre2 = Centre) %>%
  mutate(Centre2 = factor(Centre2,
                          labels = c("Cambridge original", "Cambridge new", 
                                     "Manchester", "Gothenburg"),
                          levels = c("Adden_old", "Adden_new", "Manchester", 
                                     "Goteborg"))) %>%  
  mutate(Centre = fct_collapse(Centre2, "Cambridge" = 
                                 c("Cambridge original","Cambridge new"))) %>%
  mutate(Centre = as.character(Centre), 
         Centre2 = as.character(Centre2)) %>%
  mutate(Ethnicity_black = ifelse(is.na(Ethnicity), 0, Ethnicity == "Black")) %>%
  mutate(Ethnicity = 
           ifelse(Ethnicity %in% c("(Not on file)", "Not Stated", "Unknown"),
                  NA, Ethnicity)) %>%
  mutate(Diagnosis = ifelse(Diagnosis == "Seminoma", "GCT", Diagnosis)) %>%
  mutate(Ethnicity = ifelse(Ethnicity == "Mixed/Other", "Other", Ethnicity)) %>%
  # mutate(Creat_method = factor(Centre,
  # levels = c("Cambridge", "Gothenburg", "Manchester"), 
  #                              labels = c("Jaffe", "enzymatic", "Jaffe"))) %>%
  mutate(Creatinine_methods = interaction(Creatinine_method,
                                          Creatinine_type, sep = " ")) %>%
  mutate(Diagnosis = ifelse(Diagnosis == "Seminoma", "GCT", Diagnosis)) %>%
  # mutate(Patient_type = ifelse(Patient_type %in% c("Donor", "Misc"), "Non-cancer",
  #                              Patient_type)) %>% 
  # mutate(Patient_type = ifelse(Diagnosis == "Non-cancer", "Non-cancer", Patient_type)) %>%
  mutate(Diagnosis = ifelse(Diagnosis == "Non-cancer", "Unknown", Diagnosis)) %>%
  select_if(.predicate = not_all_na)

# Filter extreme creatinine values
Expansion_data <- Expansion_data %>%
  # remove creatinine values less than 18 as some 
  filter(Creat*88.4 > 18) %>%
  filter(Creat*88.4 < 400) 

# Filter repeat measurements
Expansion_data <- Expansion_data %>%
  #   filter(GFR_index == 1) %>% # keeping only a patients first GFR measurement
  filter(Date_GFR_diff > 365 | is.na(Date_GFR_diff))
nrow(Expansion_data)

RNGkind(sample.kind = "Rounding")
set.seed(1)
# Data that will be used later to refit CamGFR, randomly split into validation 
# and development datasets
Expansion_data <- Expansion_data %>%
  mutate(fit_index = !(1:n() %in% sample(1:n(), n()/5))) # randomly allocate 1/5 
# data to validation and rest to fitting

Expansion_data <- Expansion_data %>%
  mutate(sqrt_GFR = sqrt(GFR)) %>%
  mutate(log_Creat_IDMS = log(Creat)*(Creatinine_type == "IDMS"), 
         log_Creat_nonIDMS = log(Creat)*(Creatinine_type == "Non_IDMS")) %>%
  mutate(log_Creat = log(Creat)) 

Expansion_data_fit <- Expansion_data %>%
  filter(fit_index == 1) %>%
  mutate(Creatinine_type = factor(Creatinine_type, levels = c("Non_IDMS", "IDMS")))

# correcting paient_type 
Expansion_data <- Expansion_data %>%
  mutate(Patient_type = ifelse(Patient_type == "Unknown", "Non-Cancer",
                               Patient_type))

```


# Data discription
The data used in this manuscript are summaries in Tables \ref{tab:summary_centr}
and \ref{tab:summary_categorical}.

```{r Patient_numbers_by_centre, cache = T, echo = F, warning=F}
Samples_per_centre_all <- Expansion_data %>%
  group_by(Centre) %>%
  summarise("Total samples" = n(),
            "Total patients" = n_distinct(PatientID),
             "Female" = sum(Sex == "F"),
            "IDMS creatinine" = sum(Creatinine_type == "IDMS"),
            "Enzymatic creatinine" = sum(Creatinine_method == "Enzymatic"),
            "Solid tumour" = sum(Patient_type == "Cancer"),
            "Hematology" = sum(Patient_type == "Haem"),
            "Non-cancer" = sum(!Patient_type %in% c("Haem", "Cancer"))
            # "Repeat patients" = sum(GFR_index > 1)
            ) %>%
            #"Race - Black" = sum(Ethnicity == "Black", na.rm = T)) %>%
  rbind(c("Total", sum(.$`Total samples`),
          sum(.$`Total patients`),
          sum(.$Female),
          sum(.$`IDMS creatinine`),
          sum(.$`Enzymatic creatinine`), 
          sum(.$`Solid tumour`),
          sum(.$Hematology),
          sum(.$`Non-cancer`)
          # sum(.$`Repeat patients`)
          )
          #sum(.$`Race - Black`))
        )
Samples_per_centre_all
write_excel_csv(Samples_per_centre_all,
                file = file.path(fig_export_dir, "Table_S1_rough.csv"))
```


```{r Patient_numbers_by_ethnicity, cache = T, echo = F, warning=F}
Samples_by_ethnicity <- Expansion_data %>%
  dplyr::select(Creatinine_type, Ethnicity) %>%
  table() %>% 
  as.data.frame() %>%
  mutate(Creatinine_type = ifelse(Creatinine_type == "Non_IDMS", "non-IDMS", "IDMS")) %>%
  pivot_wider(values_from = Freq, names_from = Ethnicity)
Samples_by_ethnicity
write_excel_csv(Samples_by_ethnicity,
                file = file.path(fig_export_dir, "Table_S2_rough.csv"))
```


```{r Patient_numbers_by_diagnosis, cache = T, echo = F, warning=F}
Diagnosis_summary <- Expansion_data %>%
  group_by(Diagnosis) %>%
  summarise(`Number of samples` = n(), `Number of patients` = length(unique(PatientID))) %>%
  arrange(-`Number of samples`)
Diagnosis_summary
write_excel_csv(Samples_by_ethnicity,
                file = file.path(fig_export_dir, "Table_S3_rough.csv"))

```


```{r Patient_numbers_by_repeats, cache = T, echo = F, warning=F}
Repeat_GFR_summary <- Expansion_data %>%
  group_by(PatientID) %>%
  summarise(n = n()) %>%
  pull(n) %>% 
  table() %>% 
  as.data.frame() %>% 
  pivot_wider(values_from = "Freq", names_from = ".")
Repeat_GFR_summary
write_excel_csv(Repeat_GFR_summary,
                file = file.path(fig_export_dir, "Table_S4_rough.csv"))

```

```{r new_summary table, echo = F, warning=F}

Summary_variables_by_centre <- Expansion_data %>%
  filter(Centre != "Gothenburg") %>%
  dplyr::select("GFR [ml/min]" = GFR,
         "Creatinine [mg/dL]" = Creat,
         "Age [years]" = Age,
         "Height [cm]" = Ht,
         "Weight [kg]" = Wt, 
         "BSA [m\u00B2]" = BSA, 
         Creatinine_type, Centre) %>%
  gather(key = variable, value = value, -Centre, -Creatinine_type) %>%
  group_by(Centre, variable, Creatinine_type) %>%
  summarise(value = list(value)) %>%
  spread(Creatinine_type, value) %>%
  mutate(Median.IDMS = median(unlist(IDMS)),
         IQR.IDMS = IQR(unlist(IDMS)),
         "Median.Non-IDMS" = median(unlist(Non_IDMS)),
         "IQR.Non-IDMS" = IQR(unlist(Non_IDMS)), 
         "p-value" = wilcox.test(unlist(IDMS), unlist(Non_IDMS))$p.value) %>%
  dplyr::select(-IDMS, -Non_IDMS) %>%
  bind_rows(.) %>%
  mutate_if(is.numeric, signif, 3)


Summary_variables_by_centre = Summary_variables_by_centre %>% 
  ungroup() #%>%
  # mutate(`Adj p-value` = p.adjust(`p-value`, method = "bonferroni"))

write_excel_csv(Summary_variables_by_centre,
                path = file.path(fig_export_dir, "Table1_rough.csv"))

```


Data summary tables are not the best way to display and summarises data, often
it can be more beneficial to show data with the aid of a plot. In Figure
\ref{fig:centre_boxplot} we produce a boxplot for each of the continuous
variables for each centre separately. In addition, we give p-values for a
pairwise t-test between the centres. For this we observe that there are general
differences between the patients from the three different centres. Patients from
Cambridge and Gothenburg appear to be more closely matched to each other then to
patients from Manchester, where the patients are on average slightly older with
a lower GFR.

```{r PLOT_data_characteristics_1, echo = F, fig.width=9, fig.height=7, fig.cap="\\label{fig:centre_boxplot}Boxplot of the continuous variables split by Centre. Creatinine has been log transfomed and split into IDMS and non-IDMS. P-values are shown for t-test for the difference in the mean between centres for each variable."}
my_comparisons <- list( c("Cambridge", "Gothenburg"),
                        c("Manchester", "Gothenburg") )

Boxplots_variables <- Expansion_data %>% 
  bind_rows(data.frame(Centre = "Gothenburg",
                       Creat = rep(NA, 100),
                       Creatinine_type = "Non_IDMS")) %>%
  mutate(Centre = factor(Centre,
                         levels = c("Cambridge", "Manchester", "Gothenburg"))) %>%
  filter(Creatinine_type %in% c("IDMS", "Non_IDMS")) %>%
  mutate(Creat_IDMS = ifelse(Creatinine_type == "IDMS", Creat, NA)) %>%
  mutate(Creat = ifelse(Creatinine_type == "IDMS", NA, Creat)) %>%
  mutate("non-IDMS log(SCr)" = log(Creat)) %>%
  mutate("IDMS log(SCr)" = log(Creat_IDMS)) %>%
  dplyr::select("GFR" = GFR, "non-IDMS log(SCr)", 
         "IDMS log(SCr)", Age, 
         Ht, Wt, "BSA" = BSA, Centre) %>% 
  gather(key = variable, value = value, -Centre) %>%
  filter(!is.na(value)) %>%
  mutate(variable = factor(variable,
                           levels = c("GFR",  "IDMS log(SCr)",
                                      "non-IDMS log(SCr)", "Age", 
                                      "BSA", "Ht", "Wt"), 
                           labels = c("GFR [ml/min]",  "IDMS log(SCr)",
                                      "non-IDMS log(SCr)", "Age [years]", 
                                      "BSA [m\u00B2]", "Height [cm]",
                                      "Weight [kg]"))) %>%
  ggplot(aes(y = value, x = Centre, fill = Centre)) + 
  geom_boxplot(position = "dodge", width = .9) + 
  facet_wrap(~variable, scale = "free_y", nrow = 2) +
  ggplot_theme() + 
  theme(axis.title = element_blank(), 
        axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(), 
        axis.line.x = element_blank(),
        legend.position = c(7/8, 1/4), 
        legend.justification = c(.5, .5)) +
  scale_fill_manual(values = tol3qualitative) +
  # stat_compare_means(method = "t.test", label = "p.signif",
  # ref.group = "Cambridge") + 
  stat_compare_means(comparisons = list(c("Cambridge", "Manchester"), 
                                        c("Cambridge", "Gothenburg"), 
                                        c("Manchester", "Gothenburg")),
                     method = "t.test") +
  stat_compare_means(comparisons = list(c("Cambridge", "Manchester")), 
                     method = "t.test") 
Boxplots_variables
```

In Figure \ref{fig:diagnosis_boxplot} we again display the data using boxplots
but this time split patients by their diagnosis. Here we observe a far larger
differences between the groups, which is expected given that certain diagnosis
will be enriched wich sertain patients. For example, patients with germ cell
tumours (GCT) or sarcoma patients tend to be younger and hence would have a
higher GFR and a lower creatinine, which is what we seen in the data.

```{r PLOT_data_characteristics_2, echo=F, fig.width=9, fig.height=7, fig.cap = "\\label{fig:diagnosis_boxplot}Boxplot of the continuous variables split by disease diagnosis. Boxplots are ordered by number the number of patients, with the diagnosis with the most patients on the left. Creatinine has been log transfomed and split into IDMS and non-IDMS. Only diagnosis with more than 50 patients were included."}
tol12qualitative <- c("#332288", "#6699CC", "#88CCEE", "#44AA99", "#117733",
                      "#999933", "#DDCC77", "#661100", "#CC6677", "#AA4466",
                      "#882255", "#AA4499")

diagnosis <- c("Gynae", "Hematologic", "GCT", "Thoracic", 
               "Gastroeosophageal", "Head and Neck", "Bladder/TCC", 
               "Sarcoma", "Endometrial", "Transplant", 
               "Uterus/Cervix", "Breast", "Kidney donor", "Melanoma")

Boxplots_diagnosis <- Expansion_data %>% 
  filter(Creatinine_type %in% c("IDMS", "Non_IDMS")) %>%
  mutate(Creat_IDMS = ifelse(Creatinine_type == "IDMS", 
                             Creat, NA)) %>%
  mutate(Creat = ifelse(Creatinine_type == "IDMS", 
                        NA, Creat)) %>%
  mutate("non-IDMS log(SCr)" = log(Creat)) %>%
  mutate("IDMS log(SCr)" = log(Creat_IDMS)) %>%
  dplyr::select("GFR" = GFR, "non-IDMS log(SCr)", 
         "IDMS log(SCr)", Age, 
         Ht, Wt, "BSA" = BSA, Diagnosis) %>% 
  filter(Diagnosis %in% diagnosis) %>%
  mutate(Diagnosis = factor(Diagnosis, 
                            levels = diagnosis)) %>%
  gather(key = variable, value = value, -Diagnosis) %>%
  filter(!is.na(value)) %>%
  mutate(variable = factor(variable,
                           levels = c("GFR",  "IDMS log(SCr)",
                                      "non-IDMS log(SCr)", "Age", 
                                      "BSA", "Ht", "Wt"), 
                           labels = c("GFR [ml/min]",  "IDMS log(SCr)",
                                      "non-IDMS log(SCr)", "Age [years]", 
                                      "BSA [m\u00B2]", "Height [cm]",
                                      "Weight [kg]"))) %>%
  ggplot(aes(y = value, x = Diagnosis, fill = Diagnosis)) + 
  geom_boxplot(position = "dodge", width = .9) + 
  facet_wrap(~variable, scale = "free_y", nrow = 2) + 
  ggplot_theme() + 
  scale_fill_manual(values =  c(tol12qualitative, "grey50", "white")) +
  theme(axis.title = element_blank(), 
        axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(), 
        axis.line.x = element_blank(),
        legend.position = c(7/8, 1/4), 
        legend.justification = c(.5, .5)) 
Boxplots_diagnosis
```


```{r export_data_summary_figs, eval = F, include = F}
ggsave(filename= "Comparison_three_dataset_variables.pdf",
       path = file.path(fig_export_dir, "Possible_supplement"),
       plot = Boxplots_variables, width = 12, height = 9)
```


```{r checking_patient_numbers, eval = F, include=F}
# Non-cancer numbers
Non_cancer = Expansion_data %>% 
  filter(Patient_type %in% c("Non-Cancer", "Unknown")) 
Non_cancer %>% pull(Patient_type) %>% table()
Non_cancer %>% pull(PatientID) %>% unique() %>% length()

Expansion_data %>% 
  filter(!(Patient_type %in% c("Non-Cancer", "Unknown"))) %>%
  filter(PatientID %in% (Non_cancer %>% pull(PatientID) %>% unique())) %>% pull(PatientID)
  
# Gothenburg non-cancer
All_data %>% 
  filter(Centre == "Goteborg") %>%
  filter(Diagnosis == "Non-cancer") %>% pull(PatientID) -> Gothenburg_nonCancer
Expansion_data %>%
  filter(PatientID %in% Gothenburg_nonCancer) %>%
  pull(Diagnosis_full)
Expansion_data %>% 
  filter(Centre == "Gothenburg", 
         Diagnosis == "Unknown")
```

## Ethnical data
For a subsection of the patient population (specifically the majority of
patients from Manchester and the majority of new patients from Addenbrookes) we
had information on ethnicity. From a total of `r nrow(filter(Expansion_data,
!is.na(Ethnicity)))` patients with known ethnicity, `r
nrow(filter(Expansion_data, Ethnicity == "White"))` were White (either White
British, White Irish, White other), `r nrow(filter(Expansion_data, Ethnicity ==
"Asian"))` were Asian (Asian Indian, Asian Pakistani, Asian Bangladeshi, Asian
other, Chinese Other Chinese, Mixed White and Asian), `r
nrow(filter(Expansion_data, Ethnicity == "Black"))` were Black (Black African,
Black Caribbean, Black other, Mixed White and Black Caribbean, Mixed White and
Black African) and `r nrow(filter(Expansion_data, Ethnicity == "Other"))` were
of mixed ethnicity (other ethnic group, other mixed). Figure
\ref{fig:boxplot_ethnicity} shows boxplots for age, BSA, mGFR and log(SCr) for
patients from the ethnic subgroups. t-tests for difference in the mean were
performed comparing the largest subgroup of white patients to all other ethnic
subgroups. There were no significant differences in the serum creatinine levels
for patients from different ethnicity.

```{r PLOT_Ethnicity_boxplot, echo=F, fig.width=9, message = F, warning=F, fig.height=7, fig.cap="\\label{fig:boxplot_ethnicity}Boxplots of age, BSA, GFR and log(SCr), IDMS log(SCr) and Age where patients are split by ethnicity. The '\\*' or 'ns' at the top of the boxplot represents the p-value from a t-test between the largest subgroup of white patients and each other ethnic subgroups, where 'ns' represents a p-value greater than 0.05 and '\\*', '\\*\\*' and '\\*\\*\\*' represent p-values less than 0.05, 0.01 and 0.001 respectively."}

tol4qualitative=c("#4477AA", "#117733", "#DDCC77", "#CC6677")
Boxplots_ethnicity <- Expansion_data %>%
  filter(!is.na(Ethnicity)) %>%
  mutate(log_Creat = log(Creat)) %>%
  mutate(log_Creat_IDMS = ifelse(Creatinine_type == "IDMS", 
                                 log_Creat, NA)) %>%
  mutate(log_Creat = ifelse(Creatinine_type == "IDMS", 
                            NA, log_Creat)) %>% 
  dplyr::select(Age, GFR, BSA, log_Creat, log_Creat_IDMS, Centre, Ethnicity) %>%
  gather(key = variable, value = value, -Centre, -Ethnicity) %>%
  mutate(variable = factor(variable,
                           levels = c("GFR", "log_Creat_IDMS", "log_Creat", 
                                      "Age", "BSA"),
                           labels = c("GFR [ml/min]",  "IDMS log(SCr)",
                                      "non-IDMS log(SCr)", "Age [years]", 
                                      "BSA [m\u00B2]"))) %>%
  ggplot(aes(y = value, fill = Ethnicity, x = Ethnicity)) +
  geom_boxplot(position = "dodge", width = 1, notch = F, outlier.shape = NA) +
  geom_jitter(aes(alpha = Ethnicity), width = .3) +
  scale_alpha_manual(values = c(.5,.5,.5,.05)) +
  ggplot_theme() +
  facet_wrap(~variable, scales = "free_y", ncol =3 ) +
  # theme(legend.position = "none",
  #       axis.title.y = element_blank(),
  #       axis.text.x=element_text(angle=45, hjust=1)) +
  scale_fill_manual(values = tol4qualitative) +
  stat_compare_means(method = "t.test", label = "p.signif", ref.group = "White") + 
  theme(axis.title = element_blank(), 
        axis.text.x = element_blank(), 
        axis.ticks.x = element_blank(), 
        axis.line.x = element_blank(),
        legend.position = c(5/6, 1/4), 
        legend.justification = c(.5, .5)) 
Boxplots_ethnicity

ggsave(file.path(fig_export_dir, "Boxplot_ethnicity.pdf"),
       plot = Boxplots_ethnicity, 
       width = 12, height = 9)
```

# Comparison of Creatinine methods
We next aimed to compare IDMS creatinine values to non-IDMS creatinine values in
more detail to assess whether our model would need to be adjusted in order to be
suitable for IDMS creatinine measurements.
Isotope dilution mass spectrometry (IDMS) refers to the creatinine measurement
being calibrated to be traceable to an IDMS reference measurement procedure.
This standardisation was introduced by the NKDEP's Laboratory Working Group in
collaboration with the International Federation of Clinical Chemistry and
Laboratory Medicine and the European Communities Confederation of Clinical
Chemistry (now called the European Federation of Clinical Chemistry and
Laboratory Medicine) with the aim of reducing inter-laboratory variation in
creatinine measurements. This reduced the variation and bias in the creatinine
based estimation of GFR. This standardisation has been widely introduced across
the US and in recent years many UK centres have introduced it. For example, the
two UK centres for which we have IDMS creatinine measurements, Cambridge and
Manchester, it was introduced on 01/03/2016 and 08/06/2016 respectively. The
other centre in our study with IDMS creatinine measurement is Gothenburg, which
only has IDMS creatinine with the earliest measurement from 02/01/2008.
We have already seen some comparison between IDMS and non-IDMS creatinine in
Figure \ref{fig:boxplot_centre_1}, here Figures \ref{fig:boxplot_creat_1} and
\ref{fig:boxplot_creat_w} show a more detailed comparison between the two
patient groups. Figure \ref{fig:boxplot_creat_1} shows boxplots for each
continuous variable (log(cratinine), GFR, age, BSA, height and weight) where
patients have been split into IDMS and non-IDMS groups. Here we see there is a
significant difference in the mean creatinine value between IDMS and non-IDMS
patients from both Cambridge and Manchester. We also observe a difference in the
mean GFR value for both centres and in the mean age and height values for
patients from Cambridge. However, the difference in the non-creatinine variables
is much smaller and doesnt explain the large difference seen in the creatinine
variable.

Figure \ref{fig:boxplot_creat_2} shows the difference in the creatinine
values when patients are split into diagnosis subgroups. This is produced as
patients with the same diagnosis should be more matched then patients in the
general population. For the 5 diagnosis shown the difference between IDMS and
non-IDMS patients is significant.


```{r prepare data for paper creatinine figure}
Creatinine_data_multi <- Adden_long_combined %>% 
  filter(Patient_type != "Non-cancer") %>%
  filter(Creat*88.4 > 18) %>% # remove creatinien values less than 18 as some 
  filter(Creat*88.4 < 400)

give.n <- function(x){
  return(c(y = median(x)+0.04, label = length(x))) 
  # experiment with the multiplier to find the perfect position
}

df_mixed <- Expansion_data %>% 
  filter(Creatinine_method != "Unknown") %>%
  mutate(log_Creat = log(Creat)) %>%
  mutate(Creatinine_type = factor(Creatinine_type,
                                  levels = c("IDMS", "Non_IDMS"), 
                                  labels = c("IDMS", "Non-IDMS"))) %>%
  mutate(x = interaction(Creatinine_type, Creatinine_method, sep = " "),
         xcopy = x ) %>%
  filter(GFR_index == 1)

summary_centre <- df_mixed %>%
   group_by(x, Centre) %>%
   summarise(Scr_median = median(Creat))
write_csv(summary_centre,
          file.path(fig_export_dir, "Median_Scr_per_center.csv"))

summary_method <- df_mixed %>%
   group_by(Creatinine_type, Centre) %>%
   summarise(Scr_median = median(Creat))
write_csv(summary_method,
          file.path(fig_export_dir, "Median_Scr_per_method.csv"))
```

## Creatinine measures over time at Cambridge and Manchester

```{r, common functions}
# Select samples from same patient with at least 30 days apart
keep_at_least_dist = function(dists, dist=30) {
  keep = rep(FALSE, length(dists))
  for (i in 1:length(dists)) {
    if (i == 1) {
      keep[i] = TRUE
      current_dist = 0
    } else {
      current_dist = current_dist + dists[i]
      if (current_dist >= dist) {
        keep[i] = TRUE
        current_dist = 0
      }
    }
  }
  return(keep)
}

stat_convert <- function(compare_means_output, cutoff=0.0001) {
  compare_means_output %>%
    mutate(p.label = case_when(p < cutoff ~ paste("<", sprintf("%.4f", cutoff)),
                               TRUE ~ sprintf("%.4f", p))
    )
}
```

```{r plot settings}
title_size <- 10
text_size <- 8
label_size <- 3
stripplacement <- "outside"

ylim <- c(0.22,9.6)
ybreaks <- c(0.3, 0.6, 1.2, 2.4, 4.8, 9.6)

showlegends <- FALSE
xpos_p <- 2.4

centre_colors <- c(Cambridge = "#5b4e9f", Gothenburg = "#117733",
                   Manchester = "#CC6677")
method_colors_all <- c("IDMS Enzymatic"="#e6ab02", "IDMS Jaffe"="#d95f02",
                   "Non-IDMS Jaffe"="#666666")

method_colors <- c("IDMS"="#fdae61", "Non-IDMS"="#666666")
```

```{r creatinine measures over time and method}
data_cam <- Creatinine_data_multi %>%
  filter(!is.na(Date_creat)) %>%
  mutate(Creatinine_type = factor(Creatinine_type,
                                  levels = c("IDMS", "Non_IDMS"), 
                                  labels = c("IDMS", "Non-IDMS"))) %>%
  mutate(x = interaction(Creatinine_type, Creatinine_method, sep = " ")) %>%
  mutate(log_Creat = log(Creat)) %>%
  group_by(PatientID) %>%
  arrange(PatientID, Date_creat) %>%
  mutate(Date_diff_creat_2 = as.numeric(Date_creat - Date_creat[1])) %>%
  mutate(Date_diff_creat = c(0, diff(Date_creat))) %>%
  mutate(keep = keep_at_least_dist(Date_diff_creat, 30)) %>%
  mutate(town="Cambridge") %>%
  filter(keep)

data_manchester <- Expansion_data %>%
  filter(Centre == "Manchester") %>%
  mutate(Creatinine_type = factor(Creatinine_type,
                                  levels = c("IDMS", "Non_IDMS"), 
                                  labels = c("IDMS", "Non-IDMS"))) %>%
  mutate(x = interaction(Creatinine_type, Creatinine_method, sep = " "))
```

```{r timeline for Cambridge with 3 different measurment methods}
cambridge_stat_3methods <- compare_means(Creat ~ x,
                                    data_cam,
                                    method="t.test") %>%
  stat_convert
p_cambridge_distribution_3methods <- ggplot() + 
  geom_density(data=data_cam, aes(y=Creat, color=x))  +
  scale_y_continuous(breaks = ybreaks, trans = "log10",
                     limits = ylim) +
  scale_color_manual(values = method_colors_all) + 
  labs(y = "SCr",
       color="Method") +
  ggplot_theme() +
  theme(axis.text = element_text(size=text_size),
        axis.title = element_text(size=title_size),
        strip.placement = stripplacement,
        legend.position = "bottom")

p_cambridge_3methods_timeline <- ggplot(data=data_cam,
                               aes(y = (Creat), x = Date_creat)) + 
  geom_point(color= "#5b4e9f", alpha = 0.1, stroke = 0) + 
  facet_wrap(town ~., strip.position = "left") +
  geom_smooth(aes(group = x), colour = "white", method = "gam",
              size = rel(2),
              formula = y ~ s(x, bs = "cs", k=5)) +
  geom_smooth(aes(group = x, color = x), method = "gam",
              size = rel(1),
              formula = y ~ s(x, bs = "cs", k=5),
              show.legend = FALSE) +
  scale_color_manual(values = method_colors_all) + 
  geom_vline(xintercept = as.Date(c("2013-12-12", "2016-03-01")),
             linetype = "dashed") +
  scale_y_continuous(breaks = ybreaks,
                     trans = "log10",
                     limits = ylim) +
  scale_x_date(breaks = pretty_breaks(6), expand = c(0, 0)) + 
  labs(x="Date",
       y="SCr") + 
  ggplot_theme() +
  theme(axis.text = element_text(size=text_size),
        axis.title = element_text(size=title_size),
        strip.placement = stripplacement,
        strip.background = element_rect(fill="white", color="white"),
        strip.text =  element_text(color="white")
        )

cambridge_stat_3methods_tbl <- tableGrob(cambridge_stat_3methods[,c(2:3,9)],
                                         rows=NULL)

legend_method <- cowplot::get_legend(p_cambridge_distribution_3methods)
figure_tmp <- ggdraw(p_cambridge_distribution_3methods +
                       theme(legend.position = "none")) +
  draw_plot(cambridge_stat_3methods_tbl, 0.35, .6, .5, .5, scale=.1)

figure_row <- plot_grid(p_cambridge_3methods_timeline, 
          figure_tmp)

p_cambridge_3methods <- plot_grid(figure_row, legend_method, nrow=2,
          rel_heights=c(8,1))

ggsave(plot=p_cambridge_3methods,
       filename = "Creatinine_cambridge_timeline_supplement.pdf", 
       path = fig_export_dir,
       width = 30, height = 10,  units = "cm")
```

## IDMS by method (enzymatic and jaffe) and non-IDMS
```{r, eval=T}
jaffe_idms_vs_jaffe_nonidms <-  df_mixed %>%
  filter(x %in% c("IDMS Jaffe", "Non-IDMS Jaffe")) %>%
  mutate(method = "IDMS Jaffe",
         other = "Non-IDMS Jaffe")
jaffe_idms_vs_jaffe_nonidms_stat <- compare_means(Creat ~ x,
                                                  jaffe_idms_vs_jaffe_nonidms,
                                                  method="t.test") %>%
  stat_convert
  
p_jaffe_idms_vs_jaffe_nonidms <- ggplot() + 
  geom_violin(data=jaffe_idms_vs_jaffe_nonidms,
              aes(y = x, x = Creat, fill=x),
              position = "dodge", width = 0.9, show.legend = showlegends,
              draw_quantiles=0.5, color="white"
              ) + 
  geom_text(aes(label=paste("p", jaffe_idms_vs_jaffe_nonidms_stat$p.label),
                x=xpos_p, y=1.5), size=label_size, hjust="left") +
  facet_grid(method ~ other, switch="y") +
  scale_x_continuous(breaks= ybreaks,
                     trans = "log10",
                     limits = ylim) +
  scale_fill_manual(values=method_colors_all) +
  labs(fill = "Method",
       x="SCr") +
  ggplot_theme() +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size=text_size),
        axis.title = element_text(size=title_size),
        strip.placement = stripplacement,
        strip.background = element_rect(fill="white", color="white"),
        strip.text =  element_text(color="white")
        )

jaffe_vs_enzymatic <-  df_mixed %>%
  filter(x %in% c("IDMS Jaffe", "IDMS Enzymatic")) %>%
  mutate(method = "IDMS Jaffe",
         other = "IDMS Enzymatic",)
jaffe_vs_enzymatic_stat <- compare_means(Creat ~ x,
                                         jaffe_vs_enzymatic,
                                         method="t.test") %>%
  stat_convert
p_jaffe_vs_enzymatic <- ggplot() + 
  geom_violin(data=jaffe_vs_enzymatic,
              aes(y = x, x = Creat, fill=x),
              position = "dodge", width = 0.9, show.legend = showlegends,
              draw_quantiles=0.5, color="white"
              ) +
  geom_text(aes(label=paste("p =", jaffe_vs_enzymatic_stat$p.label),
                x=xpos_p, y=1.5), size=label_size, hjust="left") +
  scale_x_continuous(breaks= ybreaks,
                     trans = "log10",
                     limits = ylim) +
  scale_fill_manual(values = method_colors_all) +
  facet_grid(method ~ other, switch="y") +
  labs(fill = "Method",
       y = "Method") +
  ggplot_theme() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text = element_text(size=text_size),
        strip.placement = stripplacement,
        strip.background.x = element_rect(fill="white", color="white"),
        strip.text.x = element_text(color="white")
        )

enzymatic_idms_vs_jaffe_nonidms <-  df_mixed %>%
  filter(x %in% c("IDMS Enzymatic", "Non-IDMS Jaffe")) %>%
  mutate(method = "Non-IDMS Jaffe",
         other="IDMS Enzymatic")
enzymatic_idms_vs_jaffe_nonidms_stat <-
  compare_means(Creat ~ x,
                enzymatic_idms_vs_jaffe_nonidms,
                method="t.test")  %>%
  stat_convert

p_enzymatic_idms_vs_jaffe_nonidms <- ggplot() + 
  geom_violin(data=enzymatic_idms_vs_jaffe_nonidms,
              aes(y = x, x = Creat, fill=x),
              position = "dodge", width = 0.9, show.legend = showlegends,
              draw_quantiles=0.5, color="white"
              ) + 
  geom_text(aes(label=paste("p", enzymatic_idms_vs_jaffe_nonidms_stat$p.label),
                x=xpos_p, y=1.5), size=label_size, hjust="left") +
  scale_x_continuous(breaks= ybreaks,
                     trans = "log10",
                     limits = ylim) +
  scale_fill_manual(values=method_colors_all) +
  facet_grid(method ~ other, switch="y") +
  labs(fill = "Method",
       x = "SCr",
       y = "Method") +
  ggplot_theme() +
  theme(legend.position = "bottom",
        axis.text = element_text(size=text_size),
        axis.title.y = element_blank(),
        axis.title = element_text(size=title_size),
        strip.placement = stripplacement,
        strip.background.x = element_rect(fill="white", color="white"),
        strip.text.x = element_text(color="white")
        )

idms_jaffe <-  df_mixed %>%
  filter(x=="IDMS Jaffe")
idms_jaffe_stat <- compare_means(Creat ~ Centre,
                                 idms_jaffe,
                                 method="t.test") %>%
  stat_convert
p_idms_jaffe_distribution <- ggplot() + 
  geom_density(data=idms_jaffe,
               aes(x= Creat, color=Centre),show.legend = showlegends) +
  geom_text(aes(label=paste("p =", idms_jaffe_stat$p.label),
                x=xpos_p, y=1), size=label_size, hjust="left") +
  scale_x_continuous(breaks= ybreaks,
                     trans = "log10",
                     limits = ylim) +
  scale_color_manual(values = centre_colors)  + 
  facet_wrap(. ~ x) + 
  ggplot_theme() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text = element_text(size=text_size),
        strip.placement = stripplacement)

idms_enzymatic <-  df_mixed %>%
  filter(x=="IDMS Enzymatic") %>%
  mutate(xcopy = x)
idms_enzymatic_stat <- compare_means(Creat ~ Centre,
                                     idms_enzymatic ,
                                     method="t.test") %>%
  stat_convert

p_idms_enzymatic_distribution <- ggplot() + 
  geom_density(data=idms_enzymatic,
               aes(x= Creat, color=Centre),show.legend = showlegends) +
  geom_text(aes(label=paste("p =", idms_enzymatic_stat$p.label),
                x=xpos_p, y=1), size=label_size, hjust="left") +
  scale_x_continuous(breaks= ybreaks,
                     trans = "log10",
                     limits = ylim) +
  scale_color_manual(values = centre_colors)  + 
  facet_grid(xcopy ~ x, switch="y") +
  ggplot_theme() +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text = element_text(size=text_size),
        strip.placement = stripplacement)

nonidms_jaffe <-  df_mixed %>%
  filter(x=="Non-IDMS Jaffe")
nonidms_jaffe_stat <- compare_means(Creat ~ Centre,
                                    nonidms_jaffe,
                                    method="t.test")  %>%
  stat_convert

p_nonidms_jaffe_distribution <- ggplot() + 
  geom_density(data=nonidms_jaffe, aes(x= Creat, color=Centre),
               show.legend = showlegends)  +
  geom_text(aes(label=paste("p =", nonidms_jaffe_stat$p.label),
                x=1.6, y=1), size=label_size, hjust="left") +
  scale_x_continuous(breaks= ybreaks,
                     trans = "log10",
                     limits = ylim) +
  scale_color_manual(values = centre_colors) + 
  facet_wrap(. ~ x) +
  labs(x = "SCr") +
  ggplot_theme() +
  theme(axis.text = element_text(size=text_size),
        axis.title = element_text(size=title_size),
        strip.placement = stripplacement)

p_legends <- ggplot(data=df_mixed,
                    aes(y = x, x = Creat, fill=x, color=Centre)) + 
  geom_violin(position = "dodge", width = 0.9) + 
  scale_fill_manual(values=method_colors_all) +
  scale_color_manual(values=centre_colors) +
  labs(fill = "Method",
       color="Centre",
       x = "SCr",
       y="") +
  ggplot_theme() +
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        legend.box="vertical",
        legend.text = element_text(size=text_size),
        legend.title = element_text(size=title_size),
        legend.box.just = "left") + 
  guides(color = guide_legend(override.aes = list(size = 2),
                              keywidth = 0.5,keyheight = 0.5,),
         fill = guide_legend(override.aes = list(size = 0.1),
                             keywidth = 0.5,keyheight = 0.5,
         ))

plot_legend <- cowplot::get_legend(p_legends)

layout <- "
aa#gg#
bbcc##
ddeeff
"
pairwise_all <- wrap_plots(a = p_idms_enzymatic_distribution,
                    b = p_jaffe_vs_enzymatic,
                    c = p_idms_jaffe_distribution,
                    d = p_enzymatic_idms_vs_jaffe_nonidms,
                    e = p_jaffe_idms_vs_jaffe_nonidms,
                    f = p_nonidms_jaffe_distribution,
                    g = plot_legend,
                    design = layout) &
  theme(plot.margin = unit(c(0,0,0.1,0.1), "cm"))

ggsave(plot=pairwise_all,
       filename = "Creatinine_comparison_all_supplement.pdf", 
       path = fig_export_dir,
       width = 25, height = 20,  units = "cm")
```

## Comparison centers with IDMS and non-IDMs measurements
```{r timeline for Cambridge and Manchester with 2 different measurment methods}
p_cambridge_2methods_timeline <- ggplot(data=data_cam,
                               aes(y = (Creat), x = Date_creat)) + 
  geom_point(colour = "#5b4e9f", alpha = 0.1, stroke = 0) + 
  geom_smooth(aes(group = Creatinine_type), colour = "white", method = "gam",
              size = rel(2),
              formula = y ~ s(x, bs = "cs", k=5)) +
  geom_smooth(aes(group = Creatinine_type, color = Creatinine_type),
              method = "gam",
              size = rel(1),
              formula = y ~ s(x, bs = "cs", k=5),
              show.legend = FALSE) +
  geom_vline(xintercept = as.Date(c("2013-12-12")),
             linetype = "dashed") +
  scale_y_continuous(breaks= ybreaks, trans = "log10",
                     limits = ylim) +
  scale_color_manual(values = method_colors) + 
  scale_x_date(breaks = pretty_breaks(6), expand = c(0, 0)) + 
  xlab("Date") +
  ylab("SCr") + 
  ggplot_theme() +
  theme(axis.text = element_text(size=text_size),
        axis.title = element_text(size=title_size),
        plot.margin = unit(c(0.5,0,0.1,0), "cm")
        )

cambridge_stat_2methods <- compare_means(Creat ~ Creatinine_type,
                                         data_cam,
                                         method="t.test") %>%
  stat_convert

p_cambridge_distribution_2methods <- ggplot() + 
  geom_density(data=data_cam, aes(y=Creat, color=Creatinine_type))  +
  geom_text(aes(label=paste("p", cambridge_stat_2methods$p.label),
                x=1.8, y=1.5), size=label_size, hjust="left") +
  scale_y_continuous(breaks= ybreaks, trans = "log10",
                     limits = ylim) +
  scale_x_continuous(limits =c(0,5)) +
  scale_color_manual(values = method_colors) + 
  labs(y = "SCr",
       color="Method") +
  ggplot_theme() +
  theme(axis.text.x = element_text(size=text_size),
        axis.title.x = element_text(size=title_size),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        plot.margin = unit(c(0.5,0,0.1,-0.2), "cm"),
        legend.position = "bottom")

p_manchester_timeline <- ggplot(data=data_manchester,
                                aes(y = (Creat), x = Date_creat)) +
  geom_point(color="#CC6677", alpha = 0.1, stroke = 0) +
  geom_smooth(
    aes(group = Creatinine_type),
    colour = "white",
    method = "gam",
    size = rel(2),
    formula = y ~ s(x, bs = "cs", k = 5)
  ) +
  geom_smooth(
    aes(group = Creatinine_type, color=Creatinine_type),
    method = "gam",
    size = rel(1),
    formula = y ~ s(x, bs = "cs", k = 5),
    show.legend = FALSE
  ) +
  geom_vline(xintercept = as.Date("2016-06-08"), linetype = "dashed") +
  scale_color_manual(values = method_colors) + 
  scale_x_date(breaks = pretty_breaks(4), expand = c(0, 0)) +
  scale_y_continuous(
    breaks = ybreaks,
    trans = "log10",
    limits = ylim
  ) +
  xlab("Date") +
  ylab("SCr") +
  ggplot_theme() +
  theme(axis.text = element_text(size=text_size),
        axis.title = element_text(size=title_size),
        plot.margin = unit(c(0.5,0,0.1,0), "cm")
  )

manchester_stat <- compare_means(Creat ~ Creatinine_type,
                                 data_manchester,
                                 method="t.test") %>%
  stat_convert
p_manchester_distribution <- ggplot() + 
  geom_density(data=data_manchester,
               aes(y=Creat, color=Creatinine_type))  +
  geom_text(aes(label=paste("p", manchester_stat$p.label),
                x=1.8, y=1.5), size=label_size, hjust="left") +
  scale_y_continuous(breaks= ybreaks, trans = "log10",
                     limits = ylim) +
  scale_x_continuous(limits =c(0,5)) +
  scale_color_manual(values = method_colors) + 
  labs(y = "SCr",
       color="Method") +
  ggplot_theme() +
  theme(axis.text.x = element_text(size=text_size),
        axis.title.x = element_text(size=title_size),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        plot.margin = unit(c(0.5,0,0.1,-0.2), "cm"),
        legend.position = "bottom")
```

## Simple comparison IDMS to non-IDMS
```{r, eval=T}
idms <-  df_mixed %>%
  filter(Creatinine_type == "IDMS") 

idms_stat <- compare_means(Creat ~ Centre, idms, method="t.test") %>%
  stat_convert %>%
  arrange(group2)
p_idms <- ggplot() + 
  geom_violin(data=idms,
              aes(x = Centre, y = Creat, fill=Centre),
              position = "dodge", width = 0.9,
              draw_quantiles=0.5, color=method_colors[1], alpha=0.8,
              show.legend = FALSE
              ) + 
  geom_bracket(data = idms_stat, 
    aes(xmin = group1, xmax = group2, label = p.label),
    y.position =  c(log10(5),log10(5.8), log10(7.8)),
    label.size=label_size, 
    tip.length = 0.01
    ) + 
  stat_summary(data = idms, 
               aes(x = Centre, y = Creat),
               fun.data = give.n, geom = "text", 
               position = position_dodge(width = 0.9), 
               size = label_size, colour = "white") + 
  scale_y_continuous(breaks= ybreaks,
                     trans = "log10",
                     limits = ylim
                     ) +
  scale_fill_manual(values=centre_colors) +
  labs(fill = "Centre",
       y="SCr",
       x="Centre") +
  ggplot_theme() +
  theme(axis.text = element_text(size=text_size),
        axis.title = element_text(size=title_size),
        plot.margin = unit(c(0.5,0,0.1,0.1), "cm"),
        legend.position = "bottom"
        ) 

nonidms <-  df_mixed %>%
  filter(Creatinine_type == "Non-IDMS") 

nonidms_stat <- compare_means(Creat ~ Centre, nonidms, method="t.test") %>%
  stat_convert
p_nonidms <- ggplot() + 
  geom_violin(data=nonidms,
       aes(x = Centre, y = Creat, fill = Centre),
       position = "dodge", width = 0.9, show.legend = showlegends,
              draw_quantiles=0.5,
       color=method_colors[2],
       alpha=0.8
       ) + 
  geom_bracket(data = nonidms_stat, 
    aes(xmin = group1, xmax = group2, label = p.label),
    y.position = log10(4.8),
    step.increase = 0.1,
    label.size=label_size,
    tip.length = 0.01,
    ) + 
  stat_summary(data = nonidms, 
               aes(x = Centre, y = Creat),
               fun.data = give.n,
               geom = "text", 
               position = position_dodge(width = 0.9), 
               size = label_size,
               colour = "white") + 
  scale_y_continuous(breaks= ybreaks,
                     trans = "log10",
                     limits = ylim 
                     ) +
  scale_fill_manual(values=centre_colors) +
  labs(fill = "Centre",
       y="SCr",
       x="Centre") +
  ggplot_theme() +
  theme(axis.text = element_text(size=text_size),
        axis.title = element_text(size=title_size),
        plot.margin = unit(c(0.5,0,0.1,0.1), "cm")
        )

p_legends <- ggplot(data=df_mixed,
                    aes(y = x, x = Creat, fill=Centre, color=Creatinine_type)) + 
  geom_violin(position = "dodge", width = 0.9) + 
  scale_color_manual(values=method_colors) +
  scale_fill_manual(values=centre_colors) +
  labs(color = "Method",
       fill="Centre",
       x = "SCr",
       y="") +
  ggplot_theme() +
  theme(legend.position = "bottom",
        legend.direction = "horizontal",
        legend.box="horizontal",
        legend.text = element_text(size=text_size),
        legend.title = element_text(size=title_size),
        legend.box.just = "left") + 
  guides(color = guide_legend(override.aes = list(size = 2),
                              keywidth = 0.5,keyheight = 0.5,),
         fill = guide_legend(override.aes = list(size = 0.1),
                             keywidth = 0.5,keyheight = 0.5,
         ) )
plot_legend <- cowplot::get_legend(p_legends)

upper_row <- plot_grid(p_idms, 
          p_cambridge_2methods_timeline,
          p_cambridge_distribution_2methods + theme(legend.position = "none"),
          ncol=3,
          rel_widths = c(2, 2.5, 0.7),
          labels = c("A", "C", "")
)

lower_row <- plot_grid(p_nonidms, 
          p_manchester_timeline,
          p_manchester_distribution + theme(legend.position = "none"),
          ncol=3,
          rel_widths = c(2, 2.5, 0.7),
          labels = c("B", "D", "")
)

main_creatinine <- plot_grid(upper_row, lower_row,plot_legend, nrow=3,
          rel_heights = c(3, 3, 1))
ggsave(filename = "Creatinine_comparison.pdf", 
       plot = main_creatinine, 
       path = fig_export_dir,
       width = 18, height = 14,  units = "cm")
```

```{r additional_ttests, eval=F, echo=F}
# Cambridge non-IDMS IDMS comparison
Expansion_data %>%
  filter(GFR_index == 1) %>%
  dplyr::selectCreat, Centre, Creatinine_type) %>%
  filter(Centre == "Cambridge") %>%
  t.test(Creat ~ Creatinine_type, data = .)
Expansion_data %>%
  filter(GFR_index == 1) %>%
  dplyr::selectCreat, Centre, Creatinine_type) %>%
  filter(Centre == "Cambridge") %>%
  group_by(Creatinine_type) %>%
  summarise(m = mean(Creat)) %>%
  mutate(p_diff = (m[2] - m[1])/m[2])


# Manchester non-IDMS IDMS comparison
Expansion_data %>%
  filter(GFR_index == 1) %>%
  dplyr::selectCreat, Centre, Creatinine_type) %>%
  filter(Centre == "Manchester") %>%
  t.test(Creat ~ Creatinine_type, data = .)
Expansion_data %>%
  filter(GFR_index == 1) %>%
  dplyr::selectCreat, Centre, Creatinine_type) %>%
  filter(Centre == "Manchester") %>%
  group_by(Creatinine_type) %>%
  summarise(m = mean(Creat)) %>%
  mutate(p_diff = (m[2] - m[1])/m[2])

# Cambridge Manchester comparison Non-IDMS
Expansion_data %>%
  filter(GFR_index == 1) %>%
  dplyr::selectCreat, Centre, Creatinine_type, Creatinine_method) %>%
  filter(Creatinine_type == "Non_IDMS", Centre != "Gothenburg") %>%
  t.test(Creat ~ Centre, data = .)

# Cambridge Manchester comparison IDMS
Expansion_data %>%
  filter(GFR_index == 1) %>%
  dplyr::selectCreat, Centre, Creatinine_type, Creatinine_method) %>%
  filter(Creatinine_type == "IDMS", Centre != "Gothenburg") %>%
  t.test(Creat ~ Centre, data = .)

# Cambridge Gothenburg comparison IDMS
Expansion_data %>%
  filter(GFR_index == 1) %>%
  dplyr::selectCreat, Centre, Creatinine_type, Creatinine_method) %>%
  filter(Creatinine_type == "IDMS", Centre != "Manchester") %>%
  t.test(Creat ~ Centre, data = .)


# Manchester Gothenburg comparison IDMS
Expansion_data %>%
  filter(GFR_index == 1) %>%
  dplyr::selectCreat, Centre, Creatinine_type, Creatinine_method) %>%
  filter(Creatinine_type == "IDMS", Centre != "Cambridge") %>%
  t.test(Creat ~ Centre, data = .)

# Cambridge Manchester comparison IDMS Jaffe
Expansion_data %>%
  filter(GFR_index == 1) %>%
  dplyr::selectCreat, Centre, Creatinine_type, Creatinine_method) %>%
  filter(Creatinine_type == "IDMS", Creatinine_method == "Jaffe") %>%
  t.test(Creat ~ Centre, data = .)


# Jaffe Enzymatic comparison Cambridge
Expansion_data %>%
  filter(GFR_index == 1) %>%
  filter(Creatinine_type == "IDMS", Centre == "Cambridge") %>%
  group_by(Creatinine_method) %>%
  summarise(mean(Creat))

Expansion_data %>%
  filter(GFR_index == 1) %>%
  dplyr::selectCreat, Centre, Creatinine_type, Creatinine_method) %>%
  filter(Creatinine_type == "IDMS", Centre == "Cambridge") %>%
  t.test((Creat) ~ Creatinine_method, data = .)


# Jaffe Enzymatic comparison IDMS only
df_mixed %>%
  filter(GFR_index == 1) %>%
  dplyr::selectCreat, Centre, Creatinine_type, Creatinine_method) %>%
  filter(Creatinine_type == "IDMS") %>%
  t.test(log(Creat) ~ Creatinine_method, data = .)
# p-value = 1.557e-05


# Cambridge Gothenburg comparison IDMS Enzymatic
Expansion_data %>%
  dplyr::selectCreat, Centre, Creatinine_type, Creatinine_method) %>%
  filter(Creatinine_type == "IDMS", Creatinine_method == "Enzymatic") %>%
  t.test((Creat) ~ Centre, data = .)
# p-value = 0.03308


# Cambridge Manchester comparison IDMS Jaffe
Expansion_data %>%
  dplyr::selectCreat, Centre, Creatinine_type, Creatinine_method) %>%
  filter(Creatinine_type == "IDMS", Creatinine_method == "Jaffe") %>%
  t.test(log(Creat) ~ Centre, data = .)
# p-value = 0.3694

# Cambridge Manchester comparison Non-IDMS Jaffe
Expansion_data %>%
  dplyr::selectCreat, Centre, Creatinine_type, Creatinine_method) %>%
  filter(Creatinine_type == "Non_IDMS", Creatinine_method == "Jaffe") %>%
  t.test(log(Creat) ~ Centre, data = .)
# p-value = 1.215e-09



# IDMS Non-IDMS comparison Manchester Jaffe
Expansion_data %>%
  dplyr::selectCreat, Centre, Creatinine_type, Creatinine_method) %>%
  filter(Centre == "Manchester") %>%
  t.test(Creat ~ Creatinine_type, data = .)
# p-value = 4.42e-12


# IDMS Non-IDMS comparison Cambridge Jaffe
Expansion_data %>%
  dplyr::selectCreat, Centre, Creatinine_type, Creatinine_method) %>%
  filter(Centre == "Cambridge", Creatinine_method == "Jaffe") %>%
  t.test(Creat ~ Creatinine_type, data = .)
# p-value < 2.2e-16


# IDMS Non-IDMS comparison Jaffe
Expansion_data %>%
  dplyr::selectCreat, Centre, Creatinine_type, Creatinine_method) %>%
  filter(Creatinine_method == "Jaffe") %>%
  t.test(Creat ~ Creatinine_type, data = .)
# p-value < 2.2e-16

# Enzymatic Jaffe Addem
Expansion_data %>%
  dplyr::selectCreat, Centre, Creatinine_type, Creatinine_method) %>%
  filter(Creatinine_type == "IDMS", Centre == "Cambridge") %>%
  t.test(Creat ~ Creatinine_method, data = .)
# p-value < 2.2e-16



```




# Expanding CamGFR
Give the above results we can be sure that IDMS creatinine is different enough
from non-IDMS creatinine that we would need to adjust or produce a new model for
IDMS creatinine data. In the published model both the MDRD and the CKD-EPI
models are reportedly suitable for use with IDMS creatinine data. The MDRD was
originally developed using non-IDMS creatinine data and was the retrospectively
adjusted to be suitable for IDMS data, where the multiplicative coefficient
changes from 175 to 186. For the CKD-EPI model, this was produced using IDMS
data, hence it should only truly be used with IDMS data and not non-IDMS data.
However, surprisingly we have not noticed any bias in using it with non-IDMS
data (which one might expect if one of the input variables is 15-20% different
from expected) and in fact it is constantly second best to the CamGFR model in
all our previous validation work.
The primary aim of this study was to produce a model that would be suitable for
both IDMS and non-IDMS creatinine data. For this we used all patients for our
three centres, both patients with IDMS creatinine measurements and non-IDMS
creatinine measurements. Also used all patients would allow us to more accurate
estimate for the non-creatinine coefficients.
We approached adjusting the CamGFR model in two ways. Firstly, our original
approach was to simply refit the coefficients in the CamGFR model, with an
interaction term between all creatinine coefficients and the creatinine type
(IDMS or non-IDMS). This can also be viewed as producing two separate models for
the different creatinine types, which have the same coefficients for the
non-creatinine terms. We will refer to this model as the refitted CamGFR model.
Our other approach was to redo the model fitting procedure and develop a single
or multiple new models that would be suitable for both creatinine types. This
approach is likely to produce at the very least a slightly different model which
may or may not be better than the model in from our original approach. Hence, at
the end of the analysis the models would be compared and a new model would only
be chosen if it was significantly better than the refitted CamGFR.
We chose only to use the centres where we had at least some IDMS data
(Cambridge, Manchester and Gothenburg), this was done to avoid the complications
in differences between non-IMDS creatinine measurements between centres. Hence,
there were `r nrow(Expansion_data)` patients of which `r
nrow(filter(Expansion_data, Creatinine_type =="IDMS"))` had IDMS patients. These
data were subsequently split into a development and validation dataset at a
ratio of 4:1.

## Development set and validation set description

```{r Comparison_development_vs_validation, results='hide'}
source("Functions_for_group_comparison.R")

vars.all <- c("GFR", "Age", "Creat", "Ht", "Wt", "SufA", "Sex", "Centre", "Patient_type",
              "Number_GFR", "GFR_index", "Creatinine_type", "Creatinine_method","Radiopharm",
              "BSA", "BMI", "fit_index")
marker.units.all <- vars.all

dat.work <- data.frame(Expansion_data)[,vars.all]
dat.work$fit_index <- factor(dat.work$fit_index, levels = c("TRUE", "FALSE"), labels = c("Development", "Validation"))
vars.all.cat <- c(0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 
                  1, 1, 1, 1, 0, 0, 1)

var.y<-"fit_index"
var.y.lab <- var.y
header <- "\n"
vars.rm <- c("fit_index")
id.rm <- match(vars.rm, vars.all)
vars <- vars.all[-id.rm]
vars.cat <- vars.all.cat[-id.rm]
vars.univar <- vars.all[-id.rm]
vars.univar.cat <- vars.all.cat[-id.rm]
marker.units <- marker.units.all[-id.rm]

assign("out1.name", fsmry.dmgrph(dat = dat.work, 
                                 vars = vars, vars.cat = vars.cat, by = "fit_index", all = T, IQR = T))
colnames(out1.name[[1]])[c(3,4)] <- c(paste0("Development (n=", as.vector(table(dat.work$fit_index)[1]), ")"),
                                      paste0("Validation (n=", as.vector(table(dat.work$fit_index)[2]), ")"))
```

```{r Comparison_development_vs_validation_result, results = "asis"}
print(knitr::kable(get("out1.name")[[1]] %>% tibble::remove_rownames()))
```


## Refitted CamGFR


```{r refit_model_with_IDMSinteraction, eval = T, include = F}
# Expansion_data_fit 

model_formula_interaction <-
  sqrt_GFR ~ Age + BSA + Sex + Creatinine_type:log_Creat +
  Creatinine_type:I(log_Creat^2) + Creatinine_type:I(log_Creat^3) +
  Age:BSA + Age:Sex + Creatinine_type 
Refit_CamGFR <- lm(model_formula_interaction,
                   data = Expansion_data_fit)
summary(Refit_CamGFR)

```


As discused above, our naive approach was to refit the CamGFR model with an
interaction variable between the creatinine variables and the creatinine type.
Hence, the model has the following from:
\begin{dmath*} \sqrt{GFR} = \beta_0 + \beta_1Age + \beta_2BSA + \beta_3Sex_M +
\beta_4Scr_{IDMS} + \beta_5\log(Scr)Scr_{IDMS} +  \beta_6\log(Scr)^2Scr_{IDMS} +
\beta_7\log(Scr)^3Scr_{IDMS} + \beta_8\log(Scr)Scr_{Non-IDMS} +
\beta_9\log(Scr)^2Scr_{Non-IDMS} + \beta_{10}\log(Scr)^3Scr_{Non-IDMS} +
\beta_{11}Age BSA +   \beta_{12}Age Sex_M \end{dmath*} where: \begin{itemize}
\item $\beta_i$ for $i = 0,\dots,12$ are the fitted coefficients \item $BSA$ is
the patient's body surface area \item $Sex_M$ is a dummy variable equaling $1$
if the patient's sex is male and 0 if female \item $Scr_{IDMS}$ is a dummy
variable equaling $1$ if the creatinine measurement is IDMS traceable and 0 if
it is not \item $Scr$ is the patient's serum creatinine measurement
\end{itemize}
The estimated coefficients are shown in Table S... from fitting the model using
our model development dataset. Some of these coefficients, particularly
$\beta_i$ where $i = 0,1,2,3,5,6,7,11,12$, are comparable with the coefficients
from the original CamGFR model. Hence, Table \ref{tab:coef_comparison} displays
the original coefficients along with a Z-statistic and p-value for the
hypothesis test conducted for the difference between the new and original
coefficients
\cite{https://stats.stackexchange.com/questions/93540/testing-equality-of-coefficients-from-two-different-regressions}.
Of the 9 comparable coefficients, only 1 was significantly different (p-value
below 0.05). This indicates ...

```{r compare_coefficients, eval = T, echo = F}
# Table of old and new coefficient for the CamGFR model
Old_param = summary(Addenbrooks_sqrt_model)$coef[,1:2] 
colnames(Old_param) = c("Original", "Original se")
rownames(Old_param)[c(3,4,6,7,9)] <- c("Creatinine_typeNon_IDMS:log_Creat", 
                                       "BSA",
                                       "Creatinine_typeNon_IDMS:I(log_Creat^3)",
                                       "Creatinine_typeNon_IDMS:I(log_Creat^2)", 
                                       "Age:BSA")
Old_param = Old_param %>% 
  as.data.frame() %>% rownames_to_column("Coefficient")
New_param = summary(Refit_CamGFR)$coef[,1:2] %>% as.data.frame()
colnames(New_param) = c("New", "New se")
New_param = New_param %>% 
  as.data.frame() %>% rownames_to_column("Coefficient")

coefficient_table <- left_join(New_param, Old_param, by = "Coefficient") %>%
  mutate("Z-statistic" = (New - Original)/sqrt(`New se`^2 + `Original se`^2)) %>%
  mutate("p-value" =  2*dnorm(-abs(`Z-statistic`)))

coefficient_table <- coefficient_table %>%
  mutate(Coefficient = c("$\\beta_0$", "$\\beta_1$", "$\\beta_2$", "$\\beta_3$", 
                         "$\\beta_4$", "$\\beta_8$",  "$\\beta_5$", "$\\beta_9$", 
                         "$\\beta_6$", "$\\beta_{10}$", "$\\beta_7$", 
                         "$\\beta_{11}$", "$\\beta_{12}$")) %>%
  arrange(c(0, 1, 2, 3, 4, 8, 5, 9, 6, 10, 7, 11, 12)) 


write_csv(coefficient_table %>% 
            mutate_if(is.numeric, signif, 3), 
          file.path(fig_export_dir, "Table2_rought.csv"))

kable(coefficient_table, caption = "\\label{tab:coef_comparison}Coeffient comparision of original CamGFR coeffiecents and the newly refitted CamGFR coefficents", 
      format = "latex", escape = FALSE, digits=3)
```

Additionally, in Table \ref{tab:summary_refitted} we show the summary
information for the refitted CamGFR model which includes a p-value for
indicating whether the coefficient is significantly different from zero. All
coefficients are significantly different from zero, indicating that none are
unnecessary.

```{r summary_refitted_model, echo = F}
summary(Refit_CamGFR)$coef %>%
  as.data.frame() %>%
  rownames_to_column(var = "Variable") %>%
  mutate(Coefficient = c("$\\beta_0$", "$\\beta_1$", "$\\beta_2$", "$\\beta_3$", 
                         "$\\beta_4$", "$\\beta_8$",  "$\\beta_5$", "$\\beta_9$", 
                         "$\\beta_6$", "$\\beta_{10}$", "$\\beta_7$", 
                         "$\\beta_{11}$", "$\\beta_{12}$")) %>%
  arrange(c(0, 1, 2, 3, 4, 8, 5, 9, 6, 10, 7, 11, 12)) %>% 
  dplyr::selectVariable, Coefficient, everything()) %>%
  mutate(Variable = c("$(Intercept)$", "$Age$", "$BSA$", "$Sex_M$", "$Scr_{IDMS}$",
                      "$log(Scr)Scr_{IDMS}$", "$log(Scr)^2Scr_{IDMS}$", 
                      "$log(Scr)^3Scr_{IDMS}$", "$log(Scr)Scr_{Non-IDMS}$",
                      "$log(Scr)^2Scr_{Non-IDMS}$", "$log(Scr)^3Scr_{Non-IDMS}$",
                      "$Age BSA$", "$Age Sex_M$")) %>%
  kable(caption = "\\label{tab:summary_refitted}Summary of the reffited CamGFR model",
        digits=3, format = "latex", escape = FALSE)
```


Another, way to check a models fit is to look at summary plots for the model.
Figure S... shows the residual (on the square root scale) plotted against the
three main contentious variables along with the fitted values. When a model fits
the data well these plots should show no patterns, conversely when there is a
pattern this may indicate that the model has not captured certain structures in
the data. In Figure \ref{fig:resid_reffited} we see no major patterns other than
perhaps some small bias to overestimate (negative residual) GFR for patients who
are particularly young (less than 30 years old).

```{r summary_fplots_for_refit_model, echo = F, message = F, warning=F, fig.width=9, fig.height=6, fig.cap="\\label{fig:resid_reffited}Need to caption"}
tol2qualitative=c("#4477AA", "#CC6677")

p1 <- Expansion_data_fit %>%
  mutate(Creatinine_type = factor(Creatinine_type,
                                  levels = c("IDMS", "Non_IDMS"), 
                                  labels = c("IDMS", "non-IDMS"))) %>%
  mutate(fitted = Refit_CamGFR$fitted.values) %>%
  mutate(resid = Refit_CamGFR$residuals) %>%
  mutate(log_Creat = log(Creat)) %>%
  dplyr::selectresid, fitted, Age, log_Creat, BSA, Centre, Creatinine_type) %>%
  gather(key = variable, value = value, -resid, -Centre, -Creatinine_type) %>%
  mutate(variable = factor(variable,
                           levels = c("Age", "fitted", "log_Creat", "BSA"), 
                           labels = c("Age", "Fitted values", "log(SCr)", "BSA"))) %>%
  ggplot(aes(x = value, y = resid)) + 
  geom_hline(yintercept = 0) + 
  geom_point(aes(shape = Centre, colour = Creatinine_type), alpha = .5) +
  facet_wrap(~variable, scales = "free_x", nrow = 2, drop = F,
             strip.position = "bottom") + 
  geom_smooth(colour = "black") +
  ggplot_theme() + 
  theme(
    axis.title.x = element_blank(), 
    strip.background = element_blank(), 
    text = element_text(size = 12), 
    strip.text = element_text(size = rel(1)), 
    strip.placement = "outside", 
    plot.margin = margin(6, 8, 2, 2, "mm")) + 
  scale_color_manual(values =  tol2qualitative, name = "Creatinine type" ) + 
  ylab("Model residual")
p1

# ggsave(file.path(fig_export_dir, "Refit_CmGFR_fit_plot.pdf"), plot = p1, 
#        width = 12, height = 9)

p2 <- Expansion_data_fit %>%
  mutate(Creatinine_type = factor(Creatinine_type,
                                  levels = c("IDMS", "Non_IDMS"), 
                                  labels = c("IDMS", "non-IDMS"))) %>%
  mutate(fitted = Refit_CamGFR$fitted.values) %>%
  mutate(resid = Refit_CamGFR$residuals) %>%
  ggplot(aes(sample = sqrt(GFR))) + 
  stat_qq(alpha = 0.2) + stat_qq_line() + 
  ylab(expression(sqrt("GFR"))) + 
  xlab("Therotical quaniles") +
  ggplot_theme() +
  theme(plot.margin = margin(4, 8, 2, 2, "mm"))

Expansion_data_fit %>%
  mutate(fitted = Refit_CamGFR$fitted.values) %>%
  mutate(resid = Refit_CamGFR$residuals) -> dat
p3 <- dat %>% 
  ggplot(aes(x = resid)) + 
  geom_histogram(aes(y =..density..), bins = 50, fill = "grey80",
                 colour = "black") + 
  stat_function(fun = dnorm,
                args = list(mean = mean(dat$resid),sd = sd(dat$resid))) + 
  xlab("Model residuals") +
  ggplot_theme() + 
  theme(plot.margin = margin(4, 8, 2, 2, "mm"))



left_plot <- plot_grid(p2, p3, labels = c("A", "B"), align = "v",
                       rel_heights = c(1,1), ncol = 1)
resid_figure <- plot_grid(left_plot, p1, labels = c("", "C"),
                          rel_widths = c(1, 2))

ggsave(filename = "S_model_fitting.pdf", 
       plot = resid_figure, 
       path = fig_export_dir,
       width = 35, height = 20,  units = "cm")



```

Finally, we examine the fitted relationship between the log of the serum
creatinine and the square root of GFR. Figure \ref{fig:cubic_fit} shows the
three fitted cubic curves: the original CamGFR, the refitted for Non-IDMS data
and the refitted for IDMS data. Here we see, as expected, the original curve and
the refitted curve for non-IDMS patients match well. The refitted curve for IDMS
patients is shifted to the right, which is what we might expect given our
observations for the two creatinine types discussed above.

```{r PLOT_of_cubic_creat_fit_refit_model, echo = F, fig.width=6, fig.height=4, fig.cap="\\label{fig:cubic_fit}Effect of log(SCr) on the fitted value of GFR for the original CamGFR, refitted CamGFR with IDMS cratinine and the refitted CamGFR with non-IDMS creatinine."}
creat_func <- function(x, creat_type){ 
  coef =  Refit_CamGFR$coefficients
  if(creat_type == "IDMS") 
    coef[1] + coef[6]*x + coef[8]*x^2 + coef[10]*x^3
  else
    coef[1] + coef[5] + coef[7]*x + coef[9]*x^2 + coef[11]*x^3
}
creat_func_original <- function(x){ 
  coef =  coef(Addenbrooks_sqrt_model)
  coef[1] +coef[3]*x + coef[7]*x^2 + coef[6]*x^3
}

seq_func = function(range){
  seq(from = range[1], to = range[2], length.out = 1000)
}

x1 = filter(Expansion_data_fit, Creatinine_type == "Non_IDMS") %>%
  pull(log_Creat) %>%
  range() %>%
  seq_func()
x2 = filter(Expansion_data_fit, Creatinine_type == "IDMS") %>%
  pull(log_Creat) %>%
  range() %>%
  seq_func()
SFigure4_cubic_Creat_fit <- data.frame(x1 = x1, x2 = x2) %>%
  ggplot() +
  geom_line(aes(x=x1, y=creat_func(x1, "Non_IDMS"), colour = "Non_IDMS")) +
  geom_line(aes(x=x2, y= creat_func(x1, "IDMS"), colour = "IDMS")) +
  geom_line(aes(x=x1, y = creat_func_original(x1), colour = "Original CamGFR")) +
  ggplot_theme() + 
  ylab("Effect of log(SCr)") + xlab("log(SCr)")
SFigure4_cubic_Creat_fit

# ggsave(file.path(fig_export_dir, "Cubic_polynomial_fit.pdf"),
#        plot = SFigure4_cubic_Creat_fit, 
#        width = 12, height = 9)

```

Finally, we compare the results of estimating GFR using the original and
refitted CamGFR models on the non-IDMS data in the validation data set (n = `r
Expansion_data %>% filter(fit_index == 0, Creatinine_type == "Non_IDMS") %>%
nrow()`). This is done both graphically and by comparing model perfomance
statistics. Graphically, we used an MA plot (a plot of the average of the two
estimates on the x axis and the difference of the two estimates on the y axis)
to compare the two estimates. In Figure \ref{fig:MAplot_refit} we observe that
original CamGFR tends to predict higher values than the refitted GamGFR for
small values of GFR and the opposite is true for larger values.

```{r PLOT_CamGFR_original_refitted_comparison, echo = F, message = F, warning=F, fig.width=5, fig.height=4, fig.cap="\\label{fig:MAplot_refit}MA-plot for the original CamGFR and the Refitted CamGFR models estimated values"}

Original_refitted_MAplot <-  Expansion_data %>%
  filter(fit_index == 0) %>%
  filter(Creatinine_type == "Non_IDMS") %>%
  mutate(log_Creat = log(Creat)) %>%
  mutate(Original = predict(Addenbrooks_sqrt_model, newdata = .)^2) %>%
  mutate(Refitted = predict(Refit_CamGFR, newdata = .)^2) %>%
  dplyr::selectGFR, Original, Refitted) %>%
  # ggplot(aes(x = GFR - Original, y = GFR - Refitted))
  ggplot(aes(x = Original/2 + Refitted/2, y = Original - Refitted)) +
  geom_hline(yintercept = 0) + 
  geom_point() + 
  ggplot_theme() 
Original_refitted_MAplot

# ggsave(file.path(fig_export_dir, "Origial_Refit_CamGFR_MAplot.pdf"), 
#        plot = Original_refitted_MAplot, 
#        width = 12, height = 9)


```

```{r, CamGFR_original_refitted_comparison_table, echo = F}
Fitted_df <- Expansion_data %>%
  filter(fit_index == 1) %>%
  # filter(Creatinine_type == "Non_IDMS") %>%
  mutate(log_Creat = log(Creat)) %>%
  mutate(Original = predict(Addenbrooks_sqrt_model, newdata = .)^2) %>%
  mutate(Refitted = predict(Refit_CamGFR, newdata = .)^2) %>%
  dplyr::selectGFR, Original, Refitted, Centre, Creatinine_type) %>% 
  gather(key = equation, value = fitted, -GFR, -Centre, -Creatinine_type) %>%
  mutate(resid = GFR - fitted) %>%
  bind_rows(mutate(., Centre = "All"))


Fitted_df %>% group_by(equation, Creatinine_type, Centre) %>%
  Statistic_summary_withP20(R = 2000) %>%
  Clean_output_table() %>%
  mutate(equation = rep(c("Original", "Refitted"), each = 7)) %>%
  arrange(Creatinine_type, Centre) %>%
  select(-`P20 dose`, -Creatinine_type) %>%
  kable(caption = "\\label{tab:refid_original_stats}Reffitted and original CamGFR comparision non-IDMS patients in the validation dataset", format = "latex", booktabs = T) %>%
  kableExtra::kable_styling(latex_options="scale_down") %>%
  kableExtra::group_rows("IDMS creatinine", 1, 7, hline_after = T,
                         hline_before = T) %>%
  kableExtra::group_rows("Non-IDMS creatinine", 8, 14,  hline_after = T,
                         hline_before = T)

set.seed(123)
p_values <- Fitted_df %>%
  filter(Creatinine_type == "Non_IDMS", Centre == "All") %>%
  Bootstrap_all_stats_all_equation()
p_values



```

The above observations are confined in Table \ref{tab:refid_original_stats} .
The two models have a very similar RMSE, median residual and residual
interquatile range, with the refitted CamGFR having slight better statistics on
all three. This may be due to the increased amount of data used to estimate the
coefficients in the refitted CamGFR, hence, producing more accurate estimates of
the coefficients.
From the above we see that the refitted CamGFR model fits the data well and is
comparable to the original CamGFR model for non-IDMS data. In the next section
we investigate whether improvement can be made by adjusting the model.
Addition: Compare original and new CamGFR on IDMS data

```{r PLOT_compare_new_original, echo=F, fig.width=8, fig.height=8, message =F, fig.cap="Need to write caption"}
df <- Expansion_data %>%
  filter(fit_index == 0) %>%
  # filter(Creatinine_type == "Non_IDMS") %>%
  mutate(log_Creat = log(Creat)) %>%
  mutate(Original = predict(Addenbrooks_sqrt_model, newdata = .)^2) %>%
  mutate(Refitted = predict(Refit_CamGFR, newdata = .)^2) %>%
  dplyr::selectGFR, Original, Refitted, Centre, Creat, Creatinine_type,
         Creatinine_method) %>% 
  gather(key = equation, value = fitted, Original, Refitted) %>%
  mutate(resid = GFR - fitted) %>%
  group_by(equation, Creatinine_type, Creatinine_method, Centre) 

plot_data <- df %>%
  Statistic_summary() %>%
  left_join(df %>%
              do(my_normal_boot(.$Creat, func = median, name = "creat"))) %>%
  left_join(df %>%
              do(my_normal_boot(.$GFR, func = median, name = "GFR"))) 



p1 = plot_data %>% 
  ggplot(aes(x = interaction(Creatinine_method, Creatinine_type, sep = " "), 
             y = median, 
             group = interaction(Creatinine_method, equation, Centre, sep = " "))) + 
  geom_hline(yintercept = 0) +
  geom_errorbar(aes(ymin = median_lwr, ymax = median_upr, colour = Centre), 
                position= position_dodge(width = .5), width = 0.3, size = 1) +
  geom_point(aes(shape = equation), 
             position= position_dodge(width = .5), size = rel(2)) +
  scale_colour_manual(values = tol3qualitative) + 
  ggplot_theme() + 
  ylab("medain residual") + 
  scale_shape_manual(values = c("square", "triangle")) + 
  theme(axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank())
legend <- g_legend(p1)
p1 <- p1 + 
  theme(legend.position = "none")

p2 = plot_data %>% 
  filter(equation == "Original") %>%
  ggplot(aes(x = interaction(Creatinine_method, Creatinine_type, sep = " "), 
             y = creat, 
             group = interaction(Creatinine_method, Centre, sep = " "))) + 
  geom_errorbar(aes(ymin = creat_lwr, ymax = creat_upr, colour = Centre), 
                position= position_dodge(width = .5), width = 0, size = 1) +
  geom_point( aes(colour =Centre),
              position= position_dodge(width = .5), size = rel(2)) +
  scale_colour_manual(values = tol3qualitative) + 
  ggplot_theme() + 
  ylab("median log(Creat)") + 
  theme(axis.title.x = element_blank()) + 
  theme(legend.position = "none")

p3 = plot_data %>% 
  filter(equation == "Original") %>%
  ggplot(aes(x = interaction(Creatinine_method, Creatinine_type, sep = " "),
             y = GFR, 
             group = interaction(Creatinine_method, Centre, sep = " "))) + 
  geom_errorbar(aes(ymin = GFR_lwr, ymax = GFR_upr, colour = Centre), 
                position= position_dodge(width = .5), width = 0, size = 1) +
  geom_point(aes(colour =Centre), position= position_dodge(width = .5),
             size = rel(2)) +
  scale_colour_manual(values = tol3qualitative) + 
  ggplot_theme() + 
  ylab("median GFR") + 
  theme(axis.ticks.x = element_blank(), axis.title.x = element_blank(), 
        axis.text.x = element_blank())+ 
  theme(legend.position = "none")

g1 <- ggplotGrob(p1)
g2 <- ggplotGrob(p2)
g3 <- ggplotGrob(p3) 
g <- gtable:::rbind_gtable(g1, g3, "first") %>%
  gtable:::rbind_gtable(g2, "first")
panels <- g$layout$t[grep("panel", g$layout$name)]
g$heights[panels] <- unit(c(2,1,1), "null")


New_original_comparison_plot <- 
  arrangeGrob(g, legend, ncol =2, widths = c(5, 1))
grid.draw(New_original_comparison_plot)

# ggsave(file.path(fig_export_dir, "CamGFR_new_original_comparison_plot.pdf"), 
#        plot = New_original_comparison_plot, 
#        width = 8, height = 6)
```

## Adjusting CamGFR
This workflow is similar to that of the original CamGFR model. We start with
exploring the data, this helps inform decisions on how to best model the
relationship between the predictive variables and the predicted variable GFR. We
then ...

### Assessing relationships in the data

```{r box_cox_setup, echo = F}
simple_model <- 
  lm(GFR ~ Age + Ht + Wt+ BSA + Sex + I(log(Creat))*Creatinine_type,
     data = Expansion_data_fit)
boxcox_res <- MASS::boxcox(simple_model, lambda = seq(0,1, 1/1000), plotit = F)
boxcox_max <- boxcox_res$x[which(boxcox_res$y == max(boxcox_res$y))]

lambda <- boxcox_res$x[which.max(boxcox_res$y)]
Lhat <- max(boxcox_res$y)
CI_y <-  Lhat - 0.5*qchisq(0.95,1)
CI_lwr <- min(boxcox_res$x[which(boxcox_res$y - CI_y > 0)])
CI_upr<- max(boxcox_res$x[which(boxcox_res$y - CI_y > 0)])
```



```{r GFR_transformation, echo = F, fig.width=9, fig.height=6, message=F, fig.cap="Density plot of GFR, sqrt(GFR) and log(GFR) alowng with a fitted normal distribution in red."}

plot_data <- Expansion_data_fit %>%
  dplyr::selectGFR) %>%
  mutate(`sqrt(GFR)` = sqrt(GFR), 
         `log(GFR)` = log(GFR)) %>%
  pivot_longer(cols = everything()) 
distribution = plot_data %>%
  group_by(name) %>%
  summarise(mean = mean(value), sd = sd(value), 
            min = min(value), max = max(value)) %>% 
  rowwise() %>%
  mutate(grid = list(seq(min, max, length = 100))) %>%
  mutate(density = list(dnorm(grid, mean, sd))) %>% 
  unnest(cols = c(grid, density)) 

plot_data %>%
  ggplot() +
  geom_density(aes(x = value), fill = "grey80") + 
  ggplot_theme() + 
  geom_line(aes(y = density, x = grid), data = distribution, colour = "red") +
  facet_wrap(~name, ncol = 1, scales = "free", strip.position = "bottom") +
  theme(text = element_text(size = 12),
        strip.background = element_blank(), 
        axis.title.x = element_blank(),
        strip.text = element_text(size = rel(1)), 
        strip.placement = "outside", 
        plot.margin = margin(6, 8, 2, 2, "mm"))  


p1 = plot_data %>%
  ggplot() +
  geom_density(aes(x = value), fill = "grey80") + 
  ggplot_theme() + 
  geom_line(aes(y = density, x = grid), data = distribution, colour = "red") +
  facet_wrap(~name, ncol = 1, scales = "free", strip.position = "bottom") +
  theme(text = element_text(size = 12),
        strip.background = element_blank(), 
        axis.title.x = element_blank(),
        strip.text = element_text(size = rel(1)), 
        strip.placement = "outside", 
        plot.margin = margin(6, 8, 2, 2, "mm"))  

p2 = plot_data %>%
  arrange(name, value) %>%
  nest(data = c(value)) %>%
  rowwise() %>%
  mutate(mean = mean(data$value), 
         sd = sd(data$value), 
         len = length(data$value)) %>%
  mutate(quantiles = list(qnorm(p = (1:len)/(len+1), mean = mean, sd = sd))) %>%
  unnest(cols = c(data, quantiles)) %>%
  ggplot(aes(x = value, y = quantiles)) +
  geom_point(alpha = 0.2) + 
  geom_abline(intercept = 0, slope = 1) + 
  facet_wrap(~name, ncol = 1, scales = "free", strip.position = "bottom") +
  ggplot_theme() + 
  ylab("Theretical normal quantiles") +
  theme(text = element_text(size = 12),
        strip.background = element_blank(), 
        axis.title.x = element_blank(),
        strip.text = element_text(size = rel(1)), 
        strip.placement = "outside", 
        plot.margin = margin(6, 8, 2, 2, "mm")) 
  
p = ggdraw() +
  draw_plot(p1, 0, 0, 0.5, 1) + 
  draw_plot(p2, 0.5, 0, 0.5, 1) + 
  # draw_plot_label(c("A", "B", "C", "D", "E", "F"), 
  #                 c(0.05, 0.05, 0.05, 0.55, 0.55, 0.55),
  #                 c(1, 0.7, 0.38, 1, 0.7, 0.38), 
  #                 size = 17) + 
   draw_plot_label(c("A", "B"), 
                  c(0.01, .51),
                  c(1,  1), 
                  size = 17)



ggsave(file.path(fig_export_dir, "GFR_normal_distribution.pdf"), plot = p, 
       width = 12, height = 9)

  

```

Firstly, we assessed which transformation should be applied to to our predictive
variable GFR to achieve an approximate normal distributed variable. This was
done both graphically and using the Box-Cox transformation. Figure S... shows a
density plot along with a fitted normal curve for GFR, square-root transformed
GFR and log transformed GFR. These are the three transformations which have been
previously used. From this we see that the square root transformed GFR is the
most approximate to a normal distribution. The box-cox transformation was
applied to a simple model which contained all variables (along with the
interaction between creatinine and cratinine type). The resulting power
transformation suggested by the box-cox precedure is `r boxcox_max`, which is
reasonably close to 0.5. Hence confirming the square root transformation
suitability. Additionally, the square-root transformation removes the issues
with predicting negative GFR values.
We then look at correlations between the variable. This is useful as it gives an
indication of how useful the variables will be in predicting GFR. The ideal
redictor for GFR would have a strong correlation with GFR but weak correlation
with the other variables. Figure S... This shows that all variables are
reasonably correlated with GFR, age and creatinine are not correlated with with
the other explanatory variables whereas height, weight and BSA are all
correlated with each other (BSA is is calculated from height and weight and
hence is expected to be highly correlated with both).

```{r PLOT_data_corplot, fig.width=4, fig.height=4, fig.cap="Correlations matrix of GFR along with the explanitory variable", echo = F}
# correlations = Expansion_data_fit %>%
#   dplyr::selectCreat, Age, Ht, Wt, BSA, GFR) %>%
#   dplyr::selectGFR, Creat, everything())
# ggcorr(correlations, method = c("pairwise", "spearman"), label = TRUE, 
#        label_size = 3.5, label_color = "black", 
#        geom = "circle", max_size = 20, min_size = 6)

cormat <- Expansion_data_fit %>%
  dplyr::selectCreat, Age, Ht, Wt, BSA, GFR) %>%
  dplyr::selectGFR, Creat, everything()) %>%
  cor() %>%
  round(2)

# cormat <- Expansion_data_fit %>%
#   dplyr::selectCreat, Age, Ht, Wt, BSA, GFR) %>%
#   dplyr::selectGFR, Age, Creat, Urea, Sodium, Albumin, Ht, Wt, BSA) %>%
#   cor(use = "pairwise.complete.obs") %>%
#   round(2)

# Get lower triangle of the correlation matrix
get_lower_tri<-function(cormat){
  cormat[upper.tri(cormat)] <- NA
  return(cormat)
}
# Get upper triangle of the correlation matrix
get_upper_tri <- function(cormat){
  cormat[lower.tri(cormat)]<- NA
  return(cormat)
}

upper_tri <- get_upper_tri(cormat)

melted_cormat <- melt(upper_tri, na.rm = TRUE)

p <- ggplot(data = melted_cormat, aes(Var2, Var1, fill = value))+
  geom_tile(color = "white")+
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(-1,1), space = "Lab", 
                       name="Pearson\nCorrelation") +
  theme_minimal()+ 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, 
                                   size = 12, hjust = 1)) +
  coord_fixed() + 
  geom_text(aes(Var2, Var1, label = value), color = "black", size = 4) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    legend.justification = c(1, 0),
    legend.position = c(0.6, 0.7),
    legend.direction = "horizontal")+
  guides(fill = guide_colorbar(barwidth = 7, barheight = 1,
                               title.position = "top", title.hjust = 0.5))

p

ggsave(file.path(fig_export_dir, "Variable_correlation.pdf"),
       plot = p, 
       width = 12, height = 9)
```


We then looked at the relationships between our predictive variables (Age,
creatinine, gender, height, weight and BSA) and sqrt(GFR).  Figure
\ref{fig:gfr_variable_sex} shows the scatter plots of sqrt(GFR) against each of
the continuous predictive variables, with points coloured by centre. This plot
shows the non linear relationship between log(SCr) and sqrt(GFR). We also
observe a deviation from linearity in the relationship between age and
sqrt(GFR), where the slope of the relationship decreases for young patients.
Other relationships appear linear and no substantial difference was observed
between the different centres.

```{r PLOT_scatter_plots_between_variables_centre, echo = F, fig.width=9, fig.height=9, message=F, fig.cap="\\label{fig:gfr_variable_sex}Plot of square root transformed GFR against Age, BSA, Height, Weight and log(SCr). Points are coloured by centre and creatinine has been split into IDMS and non-IDMS. The curves represent a smoothed fit to the data and were produced using a generalised additive model with a cubic regression spline."}
tol3qualitative=c("#4477AA", "#DDCC77", "#CC6677")
Scatter_variables <- Expansion_data_fit %>% 
  mutate(Creat_IDMS = ifelse(Creatinine_type == "IDMS", 
                             Creat, NA)) %>%
  mutate(Creat = ifelse(Creatinine_type == "IDMS", 
                        NA, Creat)) %>%
  mutate("non-IDMS log(SCr)" = log(Creat)) %>%
  mutate("IDMS log(SCr)" = log(Creat_IDMS)) %>%
  mutate(GFR = sqrt(GFR)) %>%
  select("GFR" = GFR, "non-IDMS log(SCr)", 
         "IDMS log(SCr)", Age, 
         Ht, Wt, 
         "BSA" = BSA, Centre) %>% 
  gather(key = variable, value = value, -Centre, -GFR) %>%
  mutate(variable = factor(variable, levels = c("Age", "BSA", 
                                                "Ht", "Wt", 
                                                "non-IDMS log(SCr)", 
                                                "IDMS log(SCr)"))) %>%
  filter(!is.na(value)) %>%
  ggplot(aes(y = GFR, x = value, colour = Centre)) + 
  geom_point(alpha = .5) + 
  facet_wrap(~variable, scale = "free_x", nrow = 3) +
  geom_smooth(se=F, aes(group = Centre), colour = "black", size = rel(2),
              method = "gam", formula = y ~ s(x, bs = "cs")) + 
  geom_smooth(se=F, aes(colour = Centre), method = "gam", 
              formula = y ~ s(x, bs = "cs")) + 
  ggplot_theme() + 
  theme(axis.title.x = element_blank(), 
        # axis.text.x = element_blank(), 
        # axis.ticks.x = element_blank(), 
        # axis.line.x = element_blank(),
        legend.position = "right") +  
  scale_colour_manual(values = tol3qualitative) + 
  ylab("sqrt(GFR)")

Scatter_variables

ggsave(file.path(fig_export_dir, "Variable_scatter_centre_plot.pdf"),
       plot = Scatter_variables, 
       width = 12, height = 9)

```


We then analysed whether there was a difference in the non-creatinine between
the IDMS and non-IDMS patients. In Figure \ref{fig:gfr_variable_IDMS} we
reproduce the scatter plots for the continuous variables for Figure
\ref{fig:gfr_variable_sex}, however, this time the points coloured by
creatinine type. The plot shows no difference between the two patient groups for
these variables.

```{r PLOT_scatter_plots_between_variables_creattype, echo = F, fig.width=9, fig.height=6, message=F, fig.cap="\\label{fig:gfr_variable_IDMS}Plot of square root transformed GFR against Age, BSA, Height, Weight. Points are coloures by creatinine type (IDMS, non-IDMS). The cruves represent a smoothed fit to the data and were produced using a generalized additive model with a cubic regression spline."}
tol2qualitative=c("#4477AA", "#CC6677")
Scatter_variables_creattype <- Expansion_data_fit %>% 
  filter(fit_index == 1) %>%
  mutate(Centre = Centre2) %>%
  mutate(Creat_IDMS = ifelse(Creatinine_type == "IDMS", 
                             Creat, NA)) %>%
  mutate(Creat = ifelse(Creatinine_type == "IDMS", 
                        NA, Creat)) %>%
  mutate(GFR = sqrt(GFR)) %>%
  select("GFR" = GFR, Age, 
         Ht, Wt, "BSA" = BSA, Creatinine_type) %>% 
  gather(key = variable, value = value, -Creatinine_type, -GFR) %>%
  filter(!is.na(value)) %>%
  ggplot(aes(y = GFR, x = value, colour = Creatinine_type)) + 
  geom_point(alpha = .5) + 
  facet_wrap(~variable, scale = "free_x", nrow = 3) +
  geom_smooth(se=F, aes(group = Creatinine_type), colour = "black",
              size = rel(2),
              method = "gam", formula = y ~ s(x, bs = "cs")) + 
  geom_smooth(se=F, aes(colour = Creatinine_type), method = "gam", 
              formula = y ~ s(x, bs = "cs")) + 
  ggplot_theme() + 
  theme(axis.title.x = element_blank(), 
        legend.position = "right") +  
  scale_colour_manual(values = tol2qualitative) + 
  ylab("sqrt(GFR)")
Scatter_variables_creattype

ggsave(file.path(fig_export_dir, "Variable_scatter_creattype_plot.pdf"), 
       plot = Scatter_variables_creattype, 
       width = 12, height = 9)
```


As discussed in the data description section, for patients from the Manchester
centre and new patients from the Cambridge centre we had additional information
on ethnicity the majority of the patients. However, due to the limited number of
patients in the non-white ethnic groups detailed analysis is difficult. Figure
\ref{fig:Ethnicity_Creat_GFR_plot} plots the GFR creatinine relationship where
points have been coloured by the ethnic groups. Due to small numbers of
patients, the confidence for the loess curves all overlap. The only difference
observed is an upwards translation of the loess curve for black patients,
whereby a ethnically black patients with a same creatinine value has a higher
GFR value.

```{r Ethnicity_Creat_GFR_plot, echo=F, fig.width=5, fig.height=3, fig.cap="\\label{fig:Ethnicity_Creat_GFR_plot}sqrt(GFR) against log(SCr) with points and loess fitted lines coloured by ethnicity."}

tol4qualitative=c("#4477AA", "#117733", "#DDCC77", "#CC6677")

Ethnicity_creat_scatter <- Expansion_data_fit %>%
  filter(Creatinine_type == "Non_IDMS") %>%
  ggplot(aes(y = sqrt(GFR), x = log(Creat), colour = Ethnicity)) + 
  geom_point(aes(alpha = Ethnicity)) + 
  # scale_alpha_manual( range = c(1, .8, .1)) + 
  scale_alpha_manual(values = c(1,1,1,.1)) +
  scale_colour_manual(values = tol4qualitative) +
  ggplot_theme() +
  geom_smooth(method = "loess")
Ethnicity_creat_scatter

ggsave(file.path(fig_export_dir, "Creat_GFR_ethnicity_plot.pdf"), 
       plot = Ethnicity_creat_scatter, 
       width = 12, height = 9)
```


### Stepwise model selection

```{r Setup_full_null_models, echo = F}
form <- sqrt_GFR ~ (Age + Sex + Ht + Wt + BSA + log_Creat:Creatinine_type)^2 +
  I(log_Creat^2):Creatinine_type + I(log_Creat^3):Creatinine_type +
  Creatinine_type
full <- glm(form, data = as.data.frame(Expansion_data_fit), 
            family = gaussian(link = 'identity'), x=T, y=T)
null <- glm(sqrt_GFR ~ Creatinine_type + log_Creat:Creatinine_type, 
            data = as.data.frame(Expansion_data_fit), 
            family = gaussian(link = 'identity'), x=T, y=T)

save(null, full, Expansion_data_fit,
     file="model_selection/2_null_full_models.RData")
```

For the original CamGFR model, we used a stepwise procedure to choose between
candidate model with the use of three different criterion, 5 fold cross
validation, leave-out-one  and Bayesian information criterion. In the analysis
we found that all three criterion selected the same final model.
Here we will begin our model selection procedure by repeating this analysis. As
before, the set of models we will search contains the variables, age, sex,
height, weight, BSA, log(SCr) along with the pairwise interaction between these
variable. We will also include the variable creatinine type and along with its
interactions with other variables. We started each algorithm with the null model
(the simplest model we consider) which contained the variable log(SCr),
Creatinine type and their interaction. In the stepwise selection procedure at
each step any model that could be reached by adding or removing one variable was
considered.
When using BIC as the model selection criterion the following model was chosen:

```{r running_BIC_step, echo = F, cache = T}
n <- nrow(Expansion_data_fit)
BIC_model <- step(null, scope = list(lower=null, upper=full), k  = log(n),
                  trace=F)
formula(BIC_model)
summary(BIC_model)$coef %>%
  as.data.frame() %>%
  rownames_to_column("Variable") %>%
  # mutate(Variable = c("$(Intercept)$", "$Scr_{IDMS}$", "$BSA$", "$Age$",  "$Sex_M$",
  #                     "$log(Scr)Scr_{Non-IDMS}$", "$log(Scr)Scr_{IDMS}$", 
  #                     "$log(Scr)^2Scr_{Non-IDMS}$", "$log(Scr)^2Scr_{IDMS}$", 
  #                     "$log(Scr)^3Scr_{Non-IDMS}$", "$log(Scr)^3Scr_{IDMS}$", 
  #                     "$Age BSA$", "$BSA Sex_M$")) %>%
  kable(caption = "Summary of ceofficents for BIC model", escape = F,
        format = "latex")

```

This is similar to the original CamGFR model, with the differences being the
interaction with creatinine type and the one of the two interaction from the
original model (Age:Sex) being replaced with BSA:Sex.
The other two criterion we used previously, and we again consider, are 5-fold
cross-validation and leave-out-one cross validation. A n-fold cross-validation
is calculated by splitting dataset into n groups of equal size, for each of the
groups the model is fitted on the other n-1 groups. The RMSE is then calculated
using this fitted model on the on group that was left out of the model fitting
procedure. This is done for each of the n groups and the mean value is taken as
the n-fold cross-validation value. This model selection procedure contains a
random component to it, as the dataset is split randomly in the the n groups,
thus to mitigate the effect of the randomness, we run the selection procedure
many times and choose the most commonly selected model. We choose n to be 5.
Leave-out-one cross-validation is the same as n-fold cross-validation where n is
chosen to be the number of samples in the dataset. For both these statistics we
added the additional requirement that the RMSE for the new model must be lower
than 0.999 time the current value in order to move to a new model. This is done
to slightly bias the models with fewer parameters and to stop excessive jumping
between model with the same performance.

```{r running_lon_step, eval=F, echo=F} 
# source("model_selection/2_run_lon_selection.R")
```

The model most commonly selected model using the 5-fold cross validation
criterion was the following:

```{r load_lon_step, echo = F, cache=T, cache.lazy = FALSE}

load("model_selection/2_table_models_999_thesis.RData")
# load("2_model_selection/2_table_models.RData")

map_model_freq = table_models[[1]]$frequency
map_model_freq
total_freq = sapply(table_models, function(i) i$frequency) %>% sum()
total_freq
formula = table_models[[1]]$model$formula
formula

Leave_out_n_model <- lm(formula = formula, 
                        data = Expansion_data_fit)

kable(summary(Leave_out_n_model)$coef,
      caption = "\\label{tab:coef_lon}Summary of ceofficents for leave-out-n model")

```

<!-- Need to change -->

where it was choose a total of `r map_model_freq` out of `r total_freq`
repititions.This model has several additional variables compared with the BIC
model. Specifically, height and weight are now included along with the
interaction variables between and BSA and height. If we look at the summary of
the model we observe that the additional weight and interaction variables are
significantly different from 0 (height is not significant but as it has an
interaction term which is significant it does not matter), however, with the
addition of more variables we are at an increase risk of having over-fit the
model to the data.

```{r Running_lo1_step, eval = F, echo = F}
source("model_selection/2_run_lo1_selection.R")

```

Using the leave-out-one cross validation criterion the model selected was:
```{r load_lo1_step, echo = F, eval = t}
load("model_selection/2_lo1_model_999_thesis.RData")
formula(Leave_out_one_model)

Leave_out_one_model <- lm(formula(Leave_out_one_model), 
                          data = Expansion_data_fit)
```

```{r compare_coefficents, echo = F}

Refit_CamGFR_2 <- lm(sqrt_GFR ~ Creatinine_type + BSA + Age  + Sex + 
                       Creatinine_type*log_Creat +
                       Creatinine_type*I(log_Creat^2) + 
                       Creatinine_type*I(log_Creat^3) + 
                       BSA:Age + Age:Sex, 
                     data = Expansion_data_fit)

BIC_model_2 <- lm(sqrt_GFR ~  BSA + Age + Sex + Creatinine_type + 
                    Ht + Wt +
                    Creatinine_type*log_Creat + 
                    Creatinine_type*I(log_Creat^2) + 
                    Creatinine_type*I(log_Creat^3) + 
                    BSA:Age + BSA:Sex + BSA:Ht + Age:Sex, 
                  data = Expansion_data_fit)

Leave_out_n_model_2 <- lm(sqrt_GFR ~ Creatinine_type + BSA + Age + Sex + 
                            Ht + Wt + Creatinine_type*log_Creat + 
                            Creatinine_type*I(log_Creat^2) + 
                            Creatinine_type*I(log_Creat^3) + 
                            BSA:Sex + BSA:Age + BSA:Ht + Age:Ht, 
                          data = Expansion_data_fit)

Leave_out_one_model_2 <- lm(sqrt_GFR ~ Creatinine_type + BSA + Age + Sex + 
                              Ht + Wt + Creatinine_type*log_Creat + 
                              Creatinine_type*I(log_Creat^2) + 
                              Creatinine_type*I(log_Creat^3) + 
                              BSA:Sex + BSA:Age + BSA:Ht, 
                            data = Expansion_data_fit)
names = c("Intercept",  "BSA","Age", expression("Sex"["M"]),  
          expression("Scr"["IDMS"]),
          "Height", "Weight",
          "log(Scr)", 
          expression(log("Scr")^2),
          expression(log("Scr")^3),
          expression("Scr"["IDMS"]*log("Scr")),
          expression("Scr"["IDMS"]*log("Scr")^2),
          expression("Scr"["IDMS"]*log("Scr")^3),
          expression("Age"*"BSA"), 
          expression("BSA"*"Sex"["M"]), expression("BSA"*"Height"), 
          expression("Age"*"Sex"["M"]), expression("Age"*"Height"))

coef = c("(Intercept)", "BSA", "Age", "SexM", "Creatinine_typeIDMS", "Ht", "Wt",
         "log_Creat", "I(log_Creat^2)", "I(log_Creat^3)", 
         "Creatinine_typeIDMS:log_Creat", "Creatinine_typeIDMS:I(log_Creat^2)", 
         "Creatinine_typeIDMS:I(log_Creat^3)", "BSA:Age", "BSA:SexM", "BSA:Ht", 
         "Age:SexM", "Age:Ht")

groups = list(pane_1 = c("BSA"),
              pane_2 = c("SexM", "log_Creat","I(log_Creat^2)", "I(log_Creat^3)",
                         "BSA:SexM"),
              pane_3 = c("Creatinine_typeIDMS", "Creatinine_typeIDMS:log_Creat",
                         "Creatinine_typeIDMS:I(log_Creat^2)",
                         "Creatinine_typeIDMS:I(log_Creat^3)"),
              pane_4 = c("Age", "Ht", "Wt", "BSA:Age", "BSA:SexM", "BSA:Ht",
                         "Age:SexM", "Age:Ht"))

Compare_coef_plot <- 
  plot_coefs(BIC_model_2, Leave_out_n_model_2, Leave_out_one_model_2,
             Refit_CamGFR_2,
             model.names = c("BIC", "Leave-out-n", "Leave-out-1",
                             "Refit CamGFR"),
             scale = F, point.shape = T, facet.rows = 4,
             groups = groups, 
             color.class = tol4qualitative)
Compare_coef_plot

Compare_coef_plot <- Compare_coef_plot + 
  scale_y_discrete(breaks=coef,
                   labels=names)

func <- function(model, name){
  model %>%
    tidy() %>%
    as.data.frame() %>%
    dplyr::selectterm, estimate, std.error) %>%
    mutate(model = name)
}

df <- bind_rows(func(Refit_CamGFR_2, "Refit CamGFR"), 
                func(BIC_model_2, "BIC"), 
                func(Leave_out_n_model_2, "Leave-out-n"), 
                func(Leave_out_one_model_2, "Leave-one-out")) %>% 
  mutate(term = factor(term, levels = rev(coef))) %>%
  mutate(conf_high = estimate + qnorm(0.975)*std.error, 
         conf_low = estimate - qnorm(0.975)*std.error) %>%
  mutate(facet = factor(term, 
                        levels = c("(Intercept)", "BSA", "SexM", 
                                   "log_Creat","I(log_Creat^2)", 
                                   "I(log_Creat^3)", "BSA:SexM", 
                                   "Creatinine_typeIDMS", 
                                   "Creatinine_typeIDMS:log_Creat", 
                                   "Creatinine_typeIDMS:I(log_Creat^2)", 
                                   "Creatinine_typeIDMS:I(log_Creat^3)", "Age", 
                                   "Ht", "Wt", "BSA:Age", "BSA:SexM", "BSA:Ht", 
                                   "Age:SexM", "Age:Ht"), 
                        labels = c(rep("pane_1", 2), rep("pane_2", 5),
                                   rep("pane_2", 4), rep("pane_4", 8)))) 

p <-  ggplot(df) + 
  geom_vline(xintercept = 0, linetype = "dashed") +
  ggstance::geom_linerangeh(aes(y = term, xmin = conf_low, 
                                xmax = conf_high, colour = model), 
                            position = ggstance::position_dodgev(height = 0.5)) + 
  geom_point(aes(y = term, x = estimate, colour = model), 
             fill = "white", 
             size = 1, stroke = 1, shape = 21,  
             position = ggstance::position_dodgev(height = 0.5)) + 
  scale_color_manual(values = tol4qualitative) + 
  facet_wrap(~facet, scales = "free", nrow = 4) + 
  ggplot_theme() + 
  theme(strip.background = element_blank(), 
        axis.text = element_text(size = rel(1)),
        strip.text = element_blank(), 
        axis.title.y = element_blank()) + 
  scale_y_discrete(breaks=coef,
                   labels=names) + 
  xlab("Estiamted parameter value")
p

gt = ggplot_gtable(ggplot_build(p))
# gtable_show_layout(gt)
gt$heights[8] = 2*gt$heights[8]
gt$heights[13] = 9*gt$heights[13]
gt$heights[18] = 7*gt$heights[18]

ggsave(file.path(fig_export_dir, "Compare_coef_models.pdf"), 
       plot = grid.draw(gt), 
       width = 12, height = 9)
```

<!-- which is the same as the leave-out-n model described above.  -->
<!-- Need to change -->

We further examine the fit of the BIC model in Figure \ref{fig:resid_BIC}, where
we observe a very similar Figure \ref{fig:resid_reffited} for the refitted
model. Hence, the model also fits the data well.
The summary of leave-out-n model coefficients are shown in Table
\ref{tab:coef_lon}. Here we see that the only variables which are not
significantly different from 0 are Ht and the cubic term for IDMS creatinine.
The height variable has interaction with other variables and hence it does not
matter if it is insignificant.

```{r PLOT_summary_plots_for_BIC_model, echo = F, message = F, warning=F, fig.width=9, fig.height=6, fig.cap="\\label{fig:resid_BIC}Residual aginst age, fitted value, log(SCr) and BSA for the BI selected model."}
tol2qualitative=c("#4477AA", "#CC6677")

p1 <- Expansion_data_fit %>%
  mutate(Creatinine_type = factor(Creatinine_type,
                                  levels = c("IDMS", "Non_IDMS"), 
                                  labels = c("IDMS", "Non-IDMS"))) %>%
  mutate(fitted = BIC_model$fitted.values) %>%
  mutate(resid = BIC_model$residuals) %>%
  mutate(log_Creat = log(Creat)) %>%
  dplyr::selectresid, fitted, Age, log_Creat, BSA, Centre, Creatinine_type) %>%
  gather(key = variable, value = value, -resid, -Centre, -Creatinine_type) %>%
  mutate(variable = factor(variable,
                           levels = c("Age", "fitted", "log_Creat", "BSA"),
                           labels = c("Age", "Fitted values", "log(SCr)",
                                      "BSA"))) %>%
  ggplot(aes(x = value, y = resid)) + 
  geom_hline(yintercept = 0) + 
  geom_point(aes(shape = Centre, colour = Creatinine_type), alpha = .5) +
  facet_wrap(~variable, scale = "free_x") + 
  geom_smooth(colour = "black") +
  ggplot_theme() + 
  theme(text = element_text(size = 14), 
        axis.title.x = element_blank()) + 
  scale_color_manual(values =  tol2qualitative) + 
  ylab("Model residual")
p1

ggsave(file.path(fig_export_dir, "Model_fit_BICmodel.pdf"), 
       plot = p1, 
       width = 12, height = 9)

```

Finally, we wanted to see to what extent the interaction variables chosen during
the selection procedure can be seen in the data. Figure
\ref{fig:interaction_plots} consists of 3 panels one for each interaction
variable in the leave-out-n model. The interaction BSA:Sex is easily observed,
where the male patients have a much steeper gradient. The interaction between
Age:BSA can also be seen in the data, where patients with high BSA have a larger
decrease (steeper gradient) in GFR as they age. The interaction between Age:Ht,
which is unique to the leave-out-n model is far less clear in the data and
appears to be driven by patients with very small BSA.

```{r PLOT_interaction_variable, echo = F, cache=T, fig.height=6, fig.width=9, results = 'hide', fig.cap="\\label{fig:interaction_plots}Plots showing the interaction variables selected in the leave-out-n model"}
tol5qualitative=c("#332288", "#88CCEE", "#117733", "#DDCC77", "#CC6677")
p1 <- Expansion_data_fit %>%
  mutate(BMI = Wt/((Ht/100)^2)) %>%
  # filter(Sex == "M") %>%
  mutate(Age_group = cut(Age, c(17.9, 29.4, 43.1, 68.2, 84.9, 94))) %>%
  # mutate(BSA_group = cut(BSA, c(0, 1.54, 1.71, 1.92, 2.11, 3))) %>%
  ggplot(aes(x = BSA, y = sqrt(GFR))) + 
  geom_point(alpha = .5, aes(colour = Age_group)) + 
  ggplot_theme() +
  stat_smooth(method = "lm", se = F, aes(group = Age_group),
              colour = "black", size = rel(2)) +
  stat_smooth(method = "lm", se = F, aes(colour = Age_group)) +
  scale_color_manual(values =  tol5qualitative) 

tol2qualitative=c("#4477AA", "#CC6677")
p2 <- Expansion_data_fit %>%
  ggplot(aes(x = BSA, y = sqrt(GFR))) + 
  geom_point(alpha = .5, aes(colour = Sex)) + 
  ggplot_theme() +
  stat_smooth(method = "lm", se = F, aes(group = Sex), colour = "black",
              size = rel(2)) +
  stat_smooth(method = "lm", se = F, aes(colour = Sex)) +
  scale_color_manual(values =  tol2qualitative) 

p3 <- Expansion_data_fit %>%
  # mutate(BSA_group = cut(BSA, c(0, 1.54, 1.71, 1.92, 2.11, 3))) %>%
  mutate(Ht_group = cut(Ht, c(136, 144, 158, 179, 193, 200))) %>%
  ggplot(aes(x = BSA, y = sqrt(GFR))) + 
  geom_point(alpha = .5, aes(colour = Ht_group)) + 
  ggplot_theme() +
  stat_smooth(method = "lm", se = F, aes(group = Ht_group), colour = "black",
              size = rel(2)) +
  stat_smooth(method = "lm", se = F, aes(colour = Ht_group)) +
  scale_color_manual(values =  tol5qualitative) 
p3

# p3 <- Expansion_data_fit %>%
#   mutate(BMI = Wt/((Ht/100)^2)) %>%
#   # filter(Sex == "M") %>%
#   # mutate(Ht_group = cut_number(Ht, 9)) %>%
#   mutate(Ht_group = cut(Ht, c(136, 155, 162, 172, 180, 201))) %>%
#   ggplot(aes(x = Age, y = sqrt(GFR))) +
#   geom_point(alpha = .5, aes(colour = Ht_group)) +
#   ggplot_theme() +
#   stat_smooth(method = "lm", se = F, aes(group = Ht_group), colour = "black", size = rel(2)) +
#   stat_smooth(method = "lm", se = F, aes(colour = Ht_group)) +
#   scale_color_manual(values =  tol5qualitative)


p4 <- Expansion_data_fit %>%
  mutate(BMI = Wt/((Ht/100)^2)) %>%
  # filter(Sex == "M") %>%
  # mutate(BSA_group = cut_number(Ht, 5)) %>%
  # mutate(BSA_group = cut(BMI, c(0, 18.5, 25, 30, 35, 61))) %>%
  # mutate(BSA_group = cut_number(Wt, 5)) %>%
  mutate(BSA_group = cut(BSA, c(0, 1.54, 1.71, 1.92, 2.11, 3))) %>%
  ggplot(aes(x = Ht, y = sqrt(GFR))) + 
  geom_point(alpha = .5, aes(colour = BSA_group)) + 
  ggplot_theme() +
  stat_smooth(method = "lm", se = F, aes(group = BSA_group), colour = "black",
              size = rel(2)) +
  stat_smooth(method = "lm", se = F, aes(colour = BSA_group)) +
  scale_color_manual(values =  tol5qualitative) 

interactions_plot <- grid.arrange(p1,p2,p3, ncol = 2)


# ggsave(file.path(fig_export_dir, "Interaction_variable_plot.pdf"), 
#        plot = interactions_plot, 
#        width = 12, height = 9)

```


```{r plot_of_cubic_creat_fit_step_model, eval = F, include = F}
# NOT CURRENTLY INCLUDED

creat_func <- function(x, creat_type){ 
  coef =  Leave_out_n_model$coefficients
  ifelse(creat_type == "IDMS", 
         coef["Creatinine_typeIDMS:log_Creat"]*x +   
           coef["Creatinine_typeIDMS:I(log_Creat^2)"]*x^2 + 
           coef["Creatinine_typeIDMS:I(log_Creat^3)"]*x^3,
         coef["Creatinine_typeNon_IDMS:log_Creat"]*x + #coef["Creatinine_typeNon_IDMS"] +
           coef["Creatinine_typeNon_IDMS:I(log_Creat^2)"]*x^2 +
           coef["Creatinine_typeNon_IDMS:I(log_Creat^3)"]*x^3)
}

x = log(Expansion_data_fit$Creat)
y = Expansion_data_fit$Creatinine_type
SFigure4_cubic_Creat_fit <- data.frame(x = x,
                                       y = creat_func(x, y), type = y) %>%
  ggplot(aes(x=x, y=y, group = type, colour = type)) +
  geom_line() +
  ggplot_theme() + 
  ylab("Effect of log(SCr)") + xlab("log(SCr)")
# theme(legend.position = "none")
SFigure4_cubic_Creat_fit
```


### Spline models

In additional to the above analysis we wanted to explore whether a continuous
piecewise linear relationship might be more appropriate for the age and
creatinine terms. This was driven by the observations above where, in Figure
S... we observed a slight  non-linear relationship between Age and GFR, we
observe a change in gradient around the age of 40. For relationship in
particular a piecewise linear relationship looks appropriate. In addition, the
CKD-EPI models the creatinine GFR relationship with a piecewise linear fit,
hence, we explored a piecewise linear fit for this relationship too.
Fitting these relationships was not possible with our stepwise selection
workflow. Hence, for this section a more manual process was used. Starting with
the refitted CamGFR model (or the BIC model) three new models were fitted. The
first model was the refitted CamGFR model with a piecewise spline for Age with a
knot location around 40 (the exact location is estimated from the data). The
next model was a model with the same non-creatinine terms as the refitted CamGFR
but with the cubic creatinine terms replaced with a piecewise linear curve with
two knots at log(SCr) values around -0.1 and 0.5. The third model contained both
these piecewise linear curves.

```{r adjusting_model, eval = T, include = F}
# Need to show something about how I got these
Spline_model_age <- segmented(Refit_CamGFR, seg.Z = ~Age, psi = 40, 
                              control = seg.control(tol = 1e-06,
                                                    it.max = 100, h = 0.1))

Spline_model_creat <- 
  lm(sqrt(GFR) ~ Creatinine_type + BSA + Age + Sex + log_Creat_IDMS + 
       log_Creat_nonIDMS + Age:Sex + BSA:Age, 
     data = Expansion_data_fit) %>%
  segmented(obj = .,  seg.Z = ~log_Creat_IDMS + log_Creat_nonIDMS, 
            psi = list("log_Creat_IDMS" = c(-0.1, .2), 
                       "log_Creat_nonIDMS" = c(-0.1, .2)),
            control = seg.control(tol = 1e-06, it.max = 100, h = 0.1))

set.seed(123)
Spline_model_age_creat <- 
  lm(sqrt(GFR) ~ Creatinine_type + BSA + Age + Sex + log_Creat_IDMS + 
       log_Creat_nonIDMS + Age:Sex + BSA:Age, 
     data = Expansion_data_fit) %>%
  segmented(obj = .,  seg.Z = ~Age + log_Creat_IDMS + log_Creat_nonIDMS, 
            psi = list("Age" = 40, "log_Creat_IDMS" = c(-0.1, .2), 
                       "log_Creat_nonIDMS" = c(-0.1, .2)), 
            control = seg.control(tol = 1e-06, it.max = 100, h = 0.1))
Spline_model_age_creat

Spline_model_age_creat_NoIDMS <- 
  lm(sqrt(GFR) ~ BSA + Age + Sex + log_Creat +
       Age:Sex + BSA:Age, 
     data = Expansion_data_fit) %>%
  segmented(obj = .,  seg.Z = ~Age + log_Creat, 
            psi = list("Age" = 40, "log_Creat" = c(-0.1, .2)), 
            control = seg.control(tol = 1e-06, it.max = 100, h = 0.1))
```


The shapes of the age and creatinine relationship with GFR for the piecewise
fitted model are shown in Figure \ref{fig:spline_shape} . Surprisingly, we do
not observe a shift between the non-IDMS and the IDMS relationship, unlike what
we observed for the cubic fit in the refitted CamGFR model. The fitted age
creatinine relationship is as we would expect from our observations in the data.
As always we then examine the fit of the model with a residual against age, BSA,
log(SCr) and fitted values plot which is shown in Figure \ref{fig:resid_spline}.
This Figure does show some minor improvement in the compared with the comparable
figures (Figure \ref{fig:resid_BIC} and \ref{fig:resid_refitted}) for the BIC
and refitted CamGFR models. In particular, the residual age plot no longer shows
any patterns and the log(SCr) plot appears slightly better too.

```{r PLOT_spline_shape, eval = T, echo = F, fig.height=6, fig.width=6, fig.cap="\\label{fig:spline_shape}Shape of fitted piecewise lenear cureve of model that contains both a piecewise fit to age and a piecewise fit to log(SCr)"}

creat_IDMS_func <- function(x){
  coef = Spline_model_age_creat$coefficients
  psi = Spline_model_age_creat$psi[ ,"Est."]
  coef[["Creatinine_typeIDMS"]] + 
    coef[["log_Creat_IDMS"]]*x + 
    coef[["U1.log_Creat_IDMS"]]*(x > psi["psi1.log_Creat_IDMS"])*(x - psi["psi1.log_Creat_IDMS"]) + 
    coef[["U2.log_Creat_IDMS"]]*(x > psi["psi2.log_Creat_IDMS"])*(x - psi["psi2.log_Creat_IDMS"])
}
creat_nonIDMS_func <- function(x){
  coef = Spline_model_age_creat$coefficients
  psi = Spline_model_age_creat$psi[ ,"Est."]
  coef[["log_Creat_nonIDMS"]]*x + 
    coef[["U1.log_Creat_nonIDMS"]]*(x > psi["psi1.log_Creat_nonIDMS"])*(x - psi["psi1.log_Creat_nonIDMS"]) + 
    coef[["U2.log_Creat_nonIDMS"]]*(x > psi["psi2.log_Creat_nonIDMS"])*(x - psi["psi2.log_Creat_nonIDMS"])
}
age_BSA_func <- function(Age, BSA){
  coef = Spline_model_age_creat$coefficients
  psi = Spline_model_age_creat$psi[ ,"Est."]
  coef[["Age"]]*Age + 
    coef[["BSA:Age"]]*Age*BSA + 
    coef[["U1.Age"]]*(Age > psi["psi1.Age"])*(Age - psi["psi1.Age"]) 
}

p1 <- Expansion_data_fit %>% 
  mutate(Creatinine_type = ifelse(Creatinine_type == "Non_IDMS", "non-IDMS",
                                  "IDMS")) %>%
  ggplot(aes(x = log(Creat))) + 
  geom_line(data = filter(Expansion_data_fit, Creatinine_type == "IDMS"),
            aes(y = creat_IDMS_func(log(Creat)), colour = "IDMS")) +
  geom_line(data = filter(Expansion_data_fit, Creatinine_type == "IDMS"),
            aes(y = creat_nonIDMS_func(log(Creat)), colour = "non-IDMS")) +
  geom_rug(aes(colour = Creatinine_type), alpha =.2) + 
  ggplot_theme() + ylab("Effect of log(SCr)") +  xlab("log(SCr)") +
  scale_colour_manual(values = tol2qualitative, name = "Creatinine-type") + 
  ylim(-5, 3)
p1
p2 <- ggplot(Expansion_data_fit, aes(x = Age)) +
  geom_line(aes(y = age_BSA_func(Age, summary(Expansion_data_fit$BSA)["Min."]),
                colour = "min")) +
  geom_line(aes(y = age_BSA_func(Age, summary(Expansion_data_fit$BSA)["Median"]),
                colour = "median")) +
  geom_line(aes(y = age_BSA_func(Age, summary(Expansion_data_fit$BSA)["1st Qu."]),
                colour = "Q1")) +
  geom_line(aes(y = age_BSA_func(Age, summary(Expansion_data_fit$BSA)["3rd Qu."]),
                colour = "Q3")) +
  geom_line(aes(y = age_BSA_func(Age, summary(Expansion_data_fit$BSA)["Max."]),
                colour = "max")) +
  geom_rug(alpha =.2) +
  ggplot_theme() + ylab("Effect of Age") +
  scale_colour_manual(values = tol5qualitative, name = "BSA value") + 
  ylim(-6, 1.5)
p2
Piceswise_model_fit <- grid.arrange(p1, p2, ncol = 1)

# ggsave(file.path(latex_location, "/Chapter4/Figs/Spline_model_shape_plot.pdf"), 
#        plot = Piceswise_model_fit, 
#        width = 6, height = 6)
# 
# ggsave(file.path(fig_export_dir, "Spline_model_shape_plot.pdf"), 
#        plot = Piceswise_model_fit, 
#        width = 12, height = 9)


####################################################

creat_func <- function(x, creat_type){ 
  coef =  Refit_CamGFR$coefficients
  if(creat_type == "IDMS") 
    coef[5] + coef[7]*x + coef[9]*x^2 + coef[11]*x^3     
  else
    coef[6]*x + coef[8]*x^2 + coef[10]*x^3
}
# creat_func_original <- function(x){ 
#   coef =  coef(Addenbrooks_sqrt_model)
#   coef[1] +coef[3]*x + coef[7]*x^2 + coef[6]*x^3
# }

seq_func = function(range){
  seq(from = range[1], to = range[2], length.out = 1000)
}

p3 <- Expansion_data_fit %>% 
  mutate(Creatinine_type = ifelse(Creatinine_type == "Non_IDMS", "non-IDMS",
                                  "IDMS")) %>%
  ggplot() + 
  geom_line(data = filter(Expansion_data_fit, Creatinine_type == "IDMS"),
            aes(x = log(Creat), y = creat_func(log(Creat), "IDMS"),
                colour = "IDMS")) + 
  geom_line(data = filter(Expansion_data_fit, Creatinine_type == "Non_IDMS"),
            aes(x = log(Creat), y = creat_func(log(Creat), "non-IDMS"),
                colour = "non-IDMS")) + 
  # geom_line(aes(y = creat_func(log(Creat), Creatinine_type), colour = Creatinine_type)) +
  geom_rug(aes(x = log(Creat), colour = Creatinine_type), alpha =.2) + 
  ggplot_theme() + ylab("Effect of log(SCr)") + xlab("log(SCr)") +
  scale_colour_manual(values = tol2qualitative, name = "Creatinine-type") +
  ylim(-5, 3)
p3
age_BSA_func_CamGFR <- function(Age, BSA){
  coef = Refit_CamGFR$coefficients
  coef[["Age"]]*Age + 
    coef[["Age:BSA"]]*Age*BSA}


p4 <- ggplot(Expansion_data_fit, aes(x = Age)) +
  geom_line(aes(y = age_BSA_func_CamGFR(Age, summary(Expansion_data_fit$BSA)["Min."]),
                colour = "min")) +
  geom_line(aes(y = age_BSA_func_CamGFR(Age, summary(Expansion_data_fit$BSA)["Median"]),
                colour = "median")) +
  geom_line(aes(y = age_BSA_func_CamGFR(Age, summary(Expansion_data_fit$BSA)["1st Qu."]),
                colour = "Q1")) +
  geom_line(aes(y = age_BSA_func_CamGFR(Age, summary(Expansion_data_fit$BSA)["3rd Qu."]),
                colour = "Q3")) +
  geom_line(aes(y = age_BSA_func_CamGFR(Age, summary(Expansion_data_fit$BSA)["Max."]),
                colour = "max")) +
  geom_rug(alpha =.2) +
  ggplot_theme() + ylab("Effect of Age") +
  scale_colour_manual(values = tol5qualitative, name = "BSA value") + 
  ylim(-6, 1.5)


p <- plot_grid(p1,p3,p2,p4, labels = c("A", "C", "B", "D"), axis = "btlr",
               align = "hv", label_size = 15)

p 

ggsave(file.path(fig_export_dir, "Spline_model_shape_plot.pdf"), 
       plot = p, 
       width = 12, height = 9)

```

```{r summary_fplots_for_spline_model, echo = F, message = F, warning=F, fig.width=9, fig.height=6, fig.cap="\\label{fig:resid_spline}Model residual against Age, BSA, log(SCr) and fitted value for the piecewise linear model for age and log(SCr). Points are coloured by creatinine type and have a shape corresponding to centre"}
tol2qualitative=c("#4477AA", "#CC6677")

p1 <- Expansion_data_fit %>%
  mutate(Creatinine_type = factor(Creatinine_type,
                                  levels = c("IDMS", "Non_IDMS"), 
                                  labels = c("IDMS", "Non-IDMS"))) %>%
  mutate(fitted = Spline_model_age_creat$fitted.values) %>%
  mutate(resid = Spline_model_age_creat$residuals) %>%
  mutate(log_Creat = log(Creat)) %>%
  dplyr::selectresid, fitted, Age, log_Creat, BSA, Centre, Creatinine_type) %>%
  gather(key = variable, value = value, -resid, -Centre, -Creatinine_type) %>%
  mutate(variable = factor(variable,
                           levels = c("Age", "fitted", "log_Creat", "BSA"),
                           labels = c("Age", "Fitted values", "log(SCr)",
                                      "BSA"))) %>%
  ggplot(aes(x = value, y = resid)) + 
  geom_hline(yintercept = 0) + 
  geom_point(aes(shape = Centre, colour = Creatinine_type), alpha = .5) +
  facet_wrap(~variable, scale = "free_x") + 
  geom_smooth(colour = "black") +
  # geom_smooth(aes(colour = Creatinine_type)) +
  ggplot_theme() + 
  theme(text = element_text(size = 14), 
        axis.title.x = element_blank()) + 
  scale_color_manual(values =  tol2qualitative) + 
  ylab("Model residual")
p1

ggsave(file.path(fig_export_dir, "Spline_model_fit_plot.pdf"), 
       plot = p1, 
       width = 12, height = 9)

```

With these three models along with the BIC and leave-out-n and refitted CamGFR
model we move forward and compare them with the published model using our
validation dataset.

### Refitting CKD-EPI

Look to refit the CKD-EPI model, including the spline points. For this we will use 
the segmented package as above. However, GFR and Age will be modeled on the log 
scale, as they are in the CKD-EPI model. The outputted model will have the following from, 
\begin{equation*}
\log(GFR) = a + b_1\log(SCr) + b_2(\log(SCr) - c)[\text{if } SCr > c] + b_3\log(Age) + b_4Sex_F
\end{equation*}
where $a$, $b_1$, $b_2$, $b_3$, $b_4$ and $c$ are all coefficients that are 
estimated and $b_1$, $b_2$, and $c$ depend on both Sex and Creatinine type. 

```{r refitting_CKD_EIP, eval = T, include = F}

Expansion_data_fit <- Expansion_data_fit %>%
  mutate(log_Creat_SexM = log_Creat * (Sex == "M"), 
         log_Creat_SexF = log_Creat * (Sex == "F")) %>%
  mutate(log_Creat_IDMS_SexM = log_Creat_IDMS * (Sex == "M"), 
         log_Creat_IDMS_SexF = log_Creat_IDMS * (Sex == "F"), 
         log_Creat_nonIDMS_SexM = log_Creat_nonIDMS * (Sex == "M"), 
         log_Creat_nonIDMS_SexF = log_Creat_nonIDMS * (Sex == "F")) %>%
  mutate(log_GFR = log(GFR), 
         SexF = Sex == "F")

Expansion_data <- Expansion_data %>%
  mutate(log_Creat_SexM = log_Creat * (Sex == "M"), 
         log_Creat_SexF = log_Creat * (Sex == "F")) %>%
  mutate(log_Creat_IDMS_SexM = log_Creat_IDMS * (Sex == "M"), 
         log_Creat_IDMS_SexF = log_Creat_IDMS * (Sex == "F"), 
         log_Creat_nonIDMS_SexM = log_Creat_nonIDMS * (Sex == "M"), 
         log_Creat_nonIDMS_SexF = log_Creat_nonIDMS * (Sex == "F")) %>%
  mutate(log_GFR = log(GFR), 
         SexF = Sex == "F")


set.seed(123)
Refit_CKD <- lm(log_GFR ~ Creatinine_type + BSA + Age + 
                  log_Creat_IDMS_SexM + log_Creat_IDMS_SexF + 
                  log_Creat_nonIDMS_SexM + log_Creat_nonIDMS_SexF + SexF,
     data = Expansion_data_fit) %>%
  segmented(obj = .,  
            seg.Z = ~log_Creat_IDMS_SexM + log_Creat_IDMS_SexF + 
              log_Creat_nonIDMS_SexM + log_Creat_nonIDMS_SexF,
            psi = list("log_Creat_IDMS_SexM" = -0.1, 
                       "log_Creat_IDMS_SexF" = -0.1, 
                       "log_Creat_nonIDMS_SexM" = -0.1, 
                       "log_Creat_nonIDMS_SexF" = -0.1),
            control = seg.control(tol = 1e-06, it.max = 100, h = 0.1))
summary(Refit_CKD)$coef %>%
  as.data.frame() %>%
  rownames_to_column(var = "term") %>%
  filter(!str_detect(term, "psi"))
summary(Refit_CKD)$psi %>%
  as.data.frame() %>%
  rownames_to_column(var = "term") 


```


So we will reduce CKD-EPI to a similar form to be able to comare coefficents. 
CKD has the following published form, ignoring the Ethnicity term, in which $\alpha$ 
and $\kappa$ depend on Sex. 

\begin{align*}
GFR &= 
141\times \text{min}\left(\frac{Scr}{\kappa}, 1\right)^{\alpha} \times \text{max}\left(\frac{Scr}{\kappa}, 1\right)^{-1.209} \times {0.993}^Age \times (1+ 0.018Sex_F) \\
  &= \beta_0\times \text{min}\left(\frac{Scr}{\kappa}, 1\right)^{\alpha} \times \text{max}\left(\frac{Scr}{\kappa}, 1\right)^{\gamma} \times \beta_1^{Age} \times (1+ \beta_3Sex_F) \\
\log(GFR)  &= \log(\beta_0) + \alpha\text{min}\left(\log(Scr) - \log(\kappa), 0\right) + \gamma \text{max}\left(\log(Scr) - \log(\kappa), 0\right) \\ 
& \quad + \log(\beta_1)Age + \log(1+ \beta_3)Sex_F \\
&= \log(\beta_0) + \alpha\log(Scr) - \alpha\log(\kappa) + (\gamma-\alpha)\left(\log(SCr)-\log(\kappa)\right)[\text{if } \log(Scr) > \log(\kappa)] \\
& \quad + \log(\beta_1)Age + \log(1+ \beta_3)Sex_F \\
&= \log(\beta_0) + \alpha_M\log(\kappa_M) + \alpha\log(Scr) + (\gamma-\alpha)\left(\log(SCr)-\log(\kappa)\right)[\text{if } \log(Scr) > \log(\kappa)] \\
& \quad + \log(\beta_1)Age + \left(\log(1+ \beta_3) - \alpha_M\log(\kappa_M) + \alpha_F\log(\kappa_F)\right)Sex_F 
\end{align*}
Where $\alpha_M$ and $\kappa_M$ are the values of $\alpha$ and $\kappa$ when Sex is male. In the above form the coefficents of the CKD-EPI can be directly comapred with the coefficients of the refitted CKD-EPI using the segmented package. Namely,
\begin{align*}
a &= \log(\beta_0) + \alpha_M\log(\kappa_M) \\
b_1 &= \alpha \\
b_2 &= \gamma - \alpha \\
c &= \log(\kappa) \\
b_2 &= \log(\beta_2) \\
b_3 &= \log(1+ \beta_3) - \alpha_M\log(\kappa_M) + \alpha_F\log(\kappa_F)
\end{align*}

```{r refitting_CKD-EPI, eval = T, include = F}

coef = Refit_CKD$coefficients
psi = Refit_CKD$psi[ ,"Est."]



beta_0 = exp(coef[["(Intercept)"]] +
               coef[["log_Creat_nonIDMS_SexM"]]*psi["psi1.log_Creat_IDMS_SexM"] )
alpha_M = coef[["log_Creat_nonIDMS_SexM"]] 
alpha_F = coef[["log_Creat_nonIDMS_SexF"]] 
gamma_M = coef[["log_Creat_nonIDMS_SexM"]] + coef[["U1.log_Creat_nonIDMS_SexM"]]
gamma_F = coef[["log_Creat_nonIDMS_SexF"]] + coef[["U1.log_Creat_nonIDMS_SexF"]]
kappa_M = exp(psi["psi1.log_Creat_nonIDMS_SexM"])
kappa_F = exp(psi["psi1.log_Creat_nonIDMS_SexF"])

alpha_M_IDMS = coef[["log_Creat_IDMS_SexM"]] 
alpha_F_IDMS = coef[["log_Creat_IDMS_SexF"]] 
gamma_M_IDMS = coef[["log_Creat_IDMS_SexM"]] + coef[["U1.log_Creat_IDMS_SexM"]]
gamma_F_IDMS = coef[["log_Creat_IDMS_SexF"]] + coef[["U1.log_Creat_IDMS_SexF"]]
kappa_M_IDMS = exp(psi["psi1.log_Creat_IDMS_SexM"])
kappa_F_IDMS = exp(psi["psi1.log_Creat_IDMS_SexF"])


beta_1 =  exp(coef[["Age"]])
beta_3 = exp(coef[["SexFTRUE"]] - 
               coef[["log_Creat_nonIDMS_SexM"]]*psi["psi1.log_Creat_IDMS_SexM"] + 
               coef[["log_Creat_nonIDMS_SexF"]]*psi["psi1.log_Creat_IDMS_SexF"]) -1





```
 
The refitted CKD-EPI has the floowing coefficents:

\begin{equation*}
GFR = 
117\times\text{min}\left(\frac{Scr}{\kappa}, 1\right)^{\alpha} \times \text{max}\left(\frac{Scr}{\kappa}, 1\right)^{\gamma} \times Age^{0.993} \times (1- 0.016Sex_F) 
\end{equation*}
where for non-IDMS data
\begin{itemize}
\item $\kappa$ = 1.000 if male and 0.798 if female
\item $\alpha$ = -0.457 if male and -0.410 if female
\item $\gamma$ = -1.138 if male and -1.149 if female
\end{itemize} 
while for IDMS cratinien data
\begin{itemize}
\item $\kappa$ = 0.870 if male and 0.792 if female
\item $\alpha$ = -0.293 if male and -0.430 if female
\item $\gamma$ = -0.984 if male and -1.118 if female
\end{itemize} 

```{r, eval = T, include = F}

CKD_coef = data.frame(Coef = 
                        c("beta_0", "alpha_M", "alpha_F", "gamma_M", "gamma_F", 
                          "kappa_M", "kappa_F", "alpha_M_IDMS", "alpha_F_IDMS", 
                          "gamma_M_IDMS", "gamma_F_IDMS", "kappa_M_IDMS", 
                          "kappa_F_IDMS", "beta_1", "beta_3"),
                      Refit_CKD_EPI = 
                        c(beta_0, alpha_M, alpha_F, gamma_M, gamma_F, 
                          kappa_M, kappa_F, alpha_M_IDMS, alpha_F_IDMS, 
                          gamma_M_IDMS, gamma_F_IDMS, kappa_M_IDMS, 
                          kappa_F_IDMS, beta_1, beta_3) %>%
                        signif(digits = 3), 
                      Original_CKD_EPI = 
                        c(141, -0.411, -0.329, -1.209, -1.209, 
                          0.9, 0.7, -0.411, -0.329, 
                          -1.209, -1.209, 0.9, 
                          0.7, 0.993, 0.018))
                                    
CKD_coef                       
                        
```




```{r PLOT_spline_CKD, eval = T, echo = F, fig.height=3.5, fig.width=6, fig.cap="\\label{fig:spline_shape}Shape of Creatine relationship in the CKD-EPI model and our refitted version"}

CKD_creat_IDMS_M_func <- function(x, Sex){
  coef = Refit_CKD$coefficients
  psi = Refit_CKD$psi[ ,"Est."]
  coef[["Creatinine_typeIDMS"]] + 
    coef[["log_Creat_IDMS_SexM"]]*x + 
              coef[["U1.log_Creat_IDMS_SexM"]]*(x > psi["psi1.log_Creat_IDMS_SexM"])*
              (x - psi["psi1.log_Creat_IDMS_SexM"])
}
CKD_creat_IDMS_F_func <- function(x, Sex){
  coef = Refit_CKD$coefficients
  psi = Refit_CKD$psi[ ,"Est."]
  coef[["Creatinine_typeIDMS"]] + 
    coef[["SexFTRUE"]] + coef[["log_Creat_IDMS_SexF"]]*x + 
              coef[["U1.log_Creat_IDMS_SexF"]]*(x > psi["psi1.log_Creat_IDMS_SexF"])*
              (x - psi["psi1.log_Creat_IDMS_SexF"])
}
CKD_creat_nonIDMS_M_func <- function(x, Sex){
  coef = Refit_CKD$coefficients
  psi = Refit_CKD$psi[ ,"Est."]
    coef[["log_Creat_nonIDMS_SexM"]]*x + 
              coef[["U1.log_Creat_nonIDMS_SexM"]]*(x > psi["psi1.log_Creat_nonIDMS_SexM"])*
              (x - psi["psi1.log_Creat_nonIDMS_SexM"])
}
CKD_creat_nonIDMS_F_func <- function(x, Sex){
  coef = Refit_CKD$coefficients
  psi = Refit_CKD$psi[ ,"Est."]
    coef[["SexFTRUE"]] + coef[["log_Creat_nonIDMS_SexF"]]*x + 
              coef[["U1.log_Creat_nonIDMS_SexF"]]*(x > psi["psi1.log_Creat_nonIDMS_SexF"])*
              (x - psi["psi1.log_Creat_nonIDMS_SexF"])
}



Actual_CKD_creat_M_func <- function(x, Sex){
 -0.411*x + (-1.1209 + 0.411)*(x-log(0.9))*(x > log(0.9))
} 
Actual_CKD_creat_F_func <- function(x, Sex){
 -0.329*x + (-1.1209 +0.329)*(x-log(0.7))*(x > log(0.7)) + 
            log(1.018) +0.411*log(0.9) - 0.329*log(0.7)
  } 


p1 <- Expansion_data_fit %>% 
  filter(Creatinine_type == "Non_IDMS") %>% 
  ggplot(aes(x = log(Creat))) + 
  geom_line(data = filter(Expansion_data_fit, Sex == "M"),
            aes(y = CKD_creat_nonIDMS_M_func(log(Creat), "M"), colour = "M", linetype = "Refitted")) +
  geom_line(data = filter(Expansion_data_fit, Sex == "F"),
            aes(y = CKD_creat_nonIDMS_F_func(log(Creat), "F"), colour = "F", linetype = "Refitted")) +
  geom_line(data = filter(Expansion_data_fit, Sex == "M"),
            aes(y = Actual_CKD_creat_M_func(log(Creat), "M"), colour = "M", linetype = "Original")) +
  geom_line(data = filter(Expansion_data_fit, Sex == "F"),
            aes(y = Actual_CKD_creat_F_func(log(Creat), "F"), colour = "F", linetype = "Original")) +
  geom_rug(aes(colour = Sex), alpha =.2) + 
  ggplot_theme() + ylab("Effect of log(SCr)") +  xlab("non-IDMS log(SCr)") +
  scale_colour_manual(values = tol2qualitative, name = "Sex") + 
  ylim(-2, 1)


Expansion_data %>% 
  dplyr::selectDiagnosis, Patient_type) %>%
  table()


p2 <- Expansion_data_fit %>% 
  filter(Creatinine_type == "IDMS") %>% 
  ggplot(aes(x = log(Creat))) + 
  geom_line(data = filter(Expansion_data_fit, Sex == "M"),
            aes(y = CKD_creat_IDMS_M_func(log(Creat), "M"), colour = "M", linetype = "Refitted")) +
  geom_line(data = filter(Expansion_data_fit, Sex == "F"),
            aes(y = CKD_creat_IDMS_F_func(log(Creat), "F"), colour = "F", linetype = "Refitted")) +
  geom_line(data = filter(Expansion_data_fit, Sex == "M"),
            aes(y = Actual_CKD_creat_M_func(log(Creat), "M"), colour = "M", linetype = "Original")) +
  geom_line(data = filter(Expansion_data_fit, Sex == "F"),
            aes(y = Actual_CKD_creat_F_func(log(Creat), "F"), colour = "F", linetype = "Original")) +
  geom_rug(aes(colour = Sex), alpha =.2) + 
  ggplot_theme() + ylab("Effect of log(SCr)") +  xlab("IDMS log(SCr)") +
  scale_colour_manual(values = tol2qualitative, name = "Sex") + 
  ylim(-2, 1)


p <- plot_grid(p1,p2, labels = c("A", "B"), axis = "btlr",
               align = "hv", label_size = 15)

ggsave(file.path(fig_export_dir, "Refit_model_shape_plot.pdf"), 
       plot = p, 
       width = 12, height = 9)

```


## Model validation
We next compared the currently published models which are suitable for IDMS data
with our six candidate models. Of the published models, only the CKD-EPI and
MDRD were either developed on or adjusted to be suitable for IDMS creatinine
data. The MDRD was originally developed on non-IDMS data and the original
intercept term was 186, since its publication this term has been adjusted to 175
so that the model is suitable for IDMS data. The CKD-EPI was developed on IDMS
data. However, we and other have shown it to be accurate at estimating GFR using
non-IDMS

```{r data_tables_all, include = T, echo=F, cache=T}

Clean_output_table <- function(table, include_p10_p30 = F){
  t = table %>% 
    ungroup() %>%
    mutate_at(.vars = vars(median_fitted, starts_with("RMSE"),
                           starts_with("IQR"),
                           starts_with("median")), 
              list(~round(., 2))) %>%
    mutate_at(.vars = vars(starts_with("P10"), starts_with("P20"), starts_with("P30")), 
              list(~round(., 3))) %>%
    rename("median fitted value" = median_fitted) %>%
    mutate(RMSE = paste0(RMSE, " (", RMSE_lwr, ", ", RMSE_upr, ")")) %>%
    mutate(median = paste0(median, " (", median_lwr, ", ", median_upr, ")")) %>%
    mutate(IQR = paste0(IQR, " (", IQR_lwr, ", ", IQR_upr, ")")) 
    if(include_p10_p30 == T){
      t %>% 
        mutate("Dose P10" = paste0(P10_dose, " (", P10_dose_lwr, ", ", P10_dose_upr, ")")) %>%
        mutate("Dose P20" = paste0(P20_dose, " (", P20_dose_lwr, ", ", P20_dose_upr, ")")) %>%
        mutate("Dose P30" = paste0(P30_dose, " (", P30_dose_lwr, ", ", P30_dose_upr, ")")) %>%
        select(-RMSE_lwr, -RMSE_upr, -median_lwr, -median_upr, -IQR_lwr, -IQR_upr,
               -P10_dose_lwr, -P10_dose_upr, -P10_dose,
               -P20_dose_lwr, -P20_dose_upr, -P20_dose,
               -P30_dose_lwr, -P30_dose_upr, -P30_dose)
    } else { 
      t %>% 
        mutate("Dose P20" = paste0(P20_dose, " (", P20_dose_lwr, ", ", P20_dose_upr, ")")) %>%
        select(-RMSE_lwr, -RMSE_upr, -median_lwr, -median_upr, -IQR_lwr, -IQR_upr,
               -P20_dose_lwr, -P20_dose_upr, -P20_dose)
        }
    
    
}


Validation_fitted_df_all <-  Expansion_data %>%
  filter(fit_index == 0) %>%
  group_by(Diagnosis) %>% mutate(n = n()) %>% ungroup() %>%
  mutate(Diagnosis = ifelse(n < 50, "Other", Diagnosis)) %>%
  mutate(Date_diff = as.numeric(Date_GFR - Date_creat)) %>%
  mutate(Date_diff_group = cut(Date_diff,
                               breaks = c(-31, -8, -3, -1, 0, 2, 7, 30))) %>%
  mutate(Date_diff_group = as.character(Date_diff_group)) %>%
  mutate(Date_diff_group = ifelse(is.na(Date_diff_group), "NA",
                                  Date_diff_group)) %>%
  bind_cols(GFR_fitted_values_eth(.)) %>%
  mutate(Refit_CamGFR = predict(Refit_CamGFR, newdata = .)^2) %>%
  mutate(CamGFR_v1 = predict(Addenbrooks_sqrt_model, newdata = .)^2) %>%
  mutate(Leave_out_1_model = predict(Leave_out_one_model, newdata = .)^2) %>%
  # mutate(Leave_out_n_model = predict(Leave_out_n_model, newdata = .)^2) %>%
  # mutate(BIC_model = predict(BIC_model, newdata = .)^2) %>%
  # mutate(Spline_model_age = predict(Spline_model_age, newdata = .)^2) %>%
  # mutate(Spline_model_creat = predict(Spline_model_creat, newdata = .)^2) %>%
  # mutate(CKD_refit = exp(predict(Refit_CKD, newdata = .))) %>%
  mutate(Spline_model_age_creat = predict(Spline_model_age_creat, newdata = .)^2) %>%
  mutate(MDRD = ifelse(Creatinine_type == "IDMS", MDRD_adj_IDMS, MDRD_adj)) %>% 
  rename(`CKD-EPI` = CKD_adj, LM = LM_adj, FAS = FAS_adj) %>%
  gather(key = equation, value = fitted,
         Refit_CamGFR:Spline_model_age_creat, `CKD-EPI`, MDRD, LM, FAS) %>%
  mutate(resid = GFR - fitted) %>%
  mutate(equation = recode(equation, 
                           "Refit_CamGFR" = "CamGFR v2", 
                           "CamGFR_v1" = "CamGFR v1", 
                           "Leave_out_1_model" = "Leave-one-out", 
                           "Spline_model_age_creat"= "Piecewise linear")) %>%
  mutate(Creatinine_type = ifelse(Creatinine_type == "Non_IDMS", "Non-IDMS",
                                  "IDMS")) %>%
  mutate(Patient_type = ifelse(Patient_type == "Unknown", "Non-Cancer",
                               Patient_type)) 

Validation_fitted_df <- Validation_fitted_df_all %>%
  filter(equation %in% c("CamGFR v2", "CKD-EPI", "MDRD", "LM", "FAS",
                         "CamGFR v1")) 

Results_all <- Validation_fitted_df_all %>%
  group_by(equation) %>%
  Statistic_summary_withP10_P20_P30() %>%
  arrange(RMSE)

Results_Centre_all <- Validation_fitted_df_all %>%
  group_by(equation, Centre) %>%
  Statistic_summary_withP10_P20_P30() %>%
  arrange(Centre, RMSE)

Results_Centre_CreatType_all <- Validation_fitted_df_all %>%
  group_by(equation, Centre) %>%
  Statistic_summary_withP10_P20_P30() %>%
  arrange(Centre, RMSE)



# S8
Results_CreatType_all <- Validation_fitted_df_all %>%
  group_by(equation, Creatinine_type) %>%
  Statistic_summary_withP10_P20_P30() %>%
  arrange(Creatinine_type, RMSE)

# S9
Results_Age_Creattype_all <- Validation_fitted_df_all %>% 
  mutate(Age_cut = cut_number(Age, 5)) %>% 
  group_by(equation, Age_cut, Creatinine_type) %>%
  Statistic_summary_with_doseP20() %>% 
  ungroup() %>% 
  arrange(Creatinine_type, Age_cut, RMSE)

# S10
Results_BSA_Creattype_all <- Validation_fitted_df_all %>% 
  mutate(BSA_cut = cut_number(BSA, 5)) %>% 
  group_by(equation, BSA_cut, Creatinine_type) %>%
  Statistic_summary_with_doseP20() %>% 
  ungroup() %>%
  arrange(Creatinine_type, BSA_cut, RMSE) 

# S11
Results_Sex_Creattype_all <- Validation_fitted_df_all %>% 
  group_by(equation, Sex, Creatinine_type) %>%
  Statistic_summary_with_doseP20() %>% 
  ungroup() %>%
  arrange(Creatinine_type, Sex, RMSE) 

# S12
Results_PatientType_Creattype_all <- Validation_fitted_df_all %>%
  group_by(equation, Patient_type, Creatinine_type) %>%
  Statistic_summary_with_doseP20() %>%
  arrange(Creatinine_type, Patient_type, RMSE) 

# S13 
Results_eGFR_Creattype_all <- Validation_fitted_df_all %>% 
  mutate(eGFR_cut = cut(fitted, breaks =  c(0, 60, 90, 310))) %>% 
  group_by(equation, eGFR_cut, Creatinine_type) %>%
  Statistic_summary_with_doseP20() %>% 
  arrange(Creatinine_type, eGFR_cut, RMSE) %>%
  ungroup() 


# S8
repeats <- Expansion_data %>%
  group_by(PatientID) %>%
  summarise(l = length(unique(fit_index))) %>%
  filter(l != 1) %>% 
  pull(PatientID)  
Results_CreatType_repeats_all <- Validation_fitted_df_all %>%
  mutate(`Repeat patients` = PatientID %in% repeats) %>%
  group_by(equation, Creatinine_type, `Repeat patients`) %>%
  Statistic_summary_with_doseP20() %>%
  arrange(`Repeat patients`, Creatinine_type, RMSE)

```




```{r data_tables_all_selected, echo = F, include = F, cache=T}

Results <- Results_all %>% 
  filter(equation %in% c("CamGFR v2", "CKD-EPI", "MDRD", "LM", "FAS",
                         "CamGFR v1")) 
Clean_Results <- Clean_output_table(Results, include_p10_p30 = T)

Results_Centre <- Results_Centre_all %>%
   filter(equation %in% c("CamGFR v2", "CKD-EPI", "MDRD", "LM", "FAS",
                         "CamGFR v1")) 
Clean_Results_Centre <- Clean_output_table(Results_Centre, include_p10_p30 = T)

Results_Centre_CreatType <-  Results_Centre_CreatType_all %>%
     filter(equation %in% c("CamGFR v2", "CKD-EPI", "MDRD", "LM", "FAS",
                         "CamGFR v1")) 
Clean_Results_Cetre_CreatType <- Clean_output_table(Results_Centre_CreatType, include_p10_p30 = T)



# S8
Results_CreatType <- Results_CreatType_all %>%
   filter(equation %in% c("CamGFR v2", "CKD-EPI", "MDRD", "LM", "FAS",
                         "CamGFR v1")) 
Clean_Results_CreatType <- Clean_output_table(Results_CreatType, include_p10_p30 = T)


# S9
Results_Age_Creattype <- Results_Age_Creattype_all %>%
   filter(equation %in% c("CamGFR v2", "CKD-EPI", "MDRD", "LM", "FAS",
                         "CamGFR v1")) 
Clean_Results_Age_Creattype <- Clean_output_table(Results_Age_Creattype)

# S10
Results_BSA_Creattype <- Results_BSA_Creattype_all %>%
   filter(equation %in% c("CamGFR v2", "CKD-EPI", "MDRD", "LM", "FAS",
                         "CamGFR v1"))  
Clean_Results_BSA_Creattype <- Clean_output_table(Results_BSA_Creattype)


# S11
Results_Sex_Creattype <- Results_Sex_Creattype_all %>%
   filter(equation %in% c("CamGFR v2", "CKD-EPI", "MDRD", "LM", "FAS",
                         "CamGFR v1"))  
Clean_Results_Sex_Creattype <- Clean_output_table(Results_Sex_Creattype)

# S12
Results_PatientType_Creattype <- Results_PatientType_Creattype_all %>% 
  filter(equation %in% c("CamGFR v2", "CKD-EPI", "MDRD", "LM", "FAS",
                         "CamGFR v1")) 
Clean_Results_PatientType_Creattype <- Clean_output_table(Results_PatientType_Creattype)

# S13 
Results_eGFR_Creattype <- Results_eGFR_Creattype_all %>% 
      filter(equation %in% c("CamGFR v2", "CKD-EPI", "MDRD", "LM", "FAS",
                         "CamGFR v1")) 
Clean_Results_eGFR_Creattype <- Clean_output_table(Results_eGFR_Creattype)


# S ... 
Results_CreatType_repeats <- Results_CreatType_repeats_all %>% 
      filter(equation %in% c("CamGFR v2", "CKD-EPI", "MDRD", "LM", "FAS",
                         "CamGFR v1")) 
Clean_Results_CreatType_repeats <- Clean_output_table(Results_CreatType_repeats)


```


```{r Output_paper}

# S8
Clean_Results_CreatType  %>%
  write_csv(path = file.path(fig_export_dir, "S8.csv"))

# S9
Clean_Results_Age_Creattype  %>%
  write_csv(path = file.path(fig_export_dir, "S9.csv"))

# S10
Clean_Results_BSA_Creattype  %>%
  write_csv(path = file.path(fig_export_dir, "S10.csv"))

# S11
Clean_Results_Sex_Creattype  %>%
  write_csv(path = file.path(fig_export_dir, "S11.csv"))

# S12
Clean_Results_PatientType_Creattype  %>%
  write_csv(path = file.path(fig_export_dir, "S12.csv"))

# S13 
Clean_Results_eGFR_Creattype  %>%
  write_csv(path = file.path(fig_export_dir, "S13.csv"))

# S... 
Clean_Results_CreatType_repeats  %>%
  write_csv(path = file.path(fig_export_dir, "Results_by_repeats.csv"))


```


```{r}
Table_S9_S13 = createWorkbook()

addWorksheet(Table_S9_S13, "S9")
writeData(Table_p_values, 1,  as.data.frame(Clean_Results_Age_Creattype),  
          startCol=1, rowNames=FALSE)
addWorksheet(Table_S9_S13, "S10")
writeData(Table_S9_S13, 1,  as.data.frame(Clean_Results_BSA_Creattype),  
          startCol=1, rowNames=FALSE)
addWorksheet(Table_S9_S13, "S11")
writeData(Table_S9_S13, 2,  as.data.frame(Clean_Results_Sex_Creattype),  
          startCol=1, rowNames=FALSE)
addWorksheet(Table_S9_S13, "S12")
writeData(Table_S9_S13, 3,  as.data.frame(Clean_Results_PatientType_Creattype),  
          startCol=1, rowNames=FALSE)
addWorksheet(Table_S9_S13, "S13")
writeData(Table_S9_S13, 4,  as.data.frame(Clean_Results_eGFR_Creattype),  
          startCol=1, rowNames=FALSE)

saveWorkbook(Table_S9_S13, file.path(fig_export_dir, "Table_S9_S13.xlsx"), overwrite = T)


```






```{r Supplemental_TablesToFigures}
Results_list <- list(S8 = Results_CreatType,
                     S9 = Results_Age_Creattype, 
                     S10 = Results_BSA_Creattype, 
                     S11 = Results_Sex_Creattype, 
                     S12 = Results_PatientType_Creattype, 
                     S13 = Results_eGFR_Creattype)

save(Results_list, file = "Results_list.RData")
load("Results_list.RData")
library(PerformanceAnalytics)

### Table S8: Results_CreatType
df <- Results_list[["S8"]] %>% select(-"median_fitted")
melt.df <- melt(df[,c("equation", "Creatinine_type", "RMSE", "median", "IQR", "P20_dose")])
melt.df_lwr <- melt(df[,c("equation", "Creatinine_type", "RMSE_lwr", "median_lwr", "IQR_lwr", "P20_dose_lwr")]) %>% select(-c("equation", "Creatinine_type","variable"))
names(melt.df_lwr) <- "lwr"
melt.df_upr <- melt(df[,c("equation", "Creatinine_type", "RMSE_upr", "median_upr", "IQR_upr", "P20_dose_upr")]) %>% select(-c("equation", "Creatinine_type","variable"))
names(melt.df_upr) <- "upr"

df2 <- cbind(melt.df, melt.df_lwr, melt.df_upr)[,c("equation","Creatinine_type", "variable", "value", "lwr", "upr")]
names(df2)[grep("variable", names(df2))] <- "Parameter"

p.Results_CreatType <- ggplot(df2) + 
    geom_vline(xintercept = 0, linetype = "dashed") +
    ggstance::geom_linerangeh(aes(y = equation, xmin = lwr, xmax = upr, colour = Parameter), 
                              position = ggstance::position_dodgev(height = 0.5)) + 
    geom_point(aes(y = equation, x = value, colour = Parameter), 
               fill = "white", 
               size = 1, stroke = 1, shape = 21,  
               position = ggstance::position_dodgev(height = 0.5)) + 
    scale_color_manual(values = tol5qualitative) + 
    facet_wrap(~Creatinine_type, scales = "free", nrow = 1) + 
    ggplot_theme() + 
    theme(strip.background = element_blank(), 
          axis.text = element_text(size = rel(1)),
          axis.title.y = element_blank()) + 
    xlab("Estiamted parameter value") +
    ggtitle("S8: By Creattype")

ggsave(file.path(fig_export_dir, "p.S8_Results_CreatType.png"), width = 10, height = 5)




### Table S9: Results_Age_Creattype

df <- Results_list[["S9"]] %>% select(-"median_fitted")
melt.df <- melt(df[,c("equation", "Age_cut", "Creatinine_type", "RMSE", "median", "IQR", "P20_dose")])
melt.df_lwr <- melt(df[,c("equation", "Age_cut", "Creatinine_type", "RMSE_lwr", "median_lwr", "IQR_lwr", "P20_dose_lwr")]) %>% select(-c("equation", "Age_cut", "Creatinine_type","variable"))
names(melt.df_lwr) <- "lwr"
melt.df_upr <- melt(df[,c("equation", "Age_cut", "Creatinine_type", "RMSE_upr", "median_upr", "IQR_upr", "P20_dose_upr")]) %>% select(-c("equation", "Age_cut", "Creatinine_type","variable"))
names(melt.df_upr) <- "upr"

df2 <- cbind(melt.df, melt.df_lwr, melt.df_upr)[,c("equation", "Age_cut", "Creatinine_type", "variable", "value", "lwr", "upr")]
names(df2)[grep("variable", names(df2))] <- "Parameter"
df2$Creatinine_type <- factor(df2$Creatinine_type)

p.Results_Age_Creattype <- ggplot(df2) + 
    geom_vline(xintercept = 0, linetype = "dashed") +
    ggstance::geom_linerangeh(aes(y = equation, xmin = lwr, xmax = upr, colour = Parameter), 
                              position = ggstance::position_dodgev(height = 0.5)) + 
    geom_point(aes(y = equation, x = value, colour = Parameter), 
               fill = "white", 
               size = 1, stroke = 1, shape = 21,  
               position = ggstance::position_dodgev(height = 0.5)) + 
    scale_color_manual(values = tol5qualitative) + 
    facet_wrap( ~ Creatinine_type + Age_cut, scales = "free", ncol = 5, nrow = 2) + 
    ggplot_theme() + 
    theme(strip.background = element_blank(), 
          axis.text = element_text(size = rel(1)),
          axis.title.y = element_blank()) + 
    xlab("Estiamted parameter value") +
    ggtitle("S9: By Age and Creattype")

ggsave(file.path(fig_export_dir, "p.S9_Age_Creattype.png"), width = 25, height = 10)




### Table S10: Results_BSA_Creattype

df <- Results_list[["S10"]] %>% select(-"median_fitted")
melt.df <- melt(df[,c("equation", "BSA_cut", "Creatinine_type", "RMSE", "median", "IQR", "P20_dose")])
melt.df_lwr <- melt(df[,c("equation", "BSA_cut", "Creatinine_type", "RMSE_lwr", "median_lwr", "IQR_lwr", "P20_dose_lwr")]) %>% select(-c("equation", "BSA_cut", "Creatinine_type","variable"))
names(melt.df_lwr) <- "lwr"
melt.df_upr <- melt(df[,c("equation", "BSA_cut", "Creatinine_type", "RMSE_upr", "median_upr", "IQR_upr", "P20_dose_upr")]) %>% select(-c("equation", "BSA_cut", "Creatinine_type","variable"))
names(melt.df_upr) <- "upr"

df2 <- cbind(melt.df, melt.df_lwr, melt.df_upr)[,c("equation", "BSA_cut", "Creatinine_type", "variable", "value", "lwr", "upr")]
names(df2)[grep("variable", names(df2))] <- "Parameter"
df2$Creatinine_type <- factor(df2$Creatinine_type)

p.Results_BSA_Creattype <- ggplot(df2) + 
    geom_vline(xintercept = 0, linetype = "dashed") +
    ggstance::geom_linerangeh(aes(y = equation, xmin = lwr, xmax = upr, colour = Parameter), 
                              position = ggstance::position_dodgev(height = 0.5)) + 
    geom_point(aes(y = equation, x = value, colour = Parameter), 
               fill = "white", 
               size = 1, stroke = 1, shape = 21,  
               position = ggstance::position_dodgev(height = 0.5)) + 
    scale_color_manual(values = tol5qualitative) + 
    facet_wrap( ~ Creatinine_type + BSA_cut, scales = "free", ncol = 5, nrow = 2) + 
    ggplot_theme() + 
    theme(strip.background = element_blank(), 
          axis.text = element_text(size = rel(1)),
          axis.title.y = element_blank()) + 
    xlab("Estiamted parameter value") +
    ggtitle("S10: By BSA and Creattype")

ggsave(file.path(fig_export_dir, "p.S10_BSA_Creattype.png"), width = 25, height = 10)




### Table S11: Results_Sex_Creattype

df <- Results_list[["S11"]] %>% select(-"median_fitted")
melt.df <- melt(df[,c("equation", "Sex", "Creatinine_type", "RMSE", "median", "IQR", "P20_dose")])
melt.df_lwr <- melt(df[,c("equation", "Sex", "Creatinine_type", "RMSE_lwr", "median_lwr", "IQR_lwr", "P20_dose_lwr")]) %>% select(-c("equation", "Sex", "Creatinine_type","variable"))
names(melt.df_lwr) <- "lwr"
melt.df_upr <- melt(df[,c("equation", "Sex", "Creatinine_type", "RMSE_upr", "median_upr", "IQR_upr", "P20_dose_upr")]) %>% select(-c("equation", "Sex", "Creatinine_type","variable"))
names(melt.df_upr) <- "upr"

df2 <- cbind(melt.df, melt.df_lwr, melt.df_upr)[,c("equation", "Sex", "Creatinine_type", "variable", "value", "lwr", "upr")]
names(df2)[grep("variable", names(df2))] <- "Parameter"
df2$Creatinine_type <- factor(df2$Creatinine_type)
df2$Sex <- factor(df2$Sex, labels = c("Female", "Male"))

p.Results_Sex_Creattype <- ggplot(df2) + 
    geom_vline(xintercept = 0, linetype = "dashed") +
    ggstance::geom_linerangeh(aes(y = equation, xmin = lwr, xmax = upr, colour = Parameter), 
                              position = ggstance::position_dodgev(height = 0.5)) + 
    geom_point(aes(y = equation, x = value, colour = Parameter), 
               fill = "white", 
               size = 1, stroke = 1, shape = 21,  
               position = ggstance::position_dodgev(height = 0.5)) + 
    scale_color_manual(values = tol5qualitative) + 
    facet_wrap( ~ Creatinine_type + Sex, scales = "free", ncol = 2, nrow = 2) + 
    ggplot_theme() + 
    theme(strip.background = element_blank(), 
          axis.text = element_text(size = rel(1)),
          axis.title.y = element_blank()) + 
    xlab("Estiamted parameter value") +
    ggtitle("S11: By Sex and Creattype")

ggsave(file.path(fig_export_dir, "p.S11_Sex_Creattype.png"), width = 10, height = 10)



### Table S12: Results_PatientType_Creattype

df <- Results_list[["S12"]] %>% select(-"median_fitted")
melt.df <- melt(df[,c("equation", "Patient_type", "Creatinine_type", "RMSE", "median", "IQR", "P20_dose")])
melt.df_lwr <- melt(df[,c("equation", "Patient_type", "Creatinine_type", "RMSE_lwr", "median_lwr", "IQR_lwr", "P20_dose_lwr")]) %>% select(-c("equation", "Patient_type", "Creatinine_type","variable"))
names(melt.df_lwr) <- "lwr"
melt.df_upr <- melt(df[,c("equation", "Patient_type", "Creatinine_type", "RMSE_upr", "median_upr", "IQR_upr", "P20_dose_upr")]) %>% select(-c("equation", "Patient_type", "Creatinine_type","variable"))
names(melt.df_upr) <- "upr"

df2 <- cbind(melt.df, melt.df_lwr, melt.df_upr)[,c("equation", "Patient_type", "Creatinine_type", "variable", "value", "lwr", "upr")]
names(df2)[grep("variable", names(df2))] <- "Parameter"
df2$Patient_type <- factor(df2$Patient_type)

p.Results_PatientType_Creattype <- ggplot(df2) + 
    geom_vline(xintercept = 0, linetype = "dashed") +
    ggstance::geom_linerangeh(aes(y = equation, xmin = lwr, xmax = upr, colour = Parameter), 
                              position = ggstance::position_dodgev(height = 0.5)) + 
    geom_point(aes(y = equation, x = value, colour = Parameter), 
               fill = "white", 
               size = 1, stroke = 1, shape = 21,  
               position = ggstance::position_dodgev(height = 0.5)) + 
    scale_color_manual(values = tol5qualitative) + 
    facet_wrap( ~ Creatinine_type + Patient_type, scales = "free", ncol = 3, nrow = 2) + 
    ggplot_theme() + 
    theme(strip.background = element_blank(), 
          axis.text = element_text(size = rel(1)),
          axis.title.y = element_blank()) + 
    xlab("Estiamted parameter value") +
    ggtitle("S1: By Patienttype and Creattype")

ggsave(file.path(fig_export_dir, "p.S12_Patienttype_Creattype.png"), width = 15, height = 10)


### Table S13: Results_eGFR_Creattype

df <- Results_list[["S13"]] %>% select(-"median_fitted")
melt.df <- melt(df[,c("equation", "eGFR_cut", "Creatinine_type", "RMSE", "median", "IQR", "P20_dose")])
melt.df_lwr <- melt(df[,c("equation", "eGFR_cut", "Creatinine_type", "RMSE_lwr", "median_lwr", "IQR_lwr", "P20_dose_lwr")]) %>% select(-c("equation", "eGFR_cut", "Creatinine_type","variable"))
names(melt.df_lwr) <- "lwr"
melt.df_upr <- melt(df[,c("equation", "eGFR_cut", "Creatinine_type", "RMSE_upr", "median_upr", "IQR_upr", "P20_dose_upr")]) %>% select(-c("equation", "eGFR_cut", "Creatinine_type","variable"))
names(melt.df_upr) <- "upr"

df2 <- cbind(melt.df, melt.df_lwr, melt.df_upr)[,c("equation", "eGFR_cut", "Creatinine_type", "variable", "value", "lwr", "upr")]
names(df2)[grep("variable", names(df2))] <- "Parameter"
df2$Creatinine_type <- factor(df2$Creatinine_type)

p.Results_eGFR_Creattype <- ggplot(df2) + 
    geom_vline(xintercept = 0, linetype = "dashed") +
    ggstance::geom_linerangeh(aes(y = equation, xmin = lwr, xmax = upr, colour = Parameter), 
                              position = ggstance::position_dodgev(height = 0.5)) + 
    geom_point(aes(y = equation, x = value, colour = Parameter), 
               fill = "white", 
               size = 1, stroke = 1, shape = 21,  
               position = ggstance::position_dodgev(height = 0.5)) + 
    scale_color_manual(values = tol5qualitative) + 
    facet_wrap( ~ Creatinine_type + eGFR_cut, scales = "free", ncol = 3, nrow = 2) + 
    ggplot_theme() + 
    theme(strip.background = element_blank(), 
          axis.text = element_text(size = rel(1)),
          axis.title.y = element_blank()) + 
    xlab("Estiamted parameter value") +
    ggtitle("S13: By eGFR and Creattype")

ggsave(file.path(fig_export_dir, "p.S13_eGFR_Creattype.png"), width = 15, height = 10)
```




```{r dose_assesment, echo = F, eval = F, include= F}
Results_CreatType_dose <- Validation_fitted_df %>%
  group_by(equation, Creatinine_type) %>%
  Statistic_summary_with_doseP20()  
Results_CreatType_dose %>% 
  arrange(Creatinine_type, P20_dose) %>% 
  dplyr::selectCreatinine_type, median, RMSE, IQR, P20_dose, P20_dose_lwr, 
         P20_dose_upr) 

mround <- function(x,base){
  base*round(x/base)
}

equal_func <- function(x){
  sum(x == 0)/length(x)
}

df <- Validation_fitted_df %>%
  filter(Patient_type == "Cancer") %>%
  filter(Patient_type != "Non-cancer") %>%
  dplyr::selectCreatinine_type, equation, GFR, fitted) %>%
  mutate(GFR_dose = mround(5*(GFR + 25), 50), 
         fitted_dose = mround(5*(fitted + 25), 50)) %>%
  mutate(GFR_dose = ifelse(GFR_dose > 750, 750, GFR_dose),
         fitted_dose = ifelse(fitted_dose > 750, 750, fitted_dose)) %>%
  mutate(diff = GFR_dose - fitted_dose) %>% 
  group_by(equation) %>%
  filter(!(equation %in% c("Leave_out_1_model", "Spline_model_age_creat")))

df %>% 
  summarise(n = n(), 
            equal = sum(GFR_dose == fitted_dose)/n(),
            above = sum(fitted_dose > GFR_dose)/n(),
            below = sum(fitted_dose < GFR_dose)/n()) %>%
  bind_cols(
    df %>% do(my_normal_boot(.$diff, func = equal_func, name = "Equal")) %>%
      ungroup() %>% dplyr::select((ncol(.)-2):ncol(.))
  ) %>%
  arrange(-equal) %>% 
  do(my_normal_boot(.$fitted/.$GFR, func = P20_opp, name = "P20")) 
```



### Model comparison figure 

```{r Figure_model_comaprison_plot, fig.width=9, fig.height=9}
Results_plot <- Results_CreatType %>%
  mutate(equation = factor(equation, 
                           levels = c("CamGFR v2","CamGFR v1", "LM", "CKD-EPI", "FAS", "MDRD")))
  
p1 <- Results_plot %>% 
  ggplot(aes_string(x = "Creatinine_type", y = "RMSE", group = "equation")) + 
  geom_errorbar(aes_string(ymin = "RMSE_lwr", ymax = "RMSE_upr",
                           colour = "equation"), 
                position= position_dodge(width = .5), width = 0.3, size = 1) + 
  geom_point(position= position_dodge(width = .5), size = 2) + #, colour = "black", fill = "white", pch=21) + 
  ggplot_theme() + 
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        text = element_text(size = 14))  +
  theme(axis.ticks.x = element_blank(), 
        axis.text.x = element_blank(), 
        axis.line.x = element_blank()) +
  scale_color_manual(values =tol6qualitative) +
  ylab("RMSE\n(Accuracy)") + 
  theme(text = element_text(size = 14))

p2 <- Results_plot %>% 
  ggplot(aes_string(x = "Creatinine_type", y = "median", group = "equation")) + 
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_errorbar(aes_string(ymin = "median_lwr", ymax = "median_upr",
                           colour = "equation"), 
                position= position_dodge(width = .5), width = 0.3, size = 1) + 
  geom_point(position= position_dodge(width = .5), size = 2) + #, colour = "black", fill = "white", pch=21) + 
  ggplot_theme() + 
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        text = element_text(size = 14))  +
  theme(axis.ticks.x = element_blank(), 
        axis.text.x = element_blank(), 
        axis.line.x = element_blank()) +
  scale_color_manual(values =tol6qualitative) +
  ylab("Residual median\n(Bias)") + 
  theme(text = element_text(size = 14))

p3 <- Results_plot %>% 
  ggplot(aes_string(x = "Creatinine_type", y = "IQR", group = "equation")) + 
  geom_errorbar(aes_string(ymin = "IQR_lwr", ymax = "IQR_upr",
                           colour = "equation"), 
                position= position_dodge(width = .5), width = 0.3, size = 1) + 
  geom_point(position= position_dodge(width = .5), size = 2) + #, colour = "black", fill = "white", pch=21) + 
  ggplot_theme() + 
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        text = element_text(size = 14))  +
  theme(axis.ticks.x = element_blank(), 
        axis.text.x = element_blank(), 
        axis.line.x = element_blank()) + 
  scale_color_manual(values =tol6qualitative) +
  ylab("Residual IQR\n(Precision)") 

p4 <- Results_plot %>% 
  ggplot(aes_string(x = "Creatinine_type", y = "P20_dose", group = "equation")) + 
  geom_errorbar(aes_string(ymin = "P20_dose_lwr", ymax = "P20_dose_upr", 
                           colour = "equation"), 
                position= position_dodge(width = .5), width = 0.3, size = 1) + 
  geom_point(position= position_dodge(width = .5), size = 2) + #, colour = "black", fill = "white", pch=21) + 
  ggplot_theme() + 
  theme(legend.position = "none",
        axis.title.x = element_blank())  +
  scale_color_manual(values =tol6qualitative) +
  guides(colour = guide_legend(nrow = 2)) +
  ylab("P20\n(Clinical robustness)") +
  theme(legend.position = "bottom", 
        axis.title.x = element_blank(), 
        text = element_text(size = 14), 
        legend.title = element_blank(), 
        legend.text = element_text(size = rel(1.2)),
        legend.box = "vertical",
        legend.spacing.x = unit(0.5, "cm")) 


plot_creat <- 
  rbind(ggplotGrob(p2), 
        ggplotGrob(p3), 
        ggplotGrob(p1), 
        ggplotGrob(p4), 
        size = "last")

plot_creat %>% plot()

ggsave("Refit_CamGFR_comparison.pdf", plot = plot_creat, 
       path = fig_export_dir,
       width = 20, height = 20/0.7, units = "cm")

```


```{r Figure_model_comaprison_fucntion, fig.width=9, fig.height=9}

plot_func <- function(data, facets){
  data = data %>%
    mutate(equation = factor(equation, 
                           levels = c("CamGFR v2","CamGFR v1", "LM", "CKD-EPI", "FAS", "MDRD")))
  
  p1 <- data %>% 
     ggplot(aes_string(x = 1, y = "RMSE", group = "equation")) + 
  geom_errorbar(aes_string(ymin = "RMSE_lwr", ymax = "RMSE_upr",
                           colour = "equation"), 
                position= position_dodge(width = .5), width = 0.3, size = 1) + 
  geom_point(position= position_dodge(width = .5), size = 2) + #, colour = "black", fill = "white", pch=21) + 
  ggplot_theme() + 
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        text = element_text(size = 14))  +
  theme(axis.ticks.x = element_blank(), 
        strip.background = element_blank(),
        strip.text.x = element_blank(),
        axis.text.x = element_blank(), 
        axis.line.x = element_blank()) +
  scale_color_manual(values =tol6qualitative) +
  ylab("RMSE\n(Accuracy)") + 
  facet_wrap(as.formula(paste("~", facets)), nrow = 1) +
  theme(text = element_text(size = 14))
  
  p2 <- data %>% 
  ggplot(aes_string(x = 1, y = "median", group = "equation")) + 
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_errorbar(aes_string(ymin = "median_lwr", ymax = "median_upr",
                           colour = "equation"), 
                position= position_dodge(width = .5), width = 0.3, size = 1) + 
  geom_point(position= position_dodge(width = .5), size = 2) + #, colour = "black", fill = "white", pch=21) + 
  ggplot_theme() + 
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        text = element_text(size = 14))  +
  theme(axis.ticks.x = element_blank(), 
        axis.text.x = element_blank(), 
        axis.line.x = element_blank()) +
  scale_color_manual(values =tol6qualitative) +
  ylab("Residual median\n(Bias)") + 
  facet_wrap(as.formula(paste("~", facets)), nrow = 1) +
  theme(text = element_text(size = 14))
  
  p3 <- data %>% 
  ggplot(aes_string(x = 1, y = "IQR", group = "equation")) + 
  geom_errorbar(aes_string(ymin = "IQR_lwr", ymax = "IQR_upr",
                           colour = "equation"), 
                position= position_dodge(width = .5), width = 0.3, size = 1) + 
  geom_point(position= position_dodge(width = .5), size = 2) + #, colour = "black", fill = "white", pch=21) + 
  ggplot_theme() + 
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        text = element_text(size = 14))  +
  theme(axis.ticks.x = element_blank(), 
        axis.text.x = element_blank(), 
         strip.background = element_blank(),
        strip.text.x = element_blank(),
       axis.line.x = element_blank()) + 
  facet_wrap(as.formula(paste("~", facets)), nrow = 1) +
  scale_color_manual(values =tol6qualitative) +
  ylab("Residual IQR\n(Precision)") 

  p4 <- data %>% 
  ggplot(aes_string(x = 1, y = "P20_dose", group = "equation")) + 
  geom_errorbar(aes_string(ymin = "P20_dose_lwr", ymax = "P20_dose_upr", 
                           colour = "equation"), 
                position= position_dodge(width = .5), width = 0.3, size = 1) + 
  geom_point(position= position_dodge(width = .5), size = 2) + #, colour = "black", fill = "white", pch=21) + 
  ggplot_theme() + 
  theme(legend.position = "none",
        axis.title.x = element_blank())  +
  scale_color_manual(values =tol6qualitative) +
  guides(colour = guide_legend(nrow = 2)) +
  ylab("P20\n(Clinical robustness)") +
  facet_wrap(as.formula(paste("~", facets)), nrow = 1) +
  theme(legend.position = "bottom", 
        strip.background = element_blank(),
        strip.text.x = element_blank(),
        axis.title.x = element_blank(), 
        axis.text.x =  element_blank(), 
        text = element_text(size = 14), 
        legend.title = element_blank(), 
        legend.text = element_text(size = rel(1.2)),
        legend.box = "vertical",
        legend.spacing.x = unit(0.5, "cm")) 
  
  plot_creat <- 
  rbind(ggplotGrob(p2), 
        ggplotGrob(p3), 
        ggplotGrob(p1), 
        ggplotGrob(p4), 
        size = "last")
}


plot_S9 <- plot_func(Results_Age_Creattype, "Creatinine_type + Age_cut")
plot_S10 <- plot_func(Results_BSA_Creattype, "Creatinine_type + BSA_cut")
plot_S11 <- plot_func(Results_Sex_Creattype, "Creatinine_type + Sex")
plot_S12 <- plot_func(Results_PatientType_Creattype, "Creatinine_type + Patient_type")
plot_S13 <- plot_func(Results_eGFR_Creattype, "Creatinine_type + eGFR_cut")


ggsave("plot_S9.pdf", plot = plot_S9, 
       path = fig_export_dir,
       width = 4 + 10*4, height = 20/0.7, units = "cm")
ggsave("plot_S10.pdf", plot = plot_S10, 
       path = fig_export_dir,
       width = 4 + 10*4, height = 20/0.7, units = "cm")
ggsave("plot_S11.pdf", plot = plot_S11, 
       path = fig_export_dir,
       width = 4 + 4*4, height = 20/0.7, units = "cm")
ggsave("plot_S12.pdf", plot = plot_S12, 
       path = fig_export_dir,
       width = 4 + 6*4, height = 20/0.7, units = "cm")
ggsave("plot_S13.pdf", plot = plot_S13, 
       path = fig_export_dir,
       width = 4 + 6*4, height = 20/0.7, units = "cm")

plot(plot_S13)

```






Table S... shows the results for the six candidate models along with the the
MDRD and CKD-EPI models for IDMS and non-IDMS data separately. Additionally the
results are graphically displayed in Figure S... . We observe that the spline
model with age and creatinine piecewise linear terms is the most accurate for
the non-IDMS patients and that the leave-out-n model is the most accurate for
the IDMS patients. However, the difference between all candidate models is
small. In fact, when we calculated p-values for the differences in the
statistics between the six candidate models no difference was found to be
significant for any of the four statistics (RMSE, median residual, residual IQR
and P20). Whereas when comparing the six candidate model with CKD-EPI (the
better of the two published models), all were found to be more accurate, less
bias and more precise. Given these results, we conclude that although the
changes made to the CamGFR do improve the model, the improvement is not great
enough to warrant changing the CamGFR model. Hence, it is recommended that for
IDMS patients we use the refitted CamGFR model so as to have some consistency
with the original CamGFR model.
A supprising results form Table S... was that the CKD-EPI and the MDRD models
were substantially less accurate and much more biased for the IDMS patients then
they are for the non-IDMS patients. The decrease in accuracy is driven by the
increased bias on the model as the precision does not change. Comparatively,
using the CamGFR model as similar level of accuracy is achieved for both IDMS
and Non-IDMS patients.



```{r PLOT_performance_IDMS_all_models, eval = F, include = F, fig.width=9, fig.height=5, fig.cap="Residual vs fitted value for the refitted CamGFR CKD-EPI and MDRD models."}
Validation_fitted_df %>%
  ggplot(aes(y = resid, x = fitted)) + 
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_point(aes(colour = Creatinine_type), size = .8) + 
  facet_wrap(~equation) + 
  ggplot_theme() + 
  ylab("Residual") + xlab("Fitted value") +
  scale_colour_manual(values = tol2qualitative) 
```


### Model comparison p-values


```{r p_values_new, echo = F, eval = F, cache=T}


p_values <- Validation_fitted_df_all %>% 
  Squared_error_permutation_test_all_equations()

p_values_CreatType <- Validation_fitted_df_all %>%
  split(., .$Creatinine_type) %>%
  lapply(. , Squared_error_permutation_test_all_equations)
names = names(p_values_CreatType)
p_values_CreatType = 
  lapply(1:length(p_values_CreatType), 
         function(i) mutate(p_values_CreatType[[i]],
                            Creatinine_type = names[i])) %>%
  do.call(what = rbind, args = .)
p_values_CreatType %>% 
  filter(equation1 == "CamGFR v2")


p_values_Centre <- Validation_fitted_df_all %>%
  split(., .$Centre) %>%
  lapply(. , Squared_error_permutation_test_all_equations)
names = names(p_values_Centre)
p_values_Centre = 
  lapply(1:length(p_values_Centre), 
         function(i) mutate(p_values_Centre[[i]],
                            Creatinine_type = names[i])) %>%
  do.call(what = rbind, args = .)
p_values_Centre %>% 
  filter(equation1 == "CamGFR v2")


p_values_IDMS_PatientType <- Validation_fitted_df_all %>%
  mutate(Patient_type = ifelse(Patient_type == "Unknown", "Non-Cancer",
                               Patient_type)) %>%
  filter(Creatinine_type == "IDMS") %>%
  split(., .$Patient_type) %>%
  lapply(. , Squared_error_permutation_test_all_equations)
names = names(p_values_IDMS_PatientType)
p_values_IDMS_PatientType = 
  lapply(1:length(p_values_IDMS_PatientType), 
         function(i) mutate(p_values_IDMS_PatientType[[i]],
                            PatientType = names[i])) %>%
  do.call(what = rbind, args = .)


Table_p_values = createWorkbook()

addWorksheet(Table_p_values, "P-values for all data")
writeData(Table_p_values, 1, 
          as.data.frame(p_values),  startCol=1,
          rowNames=FALSE)

addWorksheet(Table_p_values, "P-values by creatinine type")
writeData(Table_p_values, 2, 
          as.data.frame(p_values_CreatType),  startCol=1,
          rowNames=FALSE)

addWorksheet(Table_p_values, "P-values by centre")
writeData(Table_p_values, 3, 
          as.data.frame(p_values_CreatType),  startCol=1,
          rowNames=FALSE)

saveWorkbook(Table_p_values, file.path(fig_export_dir, "P_values_new.xlsx"), overwrite = T)



```


## Final model



```{r Final_model, eval = F, echo = F }
CamGFR_final <- lm(model_formula_interaction, data = Expansion_data)
Refit_CamGFR <- lm(model_formula_interaction,
                   data = Expansion_data_fit)
saveRDS(CamGFR_final, file = "CamGFR_reffitted_all.rds")
saveRDS(Refit_CamGFR, file = "CamGFR_reffitted.rds")

```






## Model assesment

### Repeat measurements for patients
```{r}
# difference in sqrt(GFR) between samples of same patient
md_repeat_samples <- Expansion_data %>%
  group_by(PatientID, Creatinine_type) %>%
  mutate(repeat_samples = n()) %>%
  filter(repeat_samples > 1) %>%
  do(data.frame(t(combn(.$sqrt_GFR, 2)))) %>%
  mutate(pdiff=abs(X2-X1)) %>%
  summarise(mean_difference = mean(pdiff),
            median_difference = median(pdiff),
            type = "Repeat samples",
            .groups="drop")

# Find and format cut points across all patients
cutpoints <- Expansion_data %>%
  mutate(Age_cut = cut_number(Age, 5, dig.lab=4)) %>% 
  mutate(BSA_cut = cut_number(BSA, 5, dig.lab=6)) %>%
  dplyr::selectAge_cut, BSA_cut) %>%
  summarise(age_lower = as.numeric(gsub("[\\[\\(](.*),.*", "\\1", levels(Age_cut))),
            bsa_lower = as.numeric(gsub("[\\[\\(](.*),.*", "\\1", levels(BSA_cut))),
            age_higher = as.numeric(gsub(".*,(.*)\\]", "\\1", levels(Age_cut))),
            bsa_higher = as.numeric(gsub(".*,(.*)\\]", "\\1", levels(BSA_cut)))
  ) %>%
  pivot_longer(everything(),names_to = "type", values_to ="cuts") %>%
  separate(type, into = c("covariate", "interval")) %>%
  group_by(covariate) %>%
  summarise(cuts = unique(cuts)) %>%
  mutate(dummy = 1:n()) %>%
  pivot_wider(names_from=covariate, values_from=cuts) %>%
  select(-dummy)

# Stratify patients without repeat measures
stratified_samples <- Expansion_data %>%
  group_by(PatientID) %>%
  mutate(repeat_samples = n()) %>%
  filter(repeat_samples == 1) %>%
  ungroup() %>%
  mutate(Age_cut = cut(Age, cutpoints$age, include.lowest =TRUE)) %>% 
  mutate(BSA_cut = cut(BSA, cutpoints$bsa, include.lowest =TRUE)) %>% 
  group_by(Age_cut, BSA_cut, Sex, Patient_type, Creatinine_type) %>%
  unite("group_id", Age_cut, BSA_cut, Sex, Patient_type, Creatinine_type,
        remove=FALSE)

# difference in sqrt(GFR) between samples in same stratification group
# (no repeat measures)
md_stratified_samples <- stratified_samples %>%
  mutate(group_samples = n()) %>%
  filter(group_samples > 1) %>%
  do(data.frame(t(combn(.$sqrt_GFR, 2)))) %>%
  mutate(pdiff=abs(X2-X1)) %>%
  summarise(mean_difference = mean(pdiff),
            median_difference = median(pdiff),
            group_size = n(),
            type = "Stratified samples",
            .groups="drop")

# Stratify repeat samples by same intervals/type/measures
repeat_samples_stratified <- Expansion_data %>%
  group_by(PatientID, Creatinine_type) %>%
  mutate(repeat_samples = n()) %>%
  filter(repeat_samples > 1) %>%
  mutate(Age_cut = cut(Age, cutpoints$age, include.lowest =TRUE)) %>% 
  mutate(BSA_cut = cut(BSA, cutpoints$bsa, include.lowest =TRUE)) %>%
  group_by(Age_cut, BSA_cut, Sex, Patient_type, Creatinine_type) %>%
  unite("group_id", Age_cut, BSA_cut, Sex, Patient_type, Creatinine_type,
        remove=FALSE)

# Calculate distances between patients with repeat measures and other samples in
# same stratify group
## match groups
repeat_samples_stratified_list <- repeat_samples_stratified %>%
  group_split()
names(repeat_samples_stratified_list) <-
  unique(repeat_samples_stratified$group_id)
  
stratified_samples_list <- stratified_samples  %>%
  group_split()
names(stratified_samples_list) <- unique(stratified_samples$group_id)

## make sure groups match up
repeat_samples_stratified_list <- repeat_samples_stratified_list[
  names(repeat_samples_stratified_list) %in% names(stratified_samples_list)]
stratified_samples_list <- stratified_samples_list[
  names(stratified_samples_list) %in% names(repeat_samples_stratified_list)]
stratified_samples_list <- stratified_samples_list[
  match(names(repeat_samples_stratified_list),names(stratified_samples_list))]

testthat::expect_equal(names(repeat_samples_stratified_list),
                       names(stratified_samples_list))

md_repeat_to_stratified <- lapply(seq_along(stratified_samples_list), function(group_index) {
  rs <- repeat_samples_stratified_list[[group_index]]
  ss <- stratified_samples_list[[group_index]]
  mean_per_rs <- sapply(rs$sqrt_GFR, function(x) mean(abs(x - ss$sqrt_GFR)))
  median_per_rs <- sapply(rs$sqrt_GFR, function(x) median(abs(x - ss$sqrt_GFR)))
  tibble(PatientID = rs$PatientID,
         Creatinine_type = rs$Creatinine_type,
         mean_difference = mean_per_rs,
         median_difference = median_per_rs,
         type = "Repeat to stratified")
}) %>%
  bind_rows

md <- bind_rows(md_repeat_samples, md_stratified_samples, md_repeat_to_stratified)

p_mean_diff <- ggplot(data=md) +
  geom_density(aes(x=mean_difference, color=type), show.legend = FALSE) +
  scale_color_brewer(type="qual") +
  labs(x="Mean difference sqrt(GFR)",
       y="Density",
       color="Comparsion") +
  ggplot_theme()
p_median_diff <- ggplot(data=md) +
  geom_density(aes(x=median_difference, color=type)) +
  scale_color_brewer(type="qual") +
  labs(x="Median difference sqrt(GFR)",
       y="Density",
       color="Comparsion") +
  ggplot_theme() +
  theme(legend.position = "right",
        legend.direction = "vertical")
legend_stratified <- get_legend(p_median_diff)
plots_stratified <- plot_grid(p_mean_diff,
                             p_median_diff + theme(legend.position = "none"),
                             nrow=2)
plot_grid(plots_stratified, legend_stratified, rel_widths = c(5,2))
```


```{r BMI_assesment, echo  = F, eval = F}

Expansion_data_fitted <- Expansion_data %>%
  group_by(Diagnosis) %>% mutate(n = n()) %>% ungroup() %>%
  mutate(Diagnosis = ifelse(n < 50, "Other", Diagnosis)) %>%
  ungroup() %>%
  bind_cols(GFR_fitted_values_eth(.)) %>%
  mutate(Refit_CamGFR = predict(Refit_CamGFR, newdata = .)^2) %>%
  mutate(Leave_out_1_model = predict(Leave_out_one_model, newdata = .)^2) %>%
  # mutate(Leave_out_n_model = predict(Leave_out_n_model, newdata = .)^2) %>%
  # mutate(BIC_model = predict(BIC_model, newdata = .)^2) %>%
  # mutate(Spline_model_age = predict(Spline_model_age, newdata = .)^2) %>%
  # mutate(Spline_model_creat = predict(Spline_model_creat, newdata = .)^2) %>%
  mutate(Spline_model_age_creat =
           predict(Spline_model_age_creat, newdata = .)^2) %>%
  mutate(MDRD = ifelse(Creatinine_type == "IDMS", MDRD_adj_IDMS, MDRD_adj)) 


a = Validation_fitted_df %>%
  mutate(BMI = Wt/((Ht/100)^2)) %>%
  mutate(BMI_group = cut(BMI, c(0, 18.5, 25, 30, 100))) %>%  
  group_by(equation, BMI_group, Creatinine_type) %>% 
  mutate(resid = sqrt(GFR) - sqrt(fitted)) %>%
  Statistic_summary_with_doseP20() 
a %>%
  arrange(Creatinine_type, equation, BMI_group) %>%
  print(n = 100)

a %>% filter(equation == "CamGFR v2") %>%
  arrange(Creatinine_type, equation, BMI_group) 


p1 <- Expansion_data %>%
  filter(fit_index == F) %>%
  mutate(BMI = Wt/((Ht/100)^2)) %>%
  mutate(Refit_CamGFR = predict(Refit_CamGFR, newdata = .)^2) %>%
  ggplot(aes(x = BMI, y = sqrt(GFR) - sqrt(Refit_CamGFR))) +
  # ggplot(aes(x = BMI, y = (GFR) - (Refit_CamGFR))) + 
  geom_hline(yintercept = 0) + 
  geom_point() +
  ylim(-4.5, 4.5) +
  # ylim(-80, 80)
  geom_smooth() 

p2 <- Expansion_data %>%
  filter(fit_index == F) %>%
  mutate(BMI = Wt/((Ht/100)^2)) %>%
  mutate(Refit_CamGFR = predict(Refit_CamGFR, newdata = .)^2) %>%
  ggplot(aes(x = BMI, y = abs(sqrt(GFR) - sqrt(Refit_CamGFR)))) +
  # ggplot(aes(x = BMI, y = (GFR) - (Refit_CamGFR))) + 
  geom_point() +
  geom_smooth() 

plot_grid(p1, p2, ncol =1)
```




```{r SCR_GFR_date_diff, echo = F, eval = F}
GFR_creatinine_date_diff_plot <- 
  Expansion_data %>% 
  dplyr::selectDate_GFR, Date_creat, Centre) %>%
  mutate(Date_diff = as.numeric(Date_creat - Date_GFR)) %>%
  filter(!is.na(Date_diff)) %>%
  dplyr::selectDate_diff, Centre) %>%
  ggplot(aes(x=Date_diff,  fill = Centre)) +
  geom_bar() + 
  ggplot_theme() + 
  scale_fill_manual(values = tol2qualitative) + 
  xlab("SCr and GFR time difference [days]") + 
  scale_x_continuous(breaks = c(-30,-20,-10,0,10,20,30))

Results_nonIDMS_data_date_diff <- Expansion_data %>% 
  mutate(equation = "Refitted CamGFR") %>%
  mutate(Date_diff = -as.numeric(Date_GFR - Date_creat)) %>%
  mutate(Date_diff_group = cut(Date_diff,
                               breaks = c(-31, -8, -3, -1, 0, 2, 7, 30))) %>%
  mutate(Date_diff_group = as.character(Date_diff_group)) %>%
  mutate(Date_diff_group = ifelse(is.na(Date_diff_group), "NA",
                                  Date_diff_group)) %>%
  bind_cols(GFR_fitted_values_eth(.)) %>%
  mutate(fitted = predict(Refit_CamGFR, newdata = .)^2) %>%
  mutate(resid = GFR - fitted) %>%
  # filter(Centre =="Cambridge") %>%
  group_by(equation, Date_diff_group) %>%
  Statistic_summary_with_doseP20() %>%
  arrange(Date_diff_group, equation) %>%
  # select(-P20, -P20_lwr, -P20_upr)
  select(-P20_dose, -P20_dose_lwr, -P20_dose_upr) 


plot_data <- Results_nonIDMS_data_date_diff %>%
  ungroup() %>%
  mutate(Date_diff_group = factor(Date_diff_group, 
                                  levels = c("(-31,-8]", "(-8,-3]", "(-3,-1]",
                                             "(-1,0]", "(0,2]", 
                                             "(2,7]", "(7,30]", "NA"), 
                                  labels = c("-30:-8", "-7:-3", "-2:-1", "0",
                                             "1:2", "3:7", "8:30", "NA"))) %>%
  # filter(Date_diff_group != "NA") %>%
  filter(equation == "Refitted CamGFR")


p1 <- plot_data %>%
  ggplot(aes_string(group = "Date_diff_group", x = "Date_diff_group",
                    y = "RMSE")) + 
  geom_errorbar(aes_string(ymin = "RMSE_lwr", ymax = "RMSE_upr",
                           colour = "Date_diff_group"), 
                position= position_dodge(width = .5), width = 0.3, size = 1) + 
  geom_point(position= position_dodge(width = .5)) + 
  ggplot_theme() + 
  scale_color_manual(values = c(inlmisc::GetColors( 7, scheme = "sunset"),
                                "grey30")) +
  ylab("RMSE\n(Accuracy)") +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        text = element_text(size = 12)) +
  xlab("SCr and GFR time difference [days]")



p2 <- plot_data %>%
  ggplot(aes_string(group = "Date_diff_group", x = "Date_diff_group",
                    y = "median")) + 
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_errorbar(aes_string(ymin = "median_lwr", ymax = "median_upr",
                           colour = "Date_diff_group"), 
                position= position_dodge(width = .5), width = 0.3, size = 1) + 
  geom_point(position= position_dodge(width = .5)) + 
  ggplot_theme() + 
  scale_color_manual(values = c(inlmisc::GetColors( 7, scheme = "sunset"),
                                "grey30")) +
  ylab("Residual median\n(Bias)") + 
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        text = element_text(size = 12)) +
  xlab("SCr and GFR time difference [days]")


plot_date_diff <- ggdraw() +
  draw_plot(GFR_creatinine_date_diff_plot, 0.15, 0.5, 0.8, 0.5) +
  draw_plot(p1, 0, 0, 0.5, 0.5) +
  draw_plot(p2, 0.5, 0, 0.5, 0.5) +
  draw_plot_label(c("A", "B", "C"), c(0.15, 0, 0.5)+ 0.025,
                  c(1, 0.5, 0.5) - 0.025, size = 17)
plot_date_diff

# ggsave("Date_difference_plot.pdf", plot = plot_date_diff, 
#        path = fig_export_dir ,
#        width = 20*1.3, height = 18*1.3, units = "cm")

ggsave("Date_difference_histogram.pdf", plot = GFR_creatinine_date_diff_plot, 
       path = fig_export_dir ,
       width = 20*1.3/1.5, height = 18*1.3/2, units = "cm")



```


```{r model_assesment_plot, echo = F, eval = F, fig.cap="\\label{fig:Creat_GFR_date_diff}Comparison of CamGFR accuracy and bias as the time between serum creatinine (SCr) and GFR measurements increases."}

.smooth <- function(x, y) {
  stats::lowess(x, y, f = 0.5, iter = 3)
}

plot_data <- fortify(Refit_CamGFR)
plot_data$.index <- 1:dim(plot_data)[1]
plot_data$.label <- rownames(plot_data)

r <- CamGFR_final$residuals
n <- length(r)
pp = length(CamGFR_final$coefficients)
mse <- sum(r^2)/(n-pp)

cook_dist_function <- function(x, ckd=.5){
  y = sqrt(ckd*mse*pp*(1-x)^2/x)
  y
}
cook_dist_function_neg <- function(x, ckd=.5){
  y = sqrt(ckd*mse*pp*(1-x)^2/x)
  -y
}

mh <- max(plot_data$.hat)
mh = mh


smoother <- .smooth(plot_data$.hat, plot_data$.stdresid)
p1 <- ggplot(plot_data, aes(x = .hat, y = .stdresid)) + 
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_point(size = rel(1), alpha = 0.7, stroke=0 ) +
  #   geom_path(x = smoother$x, y = smoother$y, colour = "#0000FF") + 
  xlab("Leverage") +ylab("Standardised residuals") + 
  stat_function(fun=cook_dist_function, aes(linetype="Cook's Distance"),
                colour =tol2qualitative[2]) + 
  stat_function(fun=cook_dist_function_neg, aes(linetype="Cook's Distance"),
                colour =tol2qualitative[2]) + 
  ylim(c(-max(abs(plot_data$.stdresid)), max(abs(plot_data$.stdresid)))) + 
  ggplot_theme() +  scale_linetype_manual(values = c("dashed"), name=NULL,
                                          labels = c("Cook's Distance 0.5"),
                                          guide="legend") + 
  theme(legend.justification = c(1, 0), legend.position = c(1, 0.01),
        legend.key = element_blank())
p1

p2 <- ggplot(plot_data, aes(x=.index, y=.cooksd, ymin=0, ymax=.cooksd)) + 
  geom_linerange() + 
  xlab("Sample number") + ylab("Cook's distance") + 
  ggplot_theme()
p2



smoother <- .smooth(plot_data$.fitted, sqrt(abs(plot_data$.stdresid)))
p3 <- ggplot(plot_data, aes(x=.fitted, y=sqrt(abs(.stdresid)))) + 
  geom_point(size = rel(1), alpha =0.7, stroke=0) + 
  # geom_line(stat="smooth", method = "loess", size=rel(2),  colour = "white") + 
  # geom_line(stat="smooth", method = "loess", size=rel(1),  colour = tol2qualitative[1]) + 
  geom_path(x = smoother$x, y = smoother$y, size=rel(2),  colour = "white") + 
  geom_path(x = smoother$x, y = smoother$y, size=rel(1),
            colour = tol2qualitative[1]) + 
  xlab("Fitted values") + ylab(expression(sqrt(abs(`Standardised residuals`)))) + 
  ggplot_theme()
p3

smoother <- .smooth(plot_data$.fitted, plot_data$.stdresid)
p4 <- ggplot(plot_data, aes(x=.fitted, y=.stdresid)) + 
  geom_hline(yintercept = 0., linetype = "dashed") +
  geom_point(size = rel(1), alpha =0.7, stroke=0) + 
  # geom_line(stat="smooth", method = "loess", size=rel(2),  colour = "white", span = 1) + 
  # geom_line(stat="smooth", method = "loess", size=rel(1),  colour = tol2qualitative[1], span =1) + 
  geom_path(x = smoother$x, y = smoother$y, size=rel(2),  colour = "white") + 
  geom_path(x = smoother$x, y = smoother$y, size=rel(1),
            colour = tol2qualitative[1]) + 
  xlab("Fitted values") + ylab("Standardised residuals") + 
  ggplot_theme()
p4


p <- plot_grid(p4,p3,p1,p2, labels = "AUTO", axis = "btlr", align = "hv",
               label_size = 15)
p
# ggsave(p, path = file.path(latex_location, "Chapter4/Figs"),
#        filename ="CamGFR_diagnosis_plot.pdf",
#        width = 25, height = 25/1.5, units = "cm")



```


## CamGFR v2 on JNCI data

```{r compare_models_using_JNCI_paper_data, eval = T, echo = F}

JNCI_fitted_values <- New_nonIDMS_data_JNCI %>%
  mutate(log_Creat_IDMS = log(Creat)*(Creatinine_type == "IDMS"), 
         log_Creat_nonIDMS = log(Creat)*(Creatinine_type == "Non_IDMS")) %>%
  filter(!(Centre %in% c("Cambridge", "Manchester"))) %>%
  mutate(log_Creat = log(Creat)) %>%
  mutate(Creatinine_type = "Non_IDMS") %>%
  group_by(Diagnosis) %>% mutate(n = n()) %>% ungroup() %>%
  mutate(Diagnosis = ifelse(n < 50, "Other", Diagnosis)) %>%
  mutate(Date_diff = as.numeric(Date_GFR - Date_creat)) %>%
  mutate(Date_diff_group = cut(Date_diff,
                               breaks = c(-31, -8, -3, -1, 0, 2, 7, 30))) %>%
  mutate(Date_diff_group = as.character(Date_diff_group)) %>%
  mutate(Date_diff_group = ifelse(is.na(Date_diff_group), "NA",
                                  Date_diff_group)) %>%
  bind_cols(GFR_fitted_values_eth(.)) %>%
  mutate(Refit_CamGFR = predict(Refit_CamGFR, newdata = .)^2) %>%
  mutate(CamGFR_v1 = predict(Addenbrooks_sqrt_model, newdata = .)^2) %>%
  mutate(Leave_out_1_model = predict(Leave_out_one_model, newdata = .)^2) %>%
  mutate(Spline_model_age_creat = predict(Spline_model_age_creat, newdata = .)^2) %>%
  mutate(MDRD = ifelse(Creatinine_type == "IDMS", MDRD_adj_IDMS, MDRD_adj)) %>% 
  rename(`CKD-EPI` = CKD_adj, LM = LM_adj, FAS = FAS_adj) %>%
  gather(key = equation, value = fitted, WJ:MDRD) %>%
  mutate(resid = GFR - fitted) %>%
  filter(equation %in% c("Refit_CamGFR", "CKD-EPI", "MDRD", "LM", "FAS",
                         "CamGFR_v1", "Leave_out_1_model", "Spline_model_age_creat")) %>%
  mutate(equation = factor(equation, levels = c("Refit_CamGFR", "CamGFR_v1", 
                                                "LM","CKD-EPI", "FAS", "MDRD", 
                                                "Leave_out_1_model", "Spline_model_age_creat"),
                           labels = c("CamGFR v2", "CamGFR v1", "LM", "CKD-EPI", 
                                      "FAS", "MDRD", 
                                      "Leave-out-1", "Spline"))) 


JNCI_fitted_values %>%
  group_by(equation) %>%
  Statistic_summary_with_doseP20() %>%
  # select(-P20_dose, -P20_dose_lwr, -P20_dose_upr) %>%
  arrange(RMSE) %>%
  Clean_results() %>%
  select(-P20) %>%
  rename("Dose P20" = P20_dose) %>% 
  write_csv(file = file.path(fig_export_dir, "Results_JNCI_data_all.csv"))

JNCI_fitted_values %>%
  group_by(equation, Centre) %>%
  Statistic_summary_with_doseP20() %>%
  # select(-P20_dose, -P20_dose_lwr, -P20_dose_upr) %>%
  arrange(Centre, RMSE) %>%
  Clean_results() %>%
  select(-P20) %>%
  rename("Dose P20" = P20_dose) %>% 
  write_csv(file = file.path(fig_export_dir, "Results_JNCI_data_by_centre.csv"))


```

## Leave-out-one-centre cross-valiation

### Create two centre model

```{r fit_two_centre_models, eval = F, echo = F}

model_formula_interaction <-
  sqrt_GFR ~ Age + BSA + Sex + Creatinine_type:log_Creat +
  Creatinine_type:I(log_Creat^2) + Creatinine_type:I(log_Creat^3) +
  Age:BSA + Age:Sex + Creatinine_type 

Refit_CamGFR_Goth <- Expansion_data %>%
  filter(Centre != "Gothenburg") %>% 
  lm(model_formula_interaction, data = .)
Refit_CamGFR_Man<- Expansion_data %>%
  filter(Centre != "Manchester") %>% 
  lm(model_formula_interaction, data = .)
Refit_CamGFR_Cam <- Expansion_data %>%
  filter(Centre != "Cambridge") %>% 
  lm(model_formula_interaction, data = .)

mutate(tidy(Refit_CamGFR_Goth), Missing_centre = "Gothenburg") %>%
  bind_rows(mutate(tidy(Refit_CamGFR_Man), Missing_centre = "Manchester")) %>%
  bind_rows(mutate(tidy(Refit_CamGFR_Cam), Missing_centre = "Cambridge")) %>%
  dplyr::selectterm, estimate, std.error, Missing_centre) %>% 
  pivot_longer(estimate:std.error) %>%
  pivot_wider(names_from = Missing_centre, values_from = value) %>%
  arrange(name)

```

### Validate on remaining centre

```{r validate_two_centre_models, eval = F, echo = F}

Validation_fitted_df_Goth <-  Expansion_data %>%
  filter(Centre == "Gothenburg") %>%
  bind_cols(GFR_fitted_values_eth(.)) %>%
  mutate(Refit_CamGFR_Goth = predict(Refit_CamGFR_Goth, newdata = .)^2) %>%
  mutate(CamGFR_v1 = predict(Addenbrooks_sqrt_model, newdata = .)^2) %>%
  mutate(MDRD = ifelse(Creatinine_type == "IDMS", MDRD_adj_IDMS, MDRD_adj)) %>% 
  rename(`CKD-EPI` = CKD_adj, LM = LM_adj, FAS = FAS_adj) %>%
  gather(key = equation, value = fitted,
         Refit_CamGFR_Goth, `CKD-EPI`, MDRD, LM, FAS) %>%
  mutate(resid = GFR - fitted)

Results_CreatType_Goth <- Validation_fitted_df_Goth %>%
  group_by(equation, Creatinine_type) %>%
  Statistic_summary_with_doseP20() %>%
  arrange(Creatinine_type, RMSE)

Validation_fitted_df_Man <-  Expansion_data %>%
  filter(Centre == "Manchester") %>%
  bind_cols(GFR_fitted_values_eth(.)) %>%
  mutate(Refit_CamGFR_Man = predict(Refit_CamGFR_Man, newdata = .)^2) %>%
  mutate(CamGFR_v1 = predict(Addenbrooks_sqrt_model, newdata = .)^2) %>%
  mutate(MDRD = ifelse(Creatinine_type == "IDMS", MDRD_adj_IDMS, MDRD_adj)) %>% 
  rename(`CKD-EPI` = CKD_adj, LM = LM_adj, FAS = FAS_adj) %>%
  gather(key = equation, value = fitted,
         Refit_CamGFR_Man, `CKD-EPI`, MDRD, LM, FAS) %>%
  mutate(resid = GFR - fitted)

Results_CreatType_Man <- Validation_fitted_df_Man %>%
  group_by(equation, Creatinine_type) %>%
  Statistic_summary_with_doseP20() %>%
  arrange(Creatinine_type, RMSE)

Validation_fitted_df_Cam <-  Expansion_data %>%
  filter(Centre == "Cambridge") %>%
  bind_cols(GFR_fitted_values_eth(.)) %>%
  mutate(Refit_CamGFR_Cam = predict(Refit_CamGFR_Cam, newdata = .)^2) %>%
  mutate(CamGFR_v1 = predict(Addenbrooks_sqrt_model, newdata = .)^2) %>%
  mutate(MDRD = ifelse(Creatinine_type == "IDMS", MDRD_adj_IDMS, MDRD_adj)) %>% 
  rename(`CKD-EPI` = CKD_adj, LM = LM_adj, FAS = FAS_adj) %>%
  gather(key = equation, value = fitted,
         Refit_CamGFR_Cam, `CKD-EPI`, MDRD, LM, FAS) %>%
  mutate(resid = GFR - fitted)

Results_CreatType_Cam <- Validation_fitted_df_Cam %>%
  group_by(equation, Creatinine_type) %>%
  Statistic_summary_with_doseP20() %>%
  arrange(Creatinine_type, RMSE)


Two_centre_models_results  <- 
  mutate(Results_CreatType_Cam, "Validation Centre" = "Cambridge")  %>% 
  bind_rows(mutate(Results_CreatType_Man, "Validation Centre" = "Manchester")) %>%
  bind_rows(mutate(Results_CreatType_Goth, "Validation Centre" = "Gothenburg")) %>%
  select(`Validation Centre`, everything()) %>%
  Clean_output_table() %>% 
  mutate(equation = recode(equation, 
                           "Refit_CamGFR_Cam" = "CamGFR v2 Man/Goth", 
                           "Refit_CamGFR_Goth" = "CamGFR v2 Cam/Man", 
                           "Refit_CamGFR_Man" = "CamGFR v2 Cam/Goth", 
                           "CamGFR_v1" = "CamGFR v1")) 
  
Two_centre_models_results  %>%
  write_csv(file = file.path(fig_export_dir, "Two_centre_validation_results.csv"))


```


```{r save_enviroment, include=F, eval = F}
save.image(file='2_CamGFR_expansion.RData')
```
